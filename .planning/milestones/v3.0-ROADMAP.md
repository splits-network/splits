# Milestone v3.0: Platform Admin Restructure

**Status:** SHIPPED 2026-02-13
**Phases:** 4-7
**Total Plans:** 6

## Overview

This milestone restructures platform admin from an organization-scoped role (stored in memberships table with synthetic platform org) to a system-level role (stored in user_roles table with nullable entity fields). The journey: migrate database schema to support nullable columns, atomically migrate existing platform_admin data with validation gates, update shared-access-context and identity-service to read/write from the correct table, and finally clean up the synthetic platform organization. Zero downtime, backward compatible, 119+ downstream consumers unchanged.

## Phases

### Phase 4: Schema & Data Migration
**Goal**: Platform admin data migrated from memberships to user_roles with zero downtime and full validation
**Depends on**: Nothing (starts v3.0 milestone)
**Requirements**: SCHEMA-01, SCHEMA-02, SCHEMA-03
**Success Criteria** (what must be TRUE):
  1. role_entity_id is nullable in user_roles table (role_entity_type was already dropped)
  2. Partial unique index prevents duplicate platform_admin rows per user
  3. All existing platform admins have matching rows in user_roles (count validation passed)
  4. Revoking platform_admin via deleted_at immediately blocks access in queries
  5. Migration is reversible with documented rollback SQL
**Plans**: 1 plan

Plans:
- [x] 04-01-PLAN.md — Schema change (nullable role_entity_id), index restructuring, platform_admin data migration with atomic validation

### Phase 5: Access Integration
**Goal**: All backend services and frontend checks use user_roles for platform_admin authorization
**Depends on**: Phase 4
**Requirements**: ACCESS-01, ACCESS-02, ACCESS-03, AUDIT-01
**Success Criteria** (what must be TRUE):
  1. resolveAccessContext() queries user_roles for platform_admin and returns isPlatformAdmin: true
  2. identity-service POST/DELETE /v2/user-roles accepts platform_admin with nullable entity fields
  3. Platform admin grant/revoke publishes user_role.created/deleted events to RabbitMQ
  4. All 13 frontend files checking isPlatformAdmin continue working without code changes
  5. 119+ downstream consumers of resolveAccessContext receive correct authorization context
**Plans**: 2 plans

Plans:
- [x] 05-01-PLAN.md — Update resolveAccessContext to handle platform_admin from user_roles with nullable role_entity_id
- [x] 05-02-PLAN.md — Update identity-service user-roles API to accept platform_admin with null entity fields, enrich audit events

### Phase 6: Cleanup & Validation
**Goal**: Synthetic platform organization removed, system health validated
**Depends on**: Phase 5
**Requirements**: AUDIT-02
**Success Criteria** (what must be TRUE):
  1. Platform organization (type='platform') deleted from organizations table
  2. All memberships referencing platform organization deleted
  3. Platform admin user can access admin routes in frontend (smoke test passed)
  4. resolveAccessContext returns isPlatformAdmin=true for test admin (backend smoke test passed)
  5. No foreign key violations during platform org deletion
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md — Create cleanup migration (delete platform org + legacy memberships), update TypeScript types and JSDoc
- [x] 06-02-PLAN.md — Apply migration and smoke test platform admin access (frontend + backend verification)

### Phase 7: Type Alignment
**Goal**: All TypeScript types reflect nullable role_entity_id for platform_admin system roles
**Depends on**: Phase 6
**Requirements**: None (tech debt closure from audit)
**Success Criteria** (what must be TRUE):
  1. UserRoleDTO.role_entity_id is `string | null`
  2. IdentityClient.createUserRole accepts optional/nullable role_entity_id
  3. All affected packages build cleanly
**Plans**: 1 plan

Plans:
- [x] 07-01-PLAN.md — Fix nullable role_entity_id in UserRoleDTO and IdentityClient createUserRole

## Progress

**Execution Order:**
Phases execute in numeric order: 4 → 5 → 6 → 7

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 4. Schema & Data Migration | 1/1 | Complete | 2026-02-13 |
| 5. Access Integration | 2/2 | Complete | 2026-02-13 |
| 6. Cleanup & Validation | 2/2 | Complete | 2026-02-13 |
| 7. Type Alignment | 1/1 | Complete | 2026-02-13 |

---

## Milestone Summary

**Key Decisions:**

- Nullable role_entity_id in user_roles — Platform admins don't link to an entity. Nullable is simplest change. ✓ Good
- Only platform_admin moves — company_admin and hiring_manager are legitimately org-scoped. ✓ Good
- Remove platform organization entirely — Clean break. No synthetic data in the system. ✓ Good
- Split unique index strategy — Two partial indexes to handle NULL values correctly. ✓ Good
- Atomic validation approach — RAISE EXCEPTION in DO block aborts transaction on count mismatch. ✓ Good
- Minimal code change approach — EntityRoleRow.role_entity_id nullable, existing union supports dual-read. ✓ Good
- SYSTEM_ROLES constant for role classification — Explicit, extensible for future system roles. ✓ Good
- Event enrichment for audit — user_role.deleted event includes full context for audit trail. ✓ Good

**Issues Resolved:**

- FK violations during platform org deletion — resolved with FK verification step in cleanup migration
- Race condition during deployment — resolved with dual-read pattern in resolveAccessContext
- NOT NULL constraint blocking INSERT — resolved by sequencing ALTER TABLE before data migration

**Issues Deferred:**

- Supabase database.types.ts regeneration — user must run `supabase gen types typescript` manually

**Technical Debt Incurred:**

None — all tech debt from audit was resolved in Phase 7.

---
*Archived: 2026-02-13*
*For current project status, see .planning/ROADMAP.md*
