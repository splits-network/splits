---
milestone: v5.0
audited: 2026-02-13
status: gaps_found
scores:
  requirements: 25/25
  phases: 5/5
  integration: 10/14
  flows: 4/6
gaps:
  integration:
    - "Gateway authorize endpoint drops x-clerk-user-id header (CRITICAL)"
    - "Wildcard GET route double-appends query string (MODERATE)"
    - "GPT_SERVICE_URL missing from api-gateway K8s deployment (MODERATE)"
    - "INTERNAL_SERVICE_KEY missing from gpt-service K8s deployment (MINOR)"
  flows:
    - "OAuth authorization flow broken at gateway header forwarding"
    - "Consent-check flow broken at gateway URL construction"
tech_debt:
  - phase: 13-gpt-api-endpoints
    items:
      - "Confirmation token store is in-memory (tokens lost on restart, acceptable for 15-min TTL)"
  - phase: 14-openapi-schema-gpt-configuration
    items:
      - "GPT Builder configuration is manual (requires profile picture, privacy policy URL)"
---

# v5.0 Milestone Audit: Custom GPT / Applicant Network

**Audited:** 2026-02-13
**Scope:** Phases 11-15 (17 plans, 25 requirements)

## Requirements Coverage

All 25 requirements implemented. Code exists for each.

| Category | Count | Status |
|----------|-------|--------|
| Infrastructure (INFRA) | 3/3 | Complete |
| Authentication (AUTH) | 7/7 | Complete |
| Endpoints (ENDP) | 7/7 | Complete |
| Configuration (CONF) | 4/4 | Complete |
| Hardening (HARD) | 4/4 | Complete |

## Phase Status

| Phase | Plans | Status |
|-------|-------|--------|
| 11. Service Foundation | 3/3 | Complete |
| 12. OAuth2 Provider | 6/6 | Complete |
| 13. GPT API Endpoints | 4/4 | Complete |
| 14. OpenAPI Schema + GPT Config | 2/2 | Complete |
| 15. Production Hardening | 2/2 | Complete |

## Integration Check Results

### Cross-Phase Wiring: 10/14 Pass

| Connection | Status |
|------------|--------|
| Phase 11 EventPublisher → Phase 12 OAuthService | PASS |
| Phase 11 EventPublisher → Phase 13 action routes | PASS |
| Phase 11 AuditEventConsumer → all events | PASS |
| Phase 11 GptConfig → Phase 12 OAuthService | PASS |
| Phase 12 extractGptAuth → Phase 13 action routes | PASS |
| Phase 12 OAuthService → Phase 12 middleware | PASS |
| Phase 13 GptActionRepository → action routes | PASS |
| resolveAccessContext → Phase 13 repository | PASS |
| Phase 14 OpenAPI schema → Phase 13 routes | PASS |
| Phase 15 svix → Phase 12 webhook handler | PASS |
| Gateway authorize → gpt-service (x-clerk-user-id) | **FAIL** |
| Gateway wildcard GET → gpt-service (query string) | **FAIL** |
| api-gateway K8s → gpt-service K8s (GPT_SERVICE_URL) | **FAIL** |
| gpt-service K8s → ai-service K8s (INTERNAL_SERVICE_KEY) | **FAIL** |

### E2E Flows: 4/6 Pass

| Flow | Status | Issue |
|------|--------|-------|
| OAuth Authorization | **BROKEN** | Gateway drops x-clerk-user-id header + query string double-append |
| Job Search | PASS | (assuming token obtained) |
| Application Submit | PASS | (assuming token obtained) |
| Token Refresh | PASS | |
| User Deletion (webhook) | PASS | |
| Token Cleanup (CronJob) | PASS | |

## Critical Gaps (4 issues)

### Issue 1: Gateway authorize drops x-clerk-user-id [CRITICAL]

**File:** `services/api-gateway/src/routes/v2/gpt.ts` line 61
**Impact:** OAuth flow completely broken — authorize always returns 401

The explicit GET `/api/v1/gpt/oauth/authorize` route passes empty headers `{}` to gpt-service. The consent page sends `x-clerk-user-id: userId`, and gpt-service's authorize handler requires this header (returns 401 if missing).

**Fix:** Forward x-clerk-user-id header in the authorize route.

### Issue 2: Wildcard GET double-appends query string [MODERATE]

**File:** `services/api-gateway/src/routes/v2/gpt.ts` lines 139-142
**Impact:** Any wildcard GET with query params produces malformed URLs

`request.url` includes the query string, so `gptPath` already contains it. Then `buildQueryString` adds it again: `/api/v2/path?original?duplicate`.

The POST wildcard (line 175) correctly uses `request.url.split('?')[0]`.

**Fix:** Apply same `split('?')[0]` pattern to GET wildcard.

### Issue 3: GPT_SERVICE_URL missing from api-gateway K8s [MODERATE]

**File:** `infra/k8s/api-gateway/deployment.yaml`
**Impact:** Gateway falls back to `http://localhost:3014` in K8s — all GPT routes fail

All other services (identity, ats, network, etc.) have their URLs configured. GPT is missing.

**Fix:** Add `GPT_SERVICE_URL: http://gpt-service:80` env var.

### Issue 4: INTERNAL_SERVICE_KEY missing from gpt-service K8s [MINOR]

**File:** `infra/k8s/gpt-service/deployment.yaml`
**Impact:** Resume analysis fails (ai-service rejects unauthenticated requests)

The AI_SERVICE_URL default (`http://ai-service:3009`) happens to be correct since ai-service exposes port 3009 directly. But INTERNAL_SERVICE_KEY defaults to empty string.

**Fix:** Add INTERNAL_SERVICE_KEY from internal-service-secrets to gpt-service deployment.

## Tech Debt (non-blocking)

| Phase | Item | Risk |
|-------|------|------|
| 13 | In-memory confirmation token store | Low — 15-min TTL, tokens regenerated easily |
| 14 | Manual GPT Builder configuration required | None — one-time setup |

---
*Audit completed: 2026-02-13*
