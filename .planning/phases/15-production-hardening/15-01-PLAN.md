---
phase: 15-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/k8s/gpt-service/deployment.yaml
  - infra/k8s/gpt-service/cronjobs/token-cleanup.yaml
  - services/gpt-service/src/jobs/token-cleanup.ts
  - services/gpt-service/src/v2/oauth/webhook-handler.ts
  - services/gpt-service/package.json
  - .github/workflows/deploy-aks.yml
autonomous: true
user_setup:
  - service: clerk
    why: "Webhook signature verification"
    env_vars:
      - name: CLERK_WEBHOOK_SECRET
        source: "Clerk Dashboard -> Webhooks -> Signing Secret (whsec_...)"
    dashboard_config: []

must_haves:
  truths:
    - "gpt-service deployment runs 2 replicas for redundancy"
    - "Token cleanup CronJob runs every 6 hours and deletes expired auth codes, revoked refresh tokens, and expired sessions older than 30 days"
    - "Clerk webhook endpoint verifies signatures using svix before processing"
    - "deploy-aks workflow creates CLERK_WEBHOOK_SECRET in gpt-secrets and applies CronJob manifest"
  artifacts:
    - path: "infra/k8s/gpt-service/deployment.yaml"
      provides: "gpt-service K8s deployment with 2 replicas and CLERK_WEBHOOK_SECRET env var"
      contains: "replicas: 2"
    - path: "infra/k8s/gpt-service/cronjobs/token-cleanup.yaml"
      provides: "K8s CronJob running every 6 hours"
      contains: "schedule:"
    - path: "services/gpt-service/src/jobs/token-cleanup.ts"
      provides: "Standalone cleanup script deleting stale OAuth artifacts"
      contains: "gpt_authorization_codes"
    - path: "services/gpt-service/src/v2/oauth/webhook-handler.ts"
      provides: "Webhook handler with svix signature verification"
      contains: "svix"
  key_links:
    - from: "infra/k8s/gpt-service/cronjobs/token-cleanup.yaml"
      to: "services/gpt-service/src/jobs/token-cleanup.ts"
      via: "CronJob runs compiled JS from dist/jobs/token-cleanup.js"
      pattern: "token-cleanup\\.js"
    - from: ".github/workflows/deploy-aks.yml"
      to: "infra/k8s/gpt-service/cronjobs/"
      via: "kubectl apply for CronJob manifests"
      pattern: "gpt-service/cronjobs"
---

<objective>
Harden gpt-service deployment with 2 replicas, automated token cleanup CronJob, Clerk webhook signature verification, and deploy workflow updates.

Purpose: Make gpt-service production-ready with redundancy, automated maintenance, and security hardening.
Output: Updated K8s manifests, token cleanup job, webhook verification, deploy workflow changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-hardening/15-CONTEXT.md

@infra/k8s/gpt-service/deployment.yaml
@infra/k8s/ats-service/cronjobs/complete-expired-guarantees.yaml
@services/gpt-service/src/jobs/ (directory - no files yet, create it)
@services/ats-service/src/jobs/complete-expired-guarantees.ts
@services/gpt-service/src/v2/oauth/webhook-handler.ts
@services/gpt-service/src/v2/oauth/oauth-service.ts
@services/gpt-service/package.json
@.github/workflows/deploy-aks.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: K8s deployment update + token cleanup job + CronJob manifest</name>
  <files>
    infra/k8s/gpt-service/deployment.yaml
    infra/k8s/gpt-service/cronjobs/token-cleanup.yaml
    services/gpt-service/src/jobs/token-cleanup.ts
  </files>
  <action>
    **1. Update `infra/k8s/gpt-service/deployment.yaml`:**
    - Change `replicas: 1` to `replicas: 2` (decision: 2 replicas for redundancy)
    - Keep the comment about RabbitMQ audit events BUT update it: the audit consumer uses exclusive queues so 2 replicas is fine (only one consumer will get each message)
    - Add CLERK_WEBHOOK_SECRET env var from gpt-secrets:
      ```yaml
      - name: CLERK_WEBHOOK_SECRET
        valueFrom:
            secretKeyRef:
                name: gpt-secrets
                key: clerk-webhook-secret
      ```

    **2. Create `services/gpt-service/src/jobs/token-cleanup.ts`:**
    - Follow the exact same pattern as `services/ats-service/src/jobs/complete-expired-guarantees.ts`
    - Read env vars: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY (validate, exit 1 if missing)
    - Create Supabase client
    - Create a simple logger object (same pattern as ats-service jobs)
    - Calculate cutoff date: 30 days ago from now (`new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)`)
    - Run 3 cleanup queries in sequence:
      a. Delete expired authorization codes where `expires_at < cutoff` (used or not)
      b. Delete revoked refresh tokens where `revoked_at < cutoff` (revoked more than 30 days ago)
      c. Delete expired sessions where the associated refresh token is expired AND `expires_at < cutoff` on the refresh token
    - For each query, log count of deleted rows
    - Log final summary as JSON: `{ expired_auth_codes_deleted, revoked_tokens_deleted, expired_sessions_deleted }`
    - Do NOT delete from gpt_oauth_events (decision: keep audit events indefinitely)
    - No RabbitMQ needed for this job (unlike ats-service job, no events to publish)
    - Use `.delete()` with filter conditions, limit to 1000 per batch to avoid large transactions

    **3. Create `infra/k8s/gpt-service/cronjobs/token-cleanup.yaml`:**
    - Follow the exact pattern from `infra/k8s/ats-service/cronjobs/complete-expired-guarantees.yaml`
    - Name: `gpt-token-cleanup`
    - Schedule: `"0 */6 * * *"` (every 6 hours at minute 0)
    - Labels: `app: gpt-service`, `component: cron`
    - `concurrencyPolicy: Forbid`
    - `successfulJobsHistoryLimit: 3`, `failedJobsHistoryLimit: 3`
    - `activeDeadlineSeconds: 300` (5 min max, this is a lightweight job)
    - `backoffLimit: 0` (don't retry)
    - `restartPolicy: Never`
    - Container image: `${ACR_SERVER}/gpt-service:${IMAGE_TAG}` (uses envsubst)
    - Command: `["node"]`
    - Args: `["services/gpt-service/dist/jobs/token-cleanup.js"]`
    - Env vars: SUPABASE_URL (from supabase-secrets), SUPABASE_SERVICE_ROLE_KEY (from supabase-secrets), NODE_ENV=production, LOG_LEVEL=info
  </action>
  <verify>
    - `infra/k8s/gpt-service/deployment.yaml` has `replicas: 2` and `CLERK_WEBHOOK_SECRET` env var
    - `infra/k8s/gpt-service/cronjobs/token-cleanup.yaml` exists with correct schedule and image
    - `services/gpt-service/src/jobs/token-cleanup.ts` compiles: `npx tsc --noEmit --project services/gpt-service/tsconfig.json` (temporarily add jobs path if needed, or just check file syntax)
    - Token cleanup script references all 3 tables: gpt_authorization_codes, gpt_refresh_tokens, gpt_sessions
  </verify>
  <done>
    K8s deployment runs 2 replicas with CLERK_WEBHOOK_SECRET. Token cleanup CronJob manifest exists at correct schedule. Cleanup script handles all 3 token tables with 30-day retention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Svix webhook verification + deploy workflow updates</name>
  <files>
    services/gpt-service/src/v2/oauth/webhook-handler.ts
    services/gpt-service/package.json
    .github/workflows/deploy-aks.yml
  </files>
  <action>
    **1. Add svix dependency:**
    - Run `pnpm --filter @splits-network/gpt-service add svix`
    - This adds the official Clerk webhook verification library

    **2. Update `services/gpt-service/src/v2/oauth/webhook-handler.ts`:**
    - Import `Webhook` from `svix`
    - Accept CLERK_WEBHOOK_SECRET from deps (add to the deps interface: `clerkWebhookSecret?: string`)
    - At the top of the POST handler, BEFORE parsing the body:
      a. If `clerkWebhookSecret` is provided (production), verify the webhook signature
      b. Extract headers: `svix-id`, `svix-timestamp`, `svix-signature` from request.headers
      c. Create `new Webhook(clerkWebhookSecret)` and call `.verify(JSON.stringify(request.body), headers)`
      d. If verification fails, return 400 `{ error: 'Invalid webhook signature' }`
      e. If `clerkWebhookSecret` is NOT provided (development), log a warning and skip verification (allows local dev without Clerk)
    - Remove the TODO comment about Phase 15
    - Keep all existing logic (user.deleted handling) unchanged after verification

    **3. Update gpt-service `src/index.ts` to pass CLERK_WEBHOOK_SECRET:**
    - Read `CLERK_WEBHOOK_SECRET` from `process.env.CLERK_WEBHOOK_SECRET`
    - Pass it to `registerWebhookRoutes` as part of deps: `{ oauthService, logger, clerkWebhookSecret: process.env.CLERK_WEBHOOK_SECRET }`

    **4. Update `.github/workflows/deploy-aks.yml`:**
    - In the "Create secrets" step, update the `gpt-secrets` kubectl create command:
      Add `--from-literal=clerk-webhook-secret="${{ secrets.CLERK_WEBHOOK_SECRET }}"` to the gpt-secrets creation
    - In the "Deploy services" step, add CronJob deployment for gpt-service:
      After `kubectl apply -f infra/k8s/gpt-service/ --namespace=splits-network`, add:
      `kubectl apply -f infra/k8s/gpt-service/cronjobs/ --namespace=splits-network`
    - Note: The "Update image tags in manifests" step already processes `infra/k8s/*/cronjobs/*.yaml` files with envsubst, so no change needed there.
  </action>
  <verify>
    - `services/gpt-service/package.json` includes `svix` in dependencies
    - `webhook-handler.ts` imports from `svix` and calls `verify()`
    - `webhook-handler.ts` has no remaining TODO comment about Phase 15
    - `.github/workflows/deploy-aks.yml` contains `clerk-webhook-secret` in gpt-secrets creation
    - `.github/workflows/deploy-aks.yml` contains `kubectl apply -f infra/k8s/gpt-service/cronjobs/`
    - Build check: `pnpm --filter @splits-network/gpt-service build` succeeds
  </verify>
  <done>
    Webhook handler verifies Clerk signatures via svix in production. Deploy workflow creates CLERK_WEBHOOK_SECRET and deploys CronJob. gpt-service builds successfully with svix dependency.
  </done>
</task>

</tasks>

<verification>
- `infra/k8s/gpt-service/deployment.yaml` has replicas: 2, CLERK_WEBHOOK_SECRET env var
- `infra/k8s/gpt-service/cronjobs/token-cleanup.yaml` exists with 6-hour schedule
- `services/gpt-service/src/jobs/token-cleanup.ts` exists with 3 cleanup queries
- `services/gpt-service/src/v2/oauth/webhook-handler.ts` verifies signatures with svix
- `.github/workflows/deploy-aks.yml` includes clerk-webhook-secret and CronJob deployment
- `pnpm --filter @splits-network/gpt-service build` succeeds
</verification>

<success_criteria>
- gpt-service deployment manifest runs 2 replicas with CLERK_WEBHOOK_SECRET
- Token cleanup CronJob scheduled every 6 hours, cleans 3 tables with 30-day retention
- Webhook handler verifies Clerk signatures via svix (skips in dev without secret)
- Deploy workflow creates all secrets and deploys CronJob manifests
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-01-SUMMARY.md`
</output>
