---
phase: 15-production-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - services/api-gateway/src/routes/v2/gpt.ts
  - infra/k8s/api-gateway/deployment.yaml
  - infra/k8s/gpt-service/deployment.yaml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Gateway authorize endpoint forwards x-clerk-user-id header to gpt-service so OAuth flow returns 200 (not 401)"
    - "Wildcard GET routes do not double-append query strings when proxying to gpt-service"
    - "api-gateway K8s deployment includes GPT_SERVICE_URL so GPT routes reach gpt-service in the cluster"
    - "gpt-service K8s deployment includes INTERNAL_SERVICE_KEY so resume analysis can authenticate with ai-service"
  artifacts:
    - path: "services/api-gateway/src/routes/v2/gpt.ts"
      provides: "GPT gateway routing with correct header forwarding and URL construction"
      contains: "x-clerk-user-id"
    - path: "infra/k8s/api-gateway/deployment.yaml"
      provides: "api-gateway K8s deployment with GPT_SERVICE_URL"
      contains: "GPT_SERVICE_URL"
    - path: "infra/k8s/gpt-service/deployment.yaml"
      provides: "gpt-service K8s deployment with INTERNAL_SERVICE_KEY"
      contains: "INTERNAL_SERVICE_KEY"
  key_links:
    - from: "services/api-gateway/src/routes/v2/gpt.ts"
      to: "gpt-service authorize handler"
      via: "x-clerk-user-id header forwarding"
      pattern: "x-clerk-user-id"
    - from: "infra/k8s/api-gateway/deployment.yaml"
      to: "gpt-service K8s Service"
      via: "GPT_SERVICE_URL env var"
      pattern: "GPT_SERVICE_URL.*gpt-service"
    - from: "infra/k8s/gpt-service/deployment.yaml"
      to: "ai-service K8s Service"
      via: "INTERNAL_SERVICE_KEY from internal-service-secrets"
      pattern: "INTERNAL_SERVICE_KEY"
---

<objective>
Fix 4 integration gaps identified by the v5.0 milestone audit that prevent the GPT OAuth flow and K8s deployment from working correctly.

Purpose: Without these fixes, (1) OAuth authorization always 401s because the gateway drops the x-clerk-user-id header, (2) wildcard GET routes produce malformed URLs with doubled query strings, (3) the gateway cannot reach gpt-service in K8s because GPT_SERVICE_URL is missing, and (4) resume analysis fails because gpt-service lacks the INTERNAL_SERVICE_KEY to authenticate with ai-service.

Output: Three corrected files that close all 4 audit gaps.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v5.0-MILESTONE-AUDIT.md
@services/api-gateway/src/routes/v2/gpt.ts
@services/api-gateway/src/routes/v2/common.ts
@services/api-gateway/src/clients.ts
@infra/k8s/api-gateway/deployment.yaml
@infra/k8s/gpt-service/deployment.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix gateway authorize header forwarding and wildcard GET query string</name>
  <files>services/api-gateway/src/routes/v2/gpt.ts</files>
  <action>
  Two bugs in gpt.ts need fixing:

  **Bug 1 (CRITICAL): Authorize endpoint drops x-clerk-user-id header (line 61)**

  The authorize route currently passes empty headers `{}` as the 4th argument to `gptService().get()`. The consent page sends `x-clerk-user-id: userId` in the request, and gpt-service's authorize handler at `src/v2/oauth/routes.ts:123` returns 401 if this header is missing.

  Fix: On line 61, replace the empty `{}` with a headers object that forwards the `x-clerk-user-id` header from the incoming request. Follow the same pattern used by the wildcard GET route (lines 136, 144-150):

  ```typescript
  const clerkUserIdHeader = request.headers['x-clerk-user-id'];
  const headers: Record<string, string> = {};
  if (clerkUserIdHeader) {
      headers['x-clerk-user-id'] = clerkUserIdHeader as string;
  }
  ```

  Then pass `headers` instead of `{}` on line 61:
  ```typescript
  const data = await gptService().get(path, undefined, correlationId, headers);
  ```

  **Bug 2 (MODERATE): Wildcard GET double-appends query string (lines 139-142)**

  `request.url` includes the query string, so after the regex replace `gptPath` already contains it (e.g., `actions/jobs/search?keywords=nurse`). Then `buildQueryString(request.query)` constructs the same query string again, producing: `/api/v2/actions/jobs/search?keywords=nurse?keywords=nurse`.

  The POST wildcard (line 175) correctly strips the query string with `request.url.split('?')[0]`.

  Fix: Apply the same `split('?')[0]` pattern to the GET wildcard. Replace lines 139-142 with:

  ```typescript
  const fullPath = request.url.split('?')[0];
  const gptPath = fullPath.replace(/^\/api\/v1\/gpt\//, '');
  const queryString = buildQueryString(request.query as Record<string, any>);
  const path = queryString ? `/api/v2/${gptPath}?${queryString}` : `/api/v2/${gptPath}`;
  ```

  Do NOT change any other routes (token, revoke, POST wildcard) -- they are correct.
  </action>
  <verify>
  1. Run `pnpm --filter @splits-network/api-gateway build` -- should compile without errors
  2. Visually confirm: authorize route now extracts and forwards `x-clerk-user-id` header
  3. Visually confirm: wildcard GET uses `request.url.split('?')[0]` matching POST wildcard pattern
  </verify>
  <done>
  - Authorize endpoint forwards x-clerk-user-id header from request to gpt-service (no more empty `{}`)
  - Wildcard GET strips query string from URL before reconstructing it via buildQueryString (no double-append)
  - api-gateway builds successfully with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing K8s environment variables to deployment manifests</name>
  <files>infra/k8s/api-gateway/deployment.yaml, infra/k8s/gpt-service/deployment.yaml</files>
  <action>
  Two missing K8s environment variables prevent GPT routes and resume analysis from working in the cluster.

  **Fix 1 (MODERATE): Add GPT_SERVICE_URL to api-gateway deployment**

  In `infra/k8s/api-gateway/deployment.yaml`, add a new env entry after the existing SEARCH_SERVICE_URL (currently the last service URL at line ~109). Follow the exact same pattern as other service URLs:

  ```yaml
                      - name: GPT_SERVICE_URL
                        value: "http://gpt-service:80"
  ```

  Port 80 is correct because gpt-service's K8s Service maps port 80 -> targetPort 3014 (see gpt-service deployment.yaml lines 97-99).

  **Fix 2 (MINOR): Add INTERNAL_SERVICE_KEY to gpt-service deployment**

  In `infra/k8s/gpt-service/deployment.yaml`, add a new env entry after the existing GPT_CLERK_WEBHOOK_SECRET block (currently the last env var, ending around line 69). Follow the exact same pattern used by automation-service, analytics-service, and ats-service:

  ```yaml
                      - name: INTERNAL_SERVICE_KEY
                        valueFrom:
                            secretKeyRef:
                                name: internal-service-secrets
                                key: internal-service-key
  ```

  Use 24-space indentation for the `- name:` line and 28-space indentation for nested lines to match the existing indentation style in each file. Look at surrounding env entries and match exactly.
  </action>
  <verify>
  1. Visually confirm GPT_SERVICE_URL appears in api-gateway deployment.yaml env section
  2. Visually confirm INTERNAL_SERVICE_KEY appears in gpt-service deployment.yaml env section with secretKeyRef from internal-service-secrets
  3. YAML indentation is consistent with surrounding entries (no parse errors)
  </verify>
  <done>
  - api-gateway deployment.yaml includes `GPT_SERVICE_URL: http://gpt-service:80` so gateway can reach gpt-service in K8s
  - gpt-service deployment.yaml includes `INTERNAL_SERVICE_KEY` from `internal-service-secrets` so resume analysis can authenticate with ai-service
  </done>
</task>

</tasks>

<verification>
All 4 milestone audit gaps are closed:

1. **Gateway authorize drops x-clerk-user-id** -- FIXED: Header now forwarded
2. **Wildcard GET double-appends query string** -- FIXED: URL split before query reconstruction
3. **GPT_SERVICE_URL missing from api-gateway K8s** -- FIXED: Added to deployment.yaml
4. **INTERNAL_SERVICE_KEY missing from gpt-service K8s** -- FIXED: Added from internal-service-secrets

Build verification: `pnpm --filter @splits-network/api-gateway build` passes
</verification>

<success_criteria>
- api-gateway compiles without errors
- OAuth authorize route forwards x-clerk-user-id header (grep confirms presence)
- Wildcard GET uses split('?')[0] pattern matching POST wildcard
- api-gateway K8s manifest contains GPT_SERVICE_URL
- gpt-service K8s manifest contains INTERNAL_SERVICE_KEY from internal-service-secrets
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-03-SUMMARY.md`
</output>
