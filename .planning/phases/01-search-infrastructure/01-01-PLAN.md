---
phase: 01-search-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/network-service/src/v2/recruiters/repository.ts
  - supabase/migrations/YYYYMMDD000001_create_search_schema.sql
autonomous: true

must_haves:
  truths:
    - "Recruiters list search uses tsvector full-text search instead of ILIKE"
    - "search.search_index table exists with correct schema"
    - "GIN index exists on search.search_index.search_vector"
  artifacts:
    - path: "services/network-service/src/v2/recruiters/repository.ts"
      provides: "tsvector-based search replacing ILIKE"
      contains: "textSearch"
    - path: "supabase/migrations/YYYYMMDD000001_create_search_schema.sql"
      provides: "search schema + search_index table + GIN index"
      contains: "CREATE SCHEMA"
  key_links:
    - from: "services/network-service/src/v2/recruiters/repository.ts"
      to: "recruiters.search_vector"
      via: "textSearch Supabase query"
      pattern: "textSearch.*search_vector"
---

<objective>
Fix recruiters repository to use existing tsvector search infrastructure (replacing ILIKE), and create the dedicated search schema with unified search_index table and GIN index.

Purpose: Establishes the two foundations for global search -- (1) all entity tables now use tsvector search consistently, and (2) the target table for trigger-based sync exists.
Output: Updated recruiters repository using textSearch, new migration creating search.search_index table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key reference files:
@services/network-service/src/v2/recruiters/repository.ts
@supabase/migrations/20240101000000_baseline.sql (lines 299-353 for build_recruiters_search_vector, line 2284 for search_vector column, line 3588 for GIN index, line 3668 for trigger)
@docs/search/scalable-search-architecture.md (section 1.6 for recruiters spec)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix recruiters repository to use tsvector search</name>
  <files>services/network-service/src/v2/recruiters/repository.ts</files>
  <action>
  Replace the ILIKE-based search in `findRecruiters()` method with tsvector full-text search.

  The recruiters table ALREADY has:
  - `search_vector` tsvector column (baseline line 2284)
  - `build_recruiters_search_vector(p_recruiter_id)` function (baseline lines 299-350) covering: name (A), email (B), bio (B), tagline (B), industries (C), specialties (C), location (C), phone (D)
  - `update_recruiters_search_vector_trigger` (baseline line 3668) - BEFORE INSERT OR UPDATE
  - `sync_recruiter_user_search_vector` trigger on users table (baseline line 3624) - syncs when user name/email changes
  - `recruiters_search_vector_idx` GIN index (baseline line 3588)

  The repository currently uses a `parseSearchQuery()` method and builds ILIKE `.or()` conditions. Replace this with the same pattern used by all other V2 repositories:

  1. In the `findRecruiters()` method, replace the entire search block (lines ~57-88) with:
  ```typescript
  if (params.search) {
      const tsquery = params.search
          .split(/\s+/)
          .filter((t: string) => t.trim())
          .join(' & ');
      query = query.textSearch('search_vector', tsquery, {
          type: 'websearch',
          config: 'english',
      });
  }
  ```

  2. Remove the `useRelevanceSort` variable and the conditional sort logic that uses it (lines ~57, 86-88, 104-107). The tsvector search already handles relevance via ts_rank. Keep the default sort (`created_at` desc or user-specified `sort_by`).

  3. Delete the entire `parseSearchQuery()` private method (lines ~279-324). It is no longer needed.

  4. Do NOT change the `specialization` filter (line ~95-97) -- that standalone filter should stay as-is since it's a discrete filter, not search.

  Important: Do NOT touch any other methods in the repository. Only modify `findRecruiters()` and remove `parseSearchQuery()`.
  </action>
  <verify>
  Run `pnpm --filter @splits-network/network-service build` to verify TypeScript compiles without errors.
  Grep the file to confirm no remaining `ilike` calls in the search path and that `textSearch` is present.
  </verify>
  <done>
  - `findRecruiters()` uses `.textSearch('search_vector', ...)` for search
  - `parseSearchQuery()` method is deleted
  - No ILIKE in the search code path
  - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search schema and search_index table</name>
  <files>supabase/migrations/YYYYMMDD000001_create_search_schema.sql</files>
  <action>
  Create a new Supabase migration file. Use the next available timestamp: `20260213000002_create_search_schema.sql` (check existing migrations for the latest timestamp and pick the next one).

  The migration should create:

  1. **Search schema:**
  ```sql
  CREATE SCHEMA IF NOT EXISTS search;
  ```

  2. **search_index table:**
  ```sql
  CREATE TABLE IF NOT EXISTS search.search_index (
      id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
      entity_type text NOT NULL,
      entity_id uuid NOT NULL,
      title text NOT NULL DEFAULT '',
      subtitle text NOT NULL DEFAULT '',
      context text NOT NULL DEFAULT '',
      search_vector tsvector,
      metadata jsonb NOT NULL DEFAULT '{}',
      organization_id uuid,
      updated_at timestamptz NOT NULL DEFAULT now(),
      CONSTRAINT search_index_entity_unique UNIQUE (entity_type, entity_id)
  );
  ```

  The UNIQUE constraint on (entity_type, entity_id) enables UPSERT via ON CONFLICT.

  3. **GIN index on search_vector:**
  ```sql
  CREATE INDEX search_index_search_vector_idx
      ON search.search_index USING GIN (search_vector);
  ```

  4. **Supporting indexes for filtering:**
  ```sql
  CREATE INDEX search_index_entity_type_idx
      ON search.search_index (entity_type);

  CREATE INDEX search_index_organization_id_idx
      ON search.search_index (organization_id);

  CREATE INDEX search_index_updated_at_idx
      ON search.search_index (updated_at DESC);
  ```

  5. **Grant permissions** (follow existing patterns from baseline.sql):
  ```sql
  GRANT USAGE ON SCHEMA search TO anon, authenticated, service_role;
  GRANT ALL ON ALL TABLES IN SCHEMA search TO anon, authenticated, service_role;
  ALTER DEFAULT PRIVILEGES IN SCHEMA search GRANT ALL ON TABLES TO anon, authenticated, service_role;
  ```

  6. **Comment on table for documentation:**
  ```sql
  COMMENT ON TABLE search.search_index IS 'Unified search index for global search. Synced from entity tables via triggers. entity_type: candidate, job, company, recruiter, application, placement, recruiter_candidate';
  ```

  Important: Do NOT create any trigger functions in this migration. Triggers are in Plan 02 and Plan 03.
  Do NOT add entity_type CHECK constraint -- keep it flexible for future entity types.
  </action>
  <verify>
  Verify the SQL is syntactically correct by reviewing the file.
  Confirm the file follows the naming pattern of existing migrations in `supabase/migrations/`.
  Confirm the schema matches the spec: entity_type, entity_id, title, subtitle, context, search_vector, metadata, organization_id, updated_at.
  </verify>
  <done>
  - Migration file exists at `supabase/migrations/20260213000002_create_search_schema.sql`
  - Creates `search` schema
  - Creates `search.search_index` table with all specified columns
  - UNIQUE constraint on (entity_type, entity_id) for UPSERT support
  - GIN index on search_vector
  - Supporting indexes on entity_type, organization_id, updated_at
  - Schema permissions granted
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @splits-network/network-service build` passes
2. `grep -n "textSearch" services/network-service/src/v2/recruiters/repository.ts` shows tsvector usage
3. `grep -n "ilike" services/network-service/src/v2/recruiters/repository.ts` shows NO ilike in search path (only in specialization filter which is OK)
4. `grep -n "parseSearchQuery" services/network-service/src/v2/recruiters/repository.ts` returns no results
5. Migration file exists and contains CREATE SCHEMA, CREATE TABLE, CREATE INDEX statements
</verification>

<success_criteria>
- Recruiters repository uses tsvector full-text search (INFRA-09 complete)
- search.search_index table is defined with correct schema (INFRA-01 complete)
- GIN index on search_vector is defined (INFRA-08 complete)
- Network service builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-search-infrastructure/01-01-SUMMARY.md`
</output>
