---
phase: 12-oauth2-provider
plan: 05
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - apps/candidate/src/app/authorize/page.tsx
  - apps/candidate/src/app/authorize/consent-client.tsx
  - apps/candidate/src/app/authorize/error/page.tsx
  - apps/candidate/src/app/authorize/success/page.tsx
  - apps/candidate/src/app/authorize/learn-more/page.tsx
autonomous: false

must_haves:
  truths:
    - "Consent page shows Applicant.Network branding, GPT name, and requested permissions"
    - "Unauthenticated users are redirected to sign-in, then back to consent after auth"
    - "Returning users with existing consent skip the consent page (auto-approve)"
    - "Cancel button redirects to ChatGPT callback with access_denied error"
    - "Successful authorization shows brief 'Connected!' flash before redirect"
    - "Error page shows user-friendly messages with 'Try again' and 'Return to ChatGPT' links"
    - "Scope upgrade shows only new permissions not previously granted"
    - "Session limit shows clear error message with link to profile to revoke"
  artifacts:
    - path: "apps/candidate/src/app/authorize/page.tsx"
      provides: "Server component entry for OAuth consent page"
      min_lines: 10
    - path: "apps/candidate/src/app/authorize/consent-client.tsx"
      provides: "Client component with consent UI, Clerk auth check, and OAuth flow"
      min_lines: 100
    - path: "apps/candidate/src/app/authorize/error/page.tsx"
      provides: "Branded OAuth error page"
      min_lines: 20
    - path: "apps/candidate/src/app/authorize/success/page.tsx"
      provides: "Connected! success flash page with auto-redirect"
      min_lines: 15
    - path: "apps/candidate/src/app/authorize/learn-more/page.tsx"
      provides: "GPT integration explanation page"
      min_lines: 30
  key_links:
    - from: "apps/candidate/src/app/authorize/consent-client.tsx"
      to: "services/gpt-service via api-gateway /api/v1/gpt/oauth/authorize"
      via: "fetch POST to /api/v1/gpt/oauth/authorize"
      pattern: "api/v1/gpt/oauth"
    - from: "apps/candidate/src/app/authorize/consent-client.tsx"
      to: "services/gpt-service via api-gateway /api/v1/gpt/oauth/consent-check"
      via: "fetch GET to check existing consent"
      pattern: "consent-check"
---

<objective>
Build the branded OAuth consent page, error page, success flash, and learn-more page in the candidate app.

Purpose: When ChatGPT initiates the OAuth flow, users land on this consent page to authorize the GPT. This is the user-facing front door of the OAuth2 flow. It must match Applicant.Network's style and handle all edge cases (unauthenticated users, returning users, scope upgrades, session limits).

Output: Four pages in the candidate app under /authorize/*.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-oauth2-provider/12-CONTEXT.md
@.planning/phases/12-oauth2-provider/12-02-SUMMARY.md
@apps/candidate/src/app/portal/profile/page.tsx
@apps/candidate/src/app/portal/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consent page with Clerk auth flow</name>
  <files>
    apps/candidate/src/app/authorize/page.tsx
    apps/candidate/src/app/authorize/consent-client.tsx
  </files>
  <action>
**Create `apps/candidate/src/app/authorize/page.tsx`** (server component):
Simple wrapper that renders the client component. This is a public route (not under /portal) so it doesn't require the portal layout. The page receives OAuth query parameters from ChatGPT's redirect.

```tsx
import { ConsentClient } from './consent-client';

export default function AuthorizePage() {
    return <ConsentClient />;
}
```

**Create `apps/candidate/src/app/authorize/consent-client.tsx`** ("use client"):

This is the main consent page component. It handles the full OAuth authorization flow.

**URL query parameters** (from ChatGPT redirect):
- `response_type` (must be 'code')
- `client_id`
- `redirect_uri` (ChatGPT callback URL)
- `scope` (space-separated scopes)
- `state` (CSRF token from ChatGPT)
- `code_challenge`
- `code_challenge_method`

**Flow:**

1. **Read query params** from `useSearchParams()`

2. **Check Clerk auth** via `useAuth()`:
   - If NOT signed in: redirect to `/sign-in?redirect_url=/authorize?${currentQueryString}` so after sign-in they return to consent
   - If signed in: continue to step 3

3. **Check existing consent** via API call to `/api/v1/gpt/oauth/consent-check`:
   - Send `x-clerk-user-id` header (obtained from `useAuth()`)
   - Send requested scopes
   - If `hasConsent === true`: auto-approve (skip to step 5 -- call authorize directly)
   - If `sessionCount >= 5`: show session limit error (link to /portal/profile to revoke)
   - Otherwise: show consent UI

4. **Consent UI** (matching Applicant.Network style):
   - Container: centered card, max-w-md, white bg, rounded, shadow
   - Header: Applicant.Network logo (use existing logo pattern from candidate app)
   - Title: "AI Job Copilot -- Applicant Network wants to access your account"
   - Subtitle: "This Custom GPT will be able to:"
   - Permissions list: Map scopes to human-readable names:
     - `jobs:read` -> "Search jobs" (with search icon)
     - `applications:read` -> "Check your applications" (with list icon)
     - `applications:write` -> "Submit applications" (with send icon)
     - `resume:read` -> "Analyze resume fit" (with document icon)
   - For scope upgrades: show "New permissions requested:" header above only the NEW scopes, and "Previously granted:" in muted text for existing scopes
   - "Learn more" link to `/authorize/learn-more`
   - Two buttons: "Cancel" (outlined) and "Allow" (primary)
   - Mobile-responsive: full-width on small screens

5. **On "Allow" click** (or auto-approve):
   - POST to `/api/v1/gpt/oauth/authorize` with:
     - All original query params (client_id, redirect_uri, scope, state, code_challenge, code_challenge_method)
     - `x-clerk-user-id` header
   - On success: redirect to `/authorize/success?redirect_uri=${encodeURIComponent(redirectUri)}&code=${code}&state=${state}`
   - On error: redirect to `/authorize/error?error=server_error&message=${encodeURIComponent(errorMessage)}&redirect_uri=${encodeURIComponent(redirectUri)}`

6. **On "Cancel" click**:
   - Redirect to `${redirect_uri}?error=access_denied&error_description=User+denied+consent&state=${state}`

**Styling:**
- Use DaisyUI classes: `card`, `btn`, `btn-primary`, `btn-outline`, `badge`
- FontAwesome icons: `fa-duotone fa-regular` prefix
- Match the Applicant.Network color scheme (primary color from existing candidate app theme)
- No additional CSS files -- Tailwind utility classes only

**Important:**
- Do NOT use `getToken` in dependency arrays (per MEMORY.md)
- Use `createAuthenticatedClient` pattern from existing profile page for API calls
- The consent page calls the api-gateway endpoint, not gpt-service directly
  </action>
  <verify>Read both files. Confirm: (1) server component exists, (2) client component handles auth check, consent check, consent UI, approve/deny flow, (3) uses Applicant.Network styling, (4) handles scope upgrades and session limits.</verify>
  <done>Consent page renders branded UI, checks for existing consent (auto-approves returning users), shows scope upgrade diffs, handles session limits, and completes OAuth authorization code flow.</done>
</task>

<task type="auto">
  <name>Task 2: Create error page, success flash, and learn-more page</name>
  <files>
    apps/candidate/src/app/authorize/error/page.tsx
    apps/candidate/src/app/authorize/success/page.tsx
    apps/candidate/src/app/authorize/learn-more/page.tsx
  </files>
  <action>
**Create `apps/candidate/src/app/authorize/error/page.tsx`** ("use client"):

Branded error page for OAuth flow errors. Read query params:
- `error`: error code
- `message`: human-readable message
- `redirect_uri`: ChatGPT callback URL (for "Return to ChatGPT" link)

Display:
- Applicant.Network branding (logo)
- Error icon (fa-circle-exclamation)
- User-friendly error message based on error code:
  - `access_denied` -> "Authorization was cancelled"
  - `server_error` -> "Something went wrong. Please try again."
  - `expired` -> "Link expired, please try again"
  - `session_limit` -> "Session limit reached. You have 5 active sessions." + link to /portal/profile
  - `invalid_scope` -> "Invalid permissions requested"
  - default -> message param or "An error occurred"
- Two buttons:
  - "Try again" -> `window.history.back()` or restart OAuth
  - "Return to ChatGPT" -> navigate to redirect_uri (if provided)
- Styled as centered card, same design language as consent page

**Create `apps/candidate/src/app/authorize/success/page.tsx`** ("use client"):

Brief success flash before redirecting to ChatGPT.

Query params: `redirect_uri`, `code`, `state`

Display:
- Centered card with check icon (fa-check-circle, green/success color)
- "Connected!" heading
- "Redirecting you back to ChatGPT..." subtext
- Auto-redirect after 1.5 seconds: `redirect_uri?code=${code}&state=${state}`
- Fallback link: "Click here if you're not redirected automatically"

Use `useEffect` with `setTimeout` for the auto-redirect. Use `window.location.href` for the redirect (not Next.js router, since we're leaving the app).

**Create `apps/candidate/src/app/authorize/learn-more/page.tsx`**:

Static informational page explaining the GPT integration. Content:

- "About AI Job Copilot" heading
- Brief explanation of what the Custom GPT does:
  - "AI Job Copilot is a Custom GPT in ChatGPT that helps you search for jobs, analyze your resume against job postings, check application statuses, and submit applications -- all through natural language conversation."
- "What data is shared" section:
  - Explain each scope category clearly
  - Emphasize: "Your data is only accessed when you interact with the GPT. No background data collection."
- "Managing your connection" section:
  - "You can revoke access at any time from your Profile > Connected Apps"
  - Link to /portal/profile
- "Security" section:
  - "Access tokens expire every 15 minutes"
  - "You can have up to 5 active sessions"
  - "Revoking a session immediately stops all access"
- Back link: "Back to authorization" (browser back)

Styled as a readable article layout, max-w-2xl, centered, matching Applicant.Network style.
  </action>
  <verify>
Read all three files. Confirm:
1. Error page shows user-friendly messages per error code, has "Try again" and "Return to ChatGPT" buttons
2. Success page shows "Connected!" flash and auto-redirects to ChatGPT callback after 1.5s
3. Learn-more page explains GPT features, data sharing, and management
  </verify>
  <done>Error page handles all OAuth error scenarios with branded UI. Success page provides brief confirmation before ChatGPT redirect. Learn-more page explains the integration clearly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>OAuth consent page, error page, success flash, and learn-more page in the candidate app.</what-built>
  <how-to-verify>
1. Start the candidate app: `pnpm --filter @splits-network/candidate dev`
2. Navigate to `http://localhost:3200/authorize?response_type=code&client_id=test&redirect_uri=https://chat.openai.com/aip/oauth/callback&scope=jobs:read+applications:read&state=test123&code_challenge=test&code_challenge_method=S256`
3. If not signed in, verify redirect to sign-in page
4. If signed in, verify consent page shows:
   - Applicant.Network branding
   - "AI Job Copilot -- Applicant Network" title
   - Permission list: "Search jobs" and "Check your applications"
   - Allow and Cancel buttons
   - "Learn more" link
5. Click "Learn more" -- verify informational page loads
6. Navigate to `/authorize/error?error=access_denied&message=Test+error&redirect_uri=https://example.com`
7. Verify error page shows "Authorization was cancelled" with branded styling
8. Navigate to `/authorize/success?redirect_uri=https://example.com&code=test&state=test`
9. Verify "Connected!" flash appears and auto-redirects after ~1.5s
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
1. All four pages exist under apps/candidate/src/app/authorize/
2. Consent page integrates Clerk auth check and API calls
3. Error page maps error codes to friendly messages
4. Success page auto-redirects to ChatGPT callback
5. Mobile-responsive design on all pages
</verification>

<success_criteria>
Consent page renders branded UI matching Applicant.Network style. Unauthenticated users redirect to sign-in and back. Error handling covers all OAuth error scenarios. Success flash provides smooth transition back to ChatGPT.
</success_criteria>

<output>
After completion, create `.planning/phases/12-oauth2-provider/12-05-SUMMARY.md`
</output>
