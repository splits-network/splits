---
phase: 12-oauth2-provider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260221000001_add_scopes_to_gpt_oauth_tables.sql
  - packages/shared-config/src/index.ts
autonomous: true

must_haves:
  truths:
    - "gpt_authorization_codes table has a scopes TEXT[] column"
    - "gpt_sessions table has scopes and granted_scopes TEXT[] columns"
    - "GptConfig loads ecPrivateKeyBase64 instead of jwtSecret"
    - "Access token TTL defaults to 900 (15 min), refresh token to 2592000 (30 days), auth code to 300 (5 min)"
  artifacts:
    - path: "supabase/migrations/20260221000001_add_scopes_to_gpt_oauth_tables.sql"
      provides: "Scopes columns on GPT OAuth tables"
      contains: "ALTER TABLE"
    - path: "packages/shared-config/src/index.ts"
      provides: "Updated GptConfig with ecPrivateKeyBase64 and correct TTL defaults"
      contains: "ecPrivateKeyBase64"
  key_links:
    - from: "packages/shared-config/src/index.ts"
      to: "services/gpt-service/src/index.ts"
      via: "loadGptConfig() import"
      pattern: "loadGptConfig"
---

<objective>
Add scopes columns to GPT OAuth tables and update shared-config for ES256 JWT signing.

Purpose: Phase 12 CONTEXT.md specifies granular scopes (`jobs:read`, `applications:read`, `applications:write`, `resume:read`) and ES256 asymmetric JWT signing. The Phase 11 tables lack scopes columns, and the config uses a symmetric `jwtSecret`. This plan adds the database columns and updates the config interface before OAuth logic is built.

Output: One SQL migration file adding scopes to existing tables, and updated `GptConfig` interface/loader in shared-config.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-oauth2-provider/12-CONTEXT.md
@.planning/phases/11-service-foundation/11-02-SUMMARY.md
@supabase/migrations/20260220000001_create_gpt_oauth_tables.sql
@packages/shared-config/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scopes columns to GPT OAuth tables</name>
  <files>supabase/migrations/20260221000001_add_scopes_to_gpt_oauth_tables.sql</files>
  <action>
Create a migration file that:

1. Adds `scopes TEXT[] NOT NULL DEFAULT '{}'` to `gpt_authorization_codes` -- stores the scopes requested in this authorization request.
2. Adds `scopes TEXT[] NOT NULL DEFAULT '{}'` to `gpt_sessions` -- stores the currently active scopes for this session.
3. Adds `granted_scopes TEXT[] NOT NULL DEFAULT '{}'` to `gpt_sessions` -- cumulative record of all scopes ever granted for this session (used for "returning user skip consent" and "scope upgrade shows only new scopes" features).

All three columns use `TEXT[]` (Postgres array) with a `NOT NULL DEFAULT '{}'` constraint. No CHECK constraint on scope values -- validation happens in application code.

Include a header comment explaining the purpose (adding scope support for Phase 12 OAuth2 Provider).
  </action>
  <verify>Read the migration file and confirm all three ALTER TABLE statements exist with correct column definitions.</verify>
  <done>Migration file exists with scopes on gpt_authorization_codes, and scopes + granted_scopes on gpt_sessions, all as TEXT[] NOT NULL DEFAULT '{}'.</done>
</task>

<task type="auto">
  <name>Task 2: Update GptConfig for ES256 asymmetric signing</name>
  <files>packages/shared-config/src/index.ts</files>
  <action>
Update the `GptConfig` interface and `loadGptConfig()` function:

1. **Replace** `jwtSecret: string` with `ecPrivateKeyBase64: string` in the `GptConfig` interface. This is the base64-encoded PEM of the EC private key for ES256 signing.

2. **Update** `loadGptConfig()`:
   - Replace `jwtSecret: getEnvOrThrow('GPT_JWT_SECRET')` with `ecPrivateKeyBase64: getEnvOrThrow('GPT_EC_PRIVATE_KEY')`.
   - Update default TTLs to match CONTEXT.md decisions:
     - `accessTokenExpiry` default: `'900'` (15 minutes, was '3600')
     - `refreshTokenExpiry` default stays `'2592000'` (30 days, unchanged)
     - `authCodeExpiry` default: `'300'` (5 minutes, was '600')

Do NOT change any other config loaders. Only modify `GptConfig` and `loadGptConfig()`.

Also update the gpt-service `index.ts` log line that references `gptConfig.jwtSecret` -- there is none currently, but the log does reference the config. Verify the log line at `services/gpt-service/src/index.ts` does NOT log any key material. The existing log only logs `clientId`, `redirectUri`, and TTL values which is fine.
  </action>
  <verify>Read `packages/shared-config/src/index.ts` and confirm: (1) `GptConfig` has `ecPrivateKeyBase64` not `jwtSecret`, (2) env var is `GPT_EC_PRIVATE_KEY`, (3) accessTokenExpiry defaults to 900, (4) authCodeExpiry defaults to 300.</verify>
  <done>GptConfig interface uses ecPrivateKeyBase64, loadGptConfig reads GPT_EC_PRIVATE_KEY env var, TTL defaults match CONTEXT.md (900s access, 2592000s refresh, 300s auth code).</done>
</task>

</tasks>

<verification>
1. Migration file exists at `supabase/migrations/20260221000001_add_scopes_to_gpt_oauth_tables.sql`
2. Migration adds 3 columns across 2 tables (scopes on auth_codes, scopes + granted_scopes on sessions)
3. `GptConfig.ecPrivateKeyBase64` replaces `GptConfig.jwtSecret`
4. `loadGptConfig()` reads `GPT_EC_PRIVATE_KEY` env var
5. Default TTLs: 900s (access), 2592000s (refresh), 300s (auth code)
</verification>

<success_criteria>
Database schema supports scoped authorization and session tracking. Shared config supports ES256 key loading with correct TTL defaults. No breaking changes to non-GPT config.
</success_criteria>

<output>
After completion, create `.planning/phases/12-oauth2-provider/12-01-SUMMARY.md`
</output>
