---
phase: 12-oauth2-provider
plan: 04
type: execute
wave: 3
depends_on: ["12-02", "12-03"]
files_modified:
  - services/gpt-service/src/v2/oauth/routes.ts
  - services/gpt-service/src/v2/oauth/middleware.ts
  - services/gpt-service/src/v2/routes.ts
  - services/gpt-service/src/index.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v2/oauth/authorize redirects unauthenticated users to Clerk sign-in, then generates auth code for authenticated users"
    - "POST /api/v2/oauth/token exchanges authorization code for access + refresh tokens"
    - "POST /api/v2/oauth/token with grant_type=refresh_token refreshes tokens with rotation"
    - "POST /api/v2/oauth/revoke invalidates a session's tokens"
    - "extractGptAuth middleware validates JWT Bearer token and populates request.gptAuth"
    - "Scope checking middleware rejects requests missing required scope with { error: 'insufficient_scope', scope: 'required_scope' }"
  artifacts:
    - path: "services/gpt-service/src/v2/oauth/routes.ts"
      provides: "Fastify route handlers for OAuth endpoints"
      exports: ["registerOAuthRoutes"]
    - path: "services/gpt-service/src/v2/oauth/middleware.ts"
      provides: "JWT validation middleware and scope checker"
      exports: ["extractGptAuth", "requireScope"]
  key_links:
    - from: "services/gpt-service/src/v2/oauth/routes.ts"
      to: "services/gpt-service/src/v2/oauth/oauth-service.ts"
      via: "OAuthService method calls"
      pattern: "oauthService\\."
    - from: "services/gpt-service/src/v2/oauth/middleware.ts"
      to: "services/gpt-service/src/v2/oauth/oauth-service.ts"
      via: "validateAccessToken call"
      pattern: "oauthService\\.validateAccessToken"
    - from: "services/gpt-service/src/v2/routes.ts"
      to: "services/gpt-service/src/v2/oauth/routes.ts"
      via: "registerOAuthRoutes import"
      pattern: "registerOAuthRoutes"
---

<objective>
Wire OAuth route handlers and JWT validation middleware in gpt-service.

Purpose: Connect the OAuthService (Plan 02) to HTTP endpoints so ChatGPT can initiate OAuth flows and gpt-service can validate incoming GPT tokens for future API endpoints (Phase 13).

Output: OAuth Fastify routes, JWT middleware, and updated route registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-oauth2-provider/12-CONTEXT.md
@.planning/phases/12-oauth2-provider/12-02-SUMMARY.md
@services/gpt-service/src/v2/routes.ts
@services/gpt-service/src/v2/shared/events.ts
@services/gpt-service/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OAuth route handlers</name>
  <files>
    services/gpt-service/src/v2/oauth/routes.ts
    services/gpt-service/src/v2/routes.ts
    services/gpt-service/src/index.ts
  </files>
  <action>
**Create `services/gpt-service/src/v2/oauth/routes.ts`:**

Export `registerOAuthRoutes(app, { oauthService })` function with these Fastify routes:

**1. GET /api/v2/oauth/authorize**
Query params: `response_type`, `client_id`, `redirect_uri`, `scope`, `state`, `code_challenge`, `code_challenge_method`

Handler logic:
- Validate `response_type === 'code'` (only supported type)
- Validate `client_id` matches GptConfig.clientId
- Parse `scope` (space-separated string) into array
- Validate all scopes are valid GPT scopes
- This endpoint is called from the consent page AFTER the user has authenticated via Clerk. The consent page sends the `clerk_user_id` as a header (`x-clerk-user-id`). Read it from the request header.
- Call `oauthService.authorize({ clerkUserId, redirectUri, scopes, state, codeChallenge, codeChallengeMethod })`
- Redirect (302) to `redirect_uri` with `code` and `state` as query params
- On error: redirect to `redirect_uri` with `error` and `error_description` query params per OAuth2 spec
- Rate limit: use Fastify config `{ rateLimit: { max: 10, timeWindow: '15 minutes' } }` (if @fastify/rate-limit is available, otherwise skip and document for Phase 15)

**2. POST /api/v2/oauth/token**
Body (application/x-www-form-urlencoded via @fastify/formbody):
- `grant_type`: 'authorization_code' or 'refresh_token'
- `code` (for authorization_code grant)
- `code_verifier` (for authorization_code grant, PKCE)
- `client_id`, `client_secret`
- `redirect_uri` (for authorization_code grant)
- `refresh_token` (for refresh_token grant)

Handler logic:
- If `grant_type === 'authorization_code'`:
  - Call `oauthService.exchangeCode({ code, codeVerifier, clientId, clientSecret, redirectUri })`
- If `grant_type === 'refresh_token'`:
  - Call `oauthService.refresh({ refreshToken, clientId, clientSecret })`
- Return TokenResponse as JSON with 200 status
- On OAuthError: return 400 with `{ error: oauthError.code, error_description: oauthError.message }`
- On unexpected error: return 500 with `{ error: 'server_error', error_description: 'Internal server error' }`

**3. POST /api/v2/oauth/revoke**
Body (JSON): `{ session_id: string }`
Authorization: Bearer token (GPT access token)

Handler logic:
- Extract and validate GPT access token from Authorization header using `oauthService.validateAccessToken()`
- Call `oauthService.revoke(sessionId, clerkUserId)`
- Return 200 with `{ data: { revoked: true } }`
- On error: return appropriate error

**4. GET /api/v2/oauth/sessions**
Authorization: Bearer token (GPT access token)

Handler logic:
- Extract and validate GPT access token
- Call `oauthService.listSessions(clerkUserId)`
- Return `{ data: sessions }`

**5. GET /api/v2/oauth/consent-check**
Query params: `clerk_user_id`, `scopes` (comma-separated)
No auth required (called by consent page frontend which has Clerk auth)

Handler logic:
- Read `x-clerk-user-id` header (set by consent page backend)
- Call `oauthService.hasExistingConsent(clerkUserId, scopes)`
- Return `{ data: { hasConsent: boolean, sessionCount: number } }`

**Update `services/gpt-service/src/v2/routes.ts`:**
- Import `registerOAuthRoutes` from `./oauth/routes`
- Import `OAuthService` from `./oauth/oauth-service`
- In `registerV2Routes`, instantiate `OAuthService` with dependencies and call `registerOAuthRoutes(app, { oauthService })`
- Update `RegisterConfig` interface to include `gptConfig: GptConfig` (import from shared-config)

**Update `services/gpt-service/src/index.ts`:**
- Pass `gptConfig` into `registerV2Routes` config object
  </action>
  <verify>
Read routes.ts, oauth/routes.ts, and index.ts. Confirm:
1. All 5 OAuth endpoints registered
2. OAuthService instantiated with correct dependencies
3. gptConfig passed through to route registration
4. Token endpoint handles both grant types
5. Error responses follow OAuth2 format
  </verify>
  <done>OAuth endpoints handle authorize, token exchange, refresh, revoke, session listing, and consent check. Token endpoint supports both authorization_code and refresh_token grant types.</done>
</task>

<task type="auto">
  <name>Task 2: Create JWT validation middleware and scope checker</name>
  <files>services/gpt-service/src/v2/oauth/middleware.ts</files>
  <action>
**Create `services/gpt-service/src/v2/oauth/middleware.ts`:**

**1. `extractGptAuth(oauthService)` - Fastify preHandler:**
Returns a Fastify preHandler hook function that:
- Reads `Authorization` header, expects `Bearer gpt_at_...`
- If no token or doesn't start with `Bearer gpt_at_`: reply 401 with `{ error: 'token_missing', error_description: 'GPT access token required' }`
- Calls `oauthService.validateAccessToken(token)`
- On success: attaches to request as `(request as any).gptAuth = { clerkUserId, sessionId, scopes }`
- On error (expired): reply 401 with `{ error: 'token_expired', error_description: 'Access token has expired' }`
- On error (invalid signature/claims): reply 401 with `{ error: 'invalid_token', error_description: 'Invalid access token' }`

**2. `requireScope(scope: string)` - Fastify preHandler:**
Returns a preHandler that:
- Reads `request.gptAuth.scopes`
- If scopes does not include the required scope: reply 403 with `{ error: 'insufficient_scope', scope: scope }` (per CONTEXT.md)
- Otherwise: continue

**3. Extend FastifyRequest type:**
Add type declaration for `gptAuth`:
```typescript
declare module 'fastify' {
    interface FastifyRequest {
        gptAuth?: {
            clerkUserId: string;
            sessionId: string;
            scopes: string[];
        };
    }
}
```

Export both `extractGptAuth` and `requireScope`. These will be used by Phase 13 GPT API endpoint routes.

Error format follows CONTEXT.md: OAuth Bearer Token error format, HTTP 401/403, with distinct error codes (`token_expired`, `token_revoked`, `insufficient_scope`).
  </action>
  <verify>Read middleware.ts and confirm: (1) extractGptAuth validates Bearer token, (2) requireScope checks scopes array, (3) FastifyRequest type extended with gptAuth, (4) error codes match CONTEXT.md.</verify>
  <done>JWT validation middleware extracts clerk_user_id and scopes from GPT access tokens. Scope checking middleware returns insufficient_scope error with required scope name. Both ready for Phase 13 endpoint protection.</done>
</task>

</tasks>

<verification>
1. All OAuth route handlers exist and map to OAuthService methods
2. Token endpoint handles both authorization_code and refresh_token grants
3. extractGptAuth validates ES256 JWT and populates request.gptAuth
4. requireScope rejects requests missing required scope with correct error format
5. gpt-service compiles: `pnpm --filter @splits-network/gpt-service build`
</verification>

<success_criteria>
gpt-service exposes OAuth endpoints that ChatGPT can call for authorization code flow. JWT middleware is ready for Phase 13 to protect GPT API endpoints with scope-based access control.
</success_criteria>

<output>
After completion, create `.planning/phases/12-oauth2-provider/12-04-SUMMARY.md`
</output>
