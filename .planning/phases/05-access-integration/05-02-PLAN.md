---
phase: 05-access-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/identity-service/src/v2/user-roles/types.ts
  - services/identity-service/src/v2/user-roles/service.ts
autonomous: true

must_haves:
  truths:
    - "POST /v2/user-roles accepts platform_admin with null role_entity_id and creates the row"
    - "POST /v2/user-roles still requires role_entity_id for non-platform_admin roles (recruiter, candidate)"
    - "DELETE /v2/user-roles soft-deletes platform_admin row and publishes user_role.deleted event with user_id and role_name"
    - "user_role.created event includes role_name so downstream consumers know it was a platform_admin grant"
  artifacts:
    - path: "services/identity-service/src/v2/user-roles/types.ts"
      provides: "Updated UserRoleCreate with optional role_entity_id"
      contains: "role_entity_id?: string"
    - path: "services/identity-service/src/v2/user-roles/service.ts"
      provides: "Conditional validation: require entity_id for entity-linked roles, allow null for platform_admin"
      contains: "platform_admin"
  key_links:
    - from: "services/identity-service/src/v2/user-roles/service.ts"
      to: "services/identity-service/src/v2/user-roles/repository.ts"
      via: "createUserRole passes data with null role_entity_id"
      pattern: "role_entity_id.*null"
    - from: "services/identity-service/src/v2/user-roles/service.ts"
      to: "EventPublisherV2"
      via: "publish user_role.created and user_role.deleted"
      pattern: "eventPublisher\\.publish.*user_role\\."
---

<objective>
Update identity-service user-roles domain to support creating and deleting platform_admin roles with nullable entity fields, and enrich event payloads for audit.

Purpose: The user-roles API currently requires role_entity_id for all role assignments (it was designed for recruiter/candidate entity-linked roles). Platform admin is a system-level role with no entity, so the API must conditionally allow null entity fields when role_name is 'platform_admin'. Events already publish but need enriched payloads for AUDIT-01.

Output: Updated user-roles types and service that accept platform_admin with null role_entity_id, publish enriched events.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-schema-data-migration/04-01-SUMMARY.md
@services/identity-service/src/v2/user-roles/types.ts
@services/identity-service/src/v2/user-roles/service.ts
@services/identity-service/src/v2/user-roles/routes.ts
@services/identity-service/src/v2/user-roles/repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update user-roles types and service for platform_admin support</name>
  <files>
    services/identity-service/src/v2/user-roles/types.ts
    services/identity-service/src/v2/user-roles/service.ts
  </files>
  <action>
**File 1: `services/identity-service/src/v2/user-roles/types.ts`**

Update the `UserRoleCreate` interface to make `role_entity_id` optional:

```typescript
export interface UserRoleCreate {
    user_id: string;
    role_name: string;
    role_entity_id?: string | null;  // Required for entity-linked roles (recruiter, candidate), null for system-level roles (platform_admin)
}
```

**File 2: `services/identity-service/src/v2/user-roles/service.ts`**

1. **Update `createUserRole` validation** (around lines 71-81): Replace the blanket `role_entity_id` requirement with conditional validation:

```typescript
// Validate based on role type
const SYSTEM_ROLES = ['platform_admin'];  // System-level roles don't need entity linkage
const isSystemRole = SYSTEM_ROLES.includes(roleData.role_name);

if (!isSystemRole && !roleData.role_entity_id) {
    throw new Error('Role entity ID is required for entity-linked roles');
}
```

2. **Update the insert data** (around lines 83-90): Pass `role_entity_id` as null for platform_admin:

```typescript
const userRole = await this.repository.createUserRole({
    id: uuidv4(),
    user_id: roleData.user_id,
    role_name: roleData.role_name,
    role_entity_id: roleData.role_entity_id || null,  // null for system-level roles
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
});
```

3. **Enrich event payloads for audit** (AUDIT-01):

For `user_role.created` event (around line 92), the current payload already includes `user_id`, `role_name`, and `role_entity_id`. This is sufficient. No change needed.

For `user_role.deleted` event (around line 138), the current payload only includes `user_role_id`. Enrich it with `user_id` and `role_name` for better audit trail:

```typescript
// In deleteUserRole method, after findUserRoleById:
const existingRole = await this.findUserRoleById(clerkUserId, id);
await this.repository.deleteUserRole(id);

await this.eventPublisher.publish('user_role.deleted', {
    user_role_id: id,
    user_id: existingRole.user_id,
    role_name: existingRole.role_name,
    role_entity_id: existingRole.role_entity_id,
});
```

Note: The `deleteUserRole` method already calls `findUserRoleById` on line 135, but stores the result in nothing. Capture it in a variable to use for the enriched event.

4. **Update the function's JSDoc comment** at the top of the class/method to note that platform_admin is now a supported role for this service.

Do NOT change the routes file — the POST handler already passes the body through to the service.
Do NOT change the repository — it already does a raw insert which handles null role_entity_id.
Do NOT change authorization logic — `requirePlatformAdmin` still works correctly because resolveAccessContext reads from memberships (legacy data still there until Phase 6).
  </action>
  <verify>
Run `pnpm --filter @splits-network/identity-service build` to verify TypeScript compilation succeeds. Verify that the type change in UserRoleCreate is compatible with the service's usage.
  </verify>
  <done>
- UserRoleCreate.role_entity_id is optional (`string | null | undefined`)
- createUserRole conditionally validates: requires role_entity_id for entity-linked roles, allows null for platform_admin
- user_role.deleted event enriched with user_id, role_name, role_entity_id for audit
- identity-service builds cleanly
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @splits-network/identity-service build` succeeds
2. UserRoleCreate interface has `role_entity_id?: string | null`
3. createUserRole skips entity_id validation when role_name is 'platform_admin'
4. createUserRole still throws for entity-linked roles without role_entity_id
5. user_role.deleted event payload includes user_id and role_name
6. No changes to routes.ts or repository.ts (they handle nullable fields already)
</verification>

<success_criteria>
- POST /v2/user-roles with `{ user_id, role_name: 'platform_admin' }` (no role_entity_id) creates the row successfully
- POST /v2/user-roles with `{ user_id, role_name: 'recruiter' }` (no role_entity_id) still throws error
- DELETE /v2/user-roles/:id publishes event with user_id and role_name in payload
- identity-service compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-access-integration/05-02-SUMMARY.md`
</output>
