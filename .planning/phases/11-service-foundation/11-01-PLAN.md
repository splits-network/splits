---
phase: 11-service-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared-config/src/index.ts
  - services/gpt-service/package.json
  - services/gpt-service/tsconfig.json
  - services/gpt-service/src/index.ts
  - services/gpt-service/src/v2/shared/events.ts
  - services/gpt-service/src/v2/routes.ts
autonomous: true

must_haves:
  truths:
    - "gpt-service starts on its configured port and responds to /health with status healthy"
    - "GPT OAuth environment variables (GPT_CLIENT_ID, GPT_CLIENT_SECRET, GPT_JWT_SECRET, GPT_REDIRECT_URI, GPT_ACCESS_TOKEN_EXPIRY, GPT_REFRESH_TOKEN_EXPIRY, GPT_AUTH_CODE_EXPIRY) are loaded and validated on startup"
    - "RabbitMQ EventPublisher connects and can publish gpt.oauth.* events"
  artifacts:
    - path: "services/gpt-service/package.json"
      provides: "Service package definition with all dependencies"
      contains: "@splits-network/gpt-service"
    - path: "services/gpt-service/src/index.ts"
      provides: "Service entry point with Fastify server, health check, event publisher, graceful shutdown"
      min_lines: 60
    - path: "services/gpt-service/src/v2/shared/events.ts"
      provides: "EventPublisher for gpt-service (mirrors ats-service pattern)"
      contains: "class EventPublisher"
    - path: "services/gpt-service/src/v2/routes.ts"
      provides: "V2 route registration stub for future OAuth and proxy routes"
      contains: "registerV2Routes"
    - path: "packages/shared-config/src/index.ts"
      provides: "loadGptConfig function for GPT OAuth environment variables"
      contains: "loadGptConfig"
  key_links:
    - from: "services/gpt-service/src/index.ts"
      to: "packages/shared-config/src/index.ts"
      via: "loadGptConfig import"
      pattern: "loadGptConfig"
    - from: "services/gpt-service/src/index.ts"
      to: "services/gpt-service/src/v2/shared/events.ts"
      via: "EventPublisher instantiation"
      pattern: "new.*EventPublisher"
    - from: "services/gpt-service/src/index.ts"
      to: "services/gpt-service/src/v2/routes.ts"
      via: "registerV2Routes call"
      pattern: "registerV2Routes"
---

<objective>
Create the gpt-service microservice scaffold with Fastify server, health check, RabbitMQ EventPublisher, GPT-specific configuration loader, and route registration stub.

Purpose: Establish a running, health-checkable gpt-service that follows the V2 service pattern, ready for OAuth routes and GPT proxy endpoints in subsequent phases.
Output: A functional gpt-service that starts, passes health check, validates GPT env vars, and connects to RabbitMQ.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-service-foundation/11-CONTEXT.md

# Template references (read these for exact patterns to follow)
@services/ats-service/package.json
@services/ats-service/tsconfig.json
@services/ats-service/src/index.ts
@services/ats-service/src/v2/shared/events.ts
@services/ats-service/src/v2/routes.ts
@packages/shared-config/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loadGptConfig to shared-config</name>
  <files>packages/shared-config/src/index.ts</files>
  <action>
Add a GptConfig interface and loadGptConfig() function to shared-config/src/index.ts, following the same pattern as loadClerkConfig, loadStripeConfig, etc.

**GptConfig interface:**
```typescript
export interface GptConfig {
    clientId: string;
    clientSecret: string;
    jwtSecret: string;
    redirectUri: string;
    accessTokenExpiry: number;  // seconds
    refreshTokenExpiry: number; // seconds
    authCodeExpiry: number;     // seconds
}
```

**loadGptConfig function:**
- GPT_CLIENT_ID: required (getEnvOrThrow)
- GPT_CLIENT_SECRET: required (getEnvOrThrow)
- GPT_JWT_SECRET: required (getEnvOrThrow)
- GPT_REDIRECT_URI: required (getEnvOrThrow) -- strict redirect_uri validation depends on this
- GPT_ACCESS_TOKEN_EXPIRY: optional, default "3600" (1 hour), parsed to int
- GPT_REFRESH_TOKEN_EXPIRY: optional, default "2592000" (30 days), parsed to int
- GPT_AUTH_CODE_EXPIRY: optional, default "600" (10 minutes), parsed to int

Place the interface and function AFTER the ResendConfig section, BEFORE the generic loadConfig() at the end of the file.
  </action>
  <verify>Run `pnpm --filter @splits-network/shared-config build` and confirm it compiles without errors.</verify>
  <done>GptConfig interface and loadGptConfig() exported from shared-config, building successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create gpt-service scaffold</name>
  <files>
    services/gpt-service/package.json
    services/gpt-service/tsconfig.json
    services/gpt-service/src/index.ts
    services/gpt-service/src/v2/shared/events.ts
    services/gpt-service/src/v2/routes.ts
  </files>
  <action>
Create the gpt-service directory and files, modeled on ats-service but significantly simpler (no domain consumers, no swagger UI, no Sentry for now).

**package.json** -- model on ats-service/package.json:
- name: "@splits-network/gpt-service"
- scripts: dev (tsx watch), build (tsc -b), start (node dist/index.js), clean
- dependencies: fastify, @fastify/formbody (NEW -- for OAuth token endpoint form-urlencoded bodies), @splits-network/shared-config, @splits-network/shared-logging, @splits-network/shared-fastify, @splits-network/shared-types, @splits-network/shared-access-context, @supabase/supabase-js, amqplib
- devDependencies: tsx, typescript, @types/node, @types/amqplib
- Do NOT include @fastify/swagger, @fastify/swagger-ui, @sentry/node, vitest -- not needed for Phase 11

**tsconfig.json** -- model on ats-service/tsconfig.json:
- extends ../../tsconfig.base.json
- outDir ./dist, rootDir ./src
- references to shared-config, shared-logging, shared-fastify, shared-types, shared-access-context

**src/v2/shared/events.ts** -- copy ats-service/src/v2/shared/events.ts exactly, only change sourceService default to 'gpt-service'.

**src/v2/routes.ts** -- minimal stub:
```typescript
import { FastifyInstance } from 'fastify';
import { EventPublisher } from './shared/events';

interface RegisterConfig {
    supabaseUrl: string;
    supabaseKey: string;
    eventPublisher?: EventPublisher;
}

export function registerV2Routes(app: FastifyInstance, config: RegisterConfig) {
    // OAuth routes will be registered in Phase 12
    // GPT proxy routes will be registered in Phase 13
}
```

**src/index.ts** -- model on ats-service/src/index.ts but simpler:
1. Load configs: loadBaseConfig('gpt-service'), loadDatabaseConfig(), loadRabbitMQConfig(), loadGptConfig()
2. Create logger
3. Build Fastify server (buildServer with cors, disableRequestLogging)
4. Set error handler (errorHandler from shared-fastify)
5. Register @fastify/formbody plugin (for OAuth token endpoint)
6. Initialize EventPublisher, connect (throw on failure like ats-service)
7. Register V2 routes (registerV2Routes)
8. Register /health endpoint using registerHealthCheck from shared-fastify with:
   - serviceName: 'gpt-service'
   - logger
   - checkers: { rabbitmq: async () => check EventPublisher.ensureConnection() }
9. Log loaded GPT config summary (log clientId and redirectUri, NOT secrets) at info level after successful startup
10. Graceful shutdown: SIGTERM handler closes EventPublisher then app
11. Start server on configured port

Key difference from ats-service: NO domain consumer setup (that's Plan 03), NO Swagger, NO Sentry. Keep it minimal.

After creating files, run `pnpm install` from repo root to link the new workspace package.
  </action>
  <verify>
Run `pnpm --filter @splits-network/gpt-service build` and confirm it compiles without errors.
Run `pnpm --filter @splits-network/shared-config build` to confirm shared-config still builds.
  </verify>
  <done>gpt-service package exists with package.json, tsconfig.json, index.ts, events.ts, routes.ts. TypeScript builds without errors. Service would start if env vars were set.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @splits-network/shared-config build` succeeds
2. `pnpm --filter @splits-network/gpt-service build` succeeds
3. services/gpt-service/src/index.ts imports loadGptConfig and calls it on startup
4. services/gpt-service/src/index.ts initializes EventPublisher with 'gpt-service' source
5. services/gpt-service/src/index.ts registers /health endpoint
6. services/gpt-service/src/index.ts registers @fastify/formbody plugin
7. services/gpt-service/src/v2/routes.ts exports registerV2Routes
</verification>

<success_criteria>
- shared-config exports GptConfig interface and loadGptConfig function
- gpt-service builds without TypeScript errors
- Service entry point follows V2 pattern: config -> logger -> server -> plugins -> events -> routes -> health -> listen
- @fastify/formbody is the only new dependency (not already in the monorepo)
</success_criteria>

<output>
After completion, create `.planning/phases/11-service-foundation/11-01-SUMMARY.md`
</output>
