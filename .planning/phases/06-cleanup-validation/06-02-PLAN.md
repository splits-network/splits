---
phase: 06-cleanup-validation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Platform admin user can access admin routes in frontend after platform org deletion"
    - "resolveAccessContext returns isPlatformAdmin=true for test admin after legacy data removed"
    - "No errors in console or logs related to missing platform organization"
  artifacts: []
  key_links:
    - from: "resolveAccessContext"
      to: "user_roles table"
      via: "platform_admin query (no longer needs memberships)"
      pattern: "isPlatformAdmin.*true"
---

<objective>
Verify the entire platform admin flow still works after the cleanup migration removes the synthetic platform organization and legacy memberships.

Purpose: Success criteria 3 and 4 from the Phase 6 roadmap require runtime verification that platform admin authorization survived the cleanup. This cannot be automated â€” it requires the user to apply the migration to their database and test the running application.

Output: Verified system health, no artifacts created.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cleanup-validation/06-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Apply cleanup migration to database</name>
  <action>
The user must apply the migration created in 06-01 to their Supabase database.
  </action>
  <instructions>
Apply the cleanup migration to your Supabase database:

1. Navigate to your Supabase project dashboard
2. Open the SQL Editor
3. Paste the contents of `supabase/migrations/20260216000001_remove_platform_organization.sql`
4. Execute the migration

Expected result:
- Pre-flight check passes (platform_admin rows exist in user_roles)
- Platform_admin memberships are deleted
- Platform organization is deleted
- No FK violation errors

If you see "No platform_admin rows found in user_roles", the Phase 4 migration has not been applied yet. Apply that first.
  </instructions>
  <resume-signal>Type "migration applied" to continue, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete platform admin restructure: platform_admin now lives exclusively in user_roles, synthetic platform organization removed, all types updated</what-built>
  <how-to-verify>
**Backend smoke test (resolveAccessContext):**
1. Start the API gateway: `pnpm --filter @splits-network/api-gateway dev`
2. Start the identity service: `pnpm --filter @splits-network/identity-service dev`
3. Make an authenticated API call as a platform admin user
4. Verify the response includes admin-level data (not a 403)

**Frontend smoke test (admin routes):**
1. Start the portal: `pnpm --filter @splits-network/portal dev`
2. Log in as a platform admin user
3. Navigate to `/portal/admin` (or any admin-only route)
4. Verify the admin dashboard loads without errors
5. Check browser console for any errors related to organizations or memberships

**What to look for:**
- Admin pages load normally (no "Access Denied" or blank pages)
- No console errors about missing organizations or FK violations
- Platform admin badge/indicator still shows in the UI (if applicable)
- Navigation to admin sections works as before
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
1. Migration applied without errors
2. Platform admin can access admin routes in frontend
3. resolveAccessContext returns correct isPlatformAdmin flag
4. No console/log errors related to the cleanup
</verification>

<success_criteria>
- User confirms migration applied successfully (no FK violations)
- User confirms platform admin frontend access works
- User confirms no errors in console or service logs
- All Phase 6 success criteria from roadmap are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-cleanup-validation/06-02-SUMMARY.md`
</output>
