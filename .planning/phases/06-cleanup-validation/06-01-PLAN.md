---
phase: 06-cleanup-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_remove_platform_organization.sql
  - packages/shared-access-context/src/index.ts
  - packages/shared-types/src/models.ts
  - packages/shared-clients/src/identity-client.ts
autonomous: true

must_haves:
  truths:
    - "Platform admin memberships deleted from memberships table"
    - "Platform organization (type='platform') deleted from organizations table"
    - "No foreign key violations during deletion"
    - "resolveAccessContext JSDoc reflects post-migration state"
    - "TypeScript types no longer reference 'platform' as an organization type"
  artifacts:
    - path: "supabase/migrations/20260216000001_remove_platform_organization.sql"
      provides: "Cleanup migration removing platform org and legacy memberships"
      min_lines: 30
    - path: "packages/shared-access-context/src/index.ts"
      provides: "Updated JSDoc without dual-read migration notes"
      contains: "user_roles: entity-linked roles"
    - path: "packages/shared-types/src/models.ts"
      provides: "Organization.type without 'platform'"
      contains: "'company' | 'recruiter'"
    - path: "packages/shared-clients/src/identity-client.ts"
      provides: "createOrganization type without 'platform'"
      contains: "type: 'company'"
  key_links:
    - from: "supabase/migrations/20260216000001_remove_platform_organization.sql"
      to: "memberships table"
      via: "DELETE WHERE organization_id references platform org"
      pattern: "DELETE FROM.*memberships"
    - from: "supabase/migrations/20260216000001_remove_platform_organization.sql"
      to: "organizations table"
      via: "DELETE WHERE type = 'platform'"
      pattern: "DELETE FROM.*organizations"
---

<objective>
Remove the synthetic platform organization and all legacy platform_admin memberships via SQL migration, then clean up TypeScript types and JSDoc that referenced the platform org type.

Purpose: Complete AUDIT-02 requirement. After Phase 4 migrated platform_admin data to user_roles and Phase 5 updated the access layer, the legacy platform organization and its memberships are dead weight. Removing them eliminates synthetic data from the system.

Output: One SQL migration file, three updated TypeScript files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-schema-data-migration/04-01-SUMMARY.md
@.planning/phases/05-access-integration/05-01-SUMMARY.md

Key files to modify:
@packages/shared-access-context/src/index.ts
@packages/shared-types/src/models.ts
@packages/shared-clients/src/identity-client.ts

Reference migration for style:
@supabase/migrations/20260215000001_platform_admin_to_user_roles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cleanup migration to remove platform organization and legacy memberships</name>
  <files>supabase/migrations/20260216000001_remove_platform_organization.sql</files>
  <action>
Create a SQL migration file that performs these steps IN ORDER (FK-safe deletion sequence):

**Step 1: Pre-flight validation** — Use a DO block to count platform_admin rows in user_roles. If count is 0, RAISE EXCEPTION with message "No platform_admin rows found in user_roles — refusing to delete legacy data before migration is confirmed". This prevents accidentally deleting the only source of platform_admin if Phase 4 migration hasn't been applied.

**Step 2: Soft-delete platform_admin memberships** — Set deleted_at = now() on all memberships rows WHERE role_name = 'platform_admin' AND deleted_at IS NULL. Use soft-delete (not hard delete) to match the codebase pattern — all queries filter on deleted_at IS NULL.

**Step 3: Hard-delete the platform organization** — DELETE FROM organizations WHERE type = 'platform'. Before deleting, verify no non-deleted memberships reference this org (SELECT COUNT(*) FROM memberships WHERE organization_id IN (SELECT id FROM organizations WHERE type = 'platform') AND deleted_at IS NULL). If count > 0, RAISE EXCEPTION. The soft-deleted platform_admin memberships from Step 2 won't block this because they have deleted_at set. Also check invitations, companies, and teams tables for FK references to the platform org — if any exist, RAISE EXCEPTION with details.

IMPORTANT: The memberships FK to organizations is NOT a cascade delete. We must handle deletion order manually. The soft-deleted membership rows still have organization_id pointing to the org, but since we're hard-deleting the org, we need to also hard-delete the soft-deleted platform memberships first:
- First: Hard DELETE memberships WHERE organization_id IN (SELECT id FROM organizations WHERE type = 'platform') — this removes ALL membership rows (including the ones we just soft-deleted) referencing the platform org
- Then: DELETE FROM organizations WHERE type = 'platform'

**Step 4: Update organizations_type_check constraint** — Drop the existing CHECK constraint and recreate it without 'platform':
```sql
ALTER TABLE public.organizations DROP CONSTRAINT organizations_type_check;
ALTER TABLE public.organizations ADD CONSTRAINT organizations_type_check
    CHECK (type = ANY (ARRAY['company'::text]));
```
Note: Only 'company' remains because 'recruiter' is not in the DB constraint (only in TypeScript types).

**Step 5: Update table comments** — Add comment on memberships table noting platform_admin is no longer org-scoped:
```sql
COMMENT ON TABLE public.memberships IS 'Org-scoped role assignments (company_admin, hiring_manager). Platform admin is in user_roles, not here.';
```

**Step 6: Rollback documentation** — Include commented-out rollback SQL at the end (matching Phase 4 migration style):
- Re-insert platform organization: INSERT INTO organizations (id, name, type) VALUES ('{saved_id}', 'Splits Network', 'platform')
- Restore CHECK constraint with 'platform' included
- Note: membership data cannot be automatically restored (one-way cleanup)

Follow the same documentation/comment style as the Phase 4 migration (20260215000001).
  </action>
  <verify>
Read the migration file and verify:
1. Pre-flight check exists (platform_admin must be in user_roles)
2. Memberships are hard-deleted before organization (FK-safe order)
3. Organizations WHERE type = 'platform' are deleted
4. CHECK constraint updated to exclude 'platform'
5. Rollback SQL is documented in comments
  </verify>
  <done>Migration file exists at supabase/migrations/20260216000001_remove_platform_organization.sql with FK-safe deletion sequence and rollback documentation</done>
</task>

<task type="auto">
  <name>Task 2: Clean up TypeScript types and JSDoc referencing platform organization type</name>
  <files>
    packages/shared-access-context/src/index.ts
    packages/shared-types/src/models.ts
    packages/shared-clients/src/identity-client.ts
  </files>
  <action>
**shared-access-context/src/index.ts** — Update the JSDoc comment on resolveAccessContext (lines 58-68):
- Remove the "During migration period (v3.0 Phase 5-6)" paragraph entirely
- Update the second bullet to read: `user_roles: entity-linked roles (recruiter, candidate) with role_entity_id, and system-level roles (platform_admin) with role_entity_id = NULL`
- The code itself does NOT change — only the JSDoc comment

**shared-types/src/models.ts** — Update the Organization interface (line 110):
- Change `type: 'company' | 'platform' | 'recruiter'` to `type: 'company' | 'recruiter'`
- 'recruiter' stays because it exists as a TS type even though the DB constraint only has 'company'

**shared-clients/src/identity-client.ts** — Update createOrganization method (line 36):
- Change `type: 'company' | 'platform'` to `type: 'company'`
- Update the comment on line 54 from "Membership endpoints (org-scoped: company_admin, hiring_manager, platform_admin)" to "Membership endpoints (org-scoped: company_admin, hiring_manager)"

After all changes, run `pnpm --filter @splits-network/shared-access-context build && pnpm --filter @splits-network/shared-types build && pnpm --filter @splits-network/shared-clients build` to verify no type errors.
  </action>
  <verify>
Run build commands:
```
pnpm --filter @splits-network/shared-access-context build
pnpm --filter @splits-network/shared-types build
pnpm --filter @splits-network/shared-clients build
```
All three must compile successfully with zero errors.
  </verify>
  <done>JSDoc updated to reflect post-migration state, Organization.type no longer includes 'platform', identity-client createOrganization only accepts 'company', all packages build cleanly</done>
</task>

</tasks>

<verification>
1. Migration file exists and follows FK-safe deletion order
2. All three TypeScript packages build without errors
3. No references to 'platform' as an organization type remain in modified files
4. resolveAccessContext JSDoc no longer mentions migration period
</verification>

<success_criteria>
- supabase/migrations/20260216000001_remove_platform_organization.sql exists with pre-flight validation, FK-safe deletion, constraint update, and rollback docs
- shared-access-context, shared-types, and shared-clients all build cleanly
- Organization.type in shared-types excludes 'platform'
- identity-client createOrganization only accepts 'company'
- resolveAccessContext JSDoc is clean (no migration period references)
</success_criteria>

<output>
After completion, create `.planning/phases/06-cleanup-validation/06-01-SUMMARY.md`
</output>
