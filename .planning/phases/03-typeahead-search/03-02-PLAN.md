---
phase: 03-typeahead-search
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/portal/src/components/global-search/global-search-bar.tsx
  - apps/portal/src/components/global-search/search-result-item.tsx
  - apps/portal/src/components/global-search/index.ts
  - apps/portal/src/components/portal-header.tsx
autonomous: false

must_haves:
  truths:
    - "User can type in search bar in portal header and see dropdown with results grouped by entity type"
    - "Dropdown shows top 5 results per entity type with icon, title, subtitle, and highlighted matching terms"
    - "User can navigate results with arrow keys, select with Enter, and close with Esc"
    - "Cmd+K (Mac) or Ctrl+K (Windows) focuses search bar from any page"
    - "Clicking any result navigates to that entity's detail page"
    - "Recent searches (last 5) appear in dropdown when input is empty and focused"
    - "Loading spinner shows while searching and empty state message shows when no results found"
    - "Clear button (X) resets search input and closes dropdown"
  artifacts:
    - path: "apps/portal/src/components/global-search/global-search-bar.tsx"
      provides: "Main search bar component with dropdown, keyboard navigation, and result display"
      exports: ["GlobalSearchBar"]
    - path: "apps/portal/src/components/global-search/search-result-item.tsx"
      provides: "Individual search result row with icon, title highlight, subtitle"
      exports: ["SearchResultItem"]
    - path: "apps/portal/src/components/global-search/index.ts"
      provides: "Barrel export for global search components"
      exports: ["GlobalSearchBar"]
    - path: "apps/portal/src/components/portal-header.tsx"
      provides: "Updated header with GlobalSearchBar integrated"
      contains: "GlobalSearchBar"
  key_links:
    - from: "apps/portal/src/components/global-search/global-search-bar.tsx"
      to: "apps/portal/src/hooks/use-global-search.ts"
      via: "useGlobalSearch() hook"
      pattern: "useGlobalSearch"
    - from: "apps/portal/src/components/global-search/global-search-bar.tsx"
      to: "next/navigation"
      via: "useRouter().push(getEntityUrl(...))"
      pattern: "router\\.push"
    - from: "apps/portal/src/components/portal-header.tsx"
      to: "apps/portal/src/components/global-search/global-search-bar.tsx"
      via: "import and render GlobalSearchBar"
      pattern: "GlobalSearchBar"
---

<objective>
Build the GlobalSearchBar UI component and integrate it into the portal header.

Purpose: This is the user-facing typeahead search experience. It renders the search input in the header, displays grouped results in a dropdown, handles keyboard navigation (arrow keys, Enter, Esc, Cmd+K), highlights matching terms, shows recent searches, and navigates to entity detail pages on selection.

Output: `global-search/` component directory and updated `portal-header.tsx`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-typeahead-search/03-01-SUMMARY.md

Key codebase references:
@apps/portal/src/components/portal-header.tsx      (integration point - search bar goes in the header)
@apps/portal/src/components/notification-bell.tsx   (dropdown pattern reference - DaisyUI dropdown with focus/blur)
@apps/portal/src/components/standard-lists/search-input.tsx (existing SearchInput for per-list search - pattern reference)
@apps/portal/src/types/search.ts                   (types from Plan 01)
@apps/portal/src/hooks/use-global-search.ts        (hook from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlobalSearchBar component with dropdown and keyboard navigation</name>
  <files>
    apps/portal/src/components/global-search/search-result-item.tsx
    apps/portal/src/components/global-search/global-search-bar.tsx
    apps/portal/src/components/global-search/index.ts
  </files>
  <action>
**1. Create `apps/portal/src/components/global-search/search-result-item.tsx`**

A presentational component for a single search result row:

Props:
- `result: SearchResult` - the search result data
- `query: string` - current search query (for highlight)
- `isActive: boolean` - whether this item is keyboard-focused
- `onClick: () => void` - click handler

Rendering:
- Left: entity type icon from `ENTITY_TYPE_CONFIG[result.entity_type].icon` (FontAwesome duotone, small circle background)
- Center: title with highlighted matching terms (bold the substring matching the query, case-insensitive). Subtitle below in muted text (result.subtitle). Use `<mark>` or `<strong>` tags for highlights.
- Right: no action needed (clean presentation)
- Active state: `bg-base-200` when `isActive` is true
- Cursor pointer, hover state `hover:bg-base-200`

**Highlight function:** Create a `highlightMatch(text: string, query: string): React.ReactNode` helper that splits text on query match boundaries and wraps matches in `<mark className="bg-warning/30 text-inherit">`. Handle case-insensitive matching. If query is empty, return text as-is.

**2. Create `apps/portal/src/components/global-search/global-search-bar.tsx`**

The main component. Uses `useGlobalSearch()` hook and `useRouter()` from `next/navigation`.

**Layout:**
- Render inside the header's middle section (replacing or alongside the page title area)
- Input field with search icon (fa-magnifying-glass), placeholder "Search... (Cmd+K)"
- Positioned as a relative container; dropdown is absolute below
- Use DaisyUI `input` class with a search icon prefix
- On small screens, show a compact search icon button that expands; on lg+, show the full input. (Use responsive classes: hidden on mobile, visible on lg+, with a btn-square toggle for mobile.)

**Dropdown (absolute positioned below input):**
- Only visible when `isOpen` is true AND (has results OR has recent searches OR isLoading OR isEmpty)
- Max height: `max-h-96 overflow-y-auto`
- Background: `bg-base-100 shadow-lg border border-base-300 rounded-box`
- Z-index: `z-50` (above content but portal header is z-40)
- Width: matches input width or at least `w-96`

**Dropdown content sections:**

A) **Loading state (TYPE-04):** When `isLoading` is true, show a centered spinner: `<span className="loading loading-spinner loading-sm"></span>` with text "Searching..."

B) **Results (TYPE-01, TYPE-02, TYPE-05, TYPE-06):** When `groups.length > 0`:
   - For each group: show a sticky group header with entity type icon + label + result count in parentheses (e.g., "Candidates (3)")
   - Below header: render each result using `SearchResultItem`
   - Group header styling: `text-xs font-semibold uppercase tracking-wider text-base-content/60 px-3 py-1.5 bg-base-100 sticky top-0`

C) **Empty state (TYPE-04):** When `isEmpty` is true (query exists, not loading, no results):
   - Show message: "No results found for '{query}'"
   - Muted icon (fa-search with slash or fa-face-thinking) and text

D) **Recent searches (INT-02):** When query is empty and `recentSearches.length > 0`:
   - Header: "Recent Searches" with a "Clear" button
   - List of recent searches as clickable items with a clock icon (fa-clock-rotate-left)
   - Clicking a recent search sets it as the query

**Keyboard navigation (TYPE-03, INT-01):**
- Maintain a `activeIndex` state (number, -1 means nothing selected)
- Flatten all results from all groups into a single list for arrow key navigation
- `ArrowDown`: increment activeIndex (wrap to 0 at end)
- `ArrowUp`: decrement activeIndex (wrap to end at 0)
- `Enter`: if activeIndex >= 0, navigate to selected result via `router.push(getEntityUrl(...))`, call `addRecentSearch(query)`, close dropdown. If activeIndex is -1, do nothing (Phase 4 will add navigation to full search page).
- `Escape`: close dropdown, blur input
- Reset `activeIndex` to -1 when groups change (new results arrived)

**Cmd+K shortcut (INT-01):**
- Add a `useEffect` that listens for `keydown` on `document`
- If `(event.metaKey || event.ctrlKey) && event.key === 'k'`, prevent default and focus the input ref
- Cleanup listener on unmount

**Clear button (TYPE-08):**
- Show an X button (`fa-times`) on the right side of the input when query is non-empty
- On click: call `clearQuery()`, close dropdown

**Click outside to close:**
- Use a ref on the container div
- `useEffect` with `mousedown` listener on document: if click target is not inside container ref, close dropdown

**Result click (TYPE-07):**
- On clicking a SearchResultItem: `router.push(getEntityUrl(result.entity_type, result.entity_id))`, `addRecentSearch(query)`, `setIsOpen(false)`, `clearQuery()`

**3. Create `apps/portal/src/components/global-search/index.ts`**

Barrel export:
```typescript
export { GlobalSearchBar } from './global-search-bar';
```
  </action>
  <verify>
    - All three files exist in `apps/portal/src/components/global-search/`
    - `GlobalSearchBar` imports and uses `useGlobalSearch` hook
    - Keyboard event listeners for ArrowUp/ArrowDown/Enter/Escape are implemented
    - Cmd+K / Ctrl+K global shortcut is registered in a useEffect
    - Click-outside-to-close pattern uses ref + mousedown listener
    - highlightMatch function handles case-insensitive matching
    - Recent searches section renders when query is empty
    - TypeScript compiles without errors
  </verify>
  <done>
    GlobalSearchBar component renders search input with dropdown showing grouped results, keyboard navigation, highlighted matches, recent searches, loading/empty states, clear button, and click-outside-to-close behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate GlobalSearchBar into portal header</name>
  <files>
    apps/portal/src/components/portal-header.tsx
  </files>
  <action>
Modify `apps/portal/src/components/portal-header.tsx` to include the GlobalSearchBar.

**Changes:**
1. Add import: `import { GlobalSearchBar } from '@/components/global-search';`

2. Insert GlobalSearchBar in the header's middle section. Currently the middle section shows page title:
```tsx
<div className="flex-1 ml-0 lg:pl-40 min-w-0 px-2">
  {title && (...)}
</div>
```

Replace this with a layout that shows the search bar. The search bar should take center position in the header, with the page title moving to a secondary position or sharing space:

```tsx
{/* Search bar - centered in header */}
<div className="flex-1 ml-0 lg:pl-40 min-w-0 px-2 flex items-center gap-4">
  {/* Page title (hidden on smaller screens when search is prominent) */}
  {title && (
    <div className="hidden xl:flex flex-col items-start gap-0 shrink-0 max-w-xs">
      <h1 className="text-base font-semibold truncate w-full">{title}</h1>
      {subtitle && (
        <span className="text-xs text-base-content/60 truncate w-full">{subtitle}</span>
      )}
    </div>
  )}
  {/* Global search */}
  <div className="flex-1 max-w-lg">
    <GlobalSearchBar />
  </div>
</div>
```

This positions the search bar in the header's center area, giving it prominent placement while keeping the page title visible on wider screens.

**Do NOT modify the user controls section** (theme toggle, notification bell, user dropdown) - those stay as-is on the right.
  </action>
  <verify>
    - `portal-header.tsx` imports GlobalSearchBar from `@/components/global-search`
    - GlobalSearchBar is rendered in the header's main section
    - Page title still visible on xl screens
    - Build succeeds: `pnpm --filter @splits-network/portal build` (or at minimum TypeScript compiles)
  </verify>
  <done>
    GlobalSearchBar is visible in the portal header. Users can see the search input at the top of every authenticated page.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete typeahead search system:
    1. useGlobalSearch hook with debounced API calls, recent searches, entity URL resolver
    2. GlobalSearchBar component with dropdown, grouped results, keyboard navigation, highlighted matches
    3. Header integration with search bar prominently placed

    Requirements covered: TYPE-01 (typeahead dropdown), TYPE-02 (grouped results), TYPE-03 (keyboard nav), TYPE-04 (loading/empty states), TYPE-05 (highlighted matches), TYPE-06 (context snippets), TYPE-07 (click-to-navigate), TYPE-08 (clear button), INT-01 (Cmd+K shortcut), INT-02 (recent searches)
  </what-built>
  <how-to-verify>
    1. Start the portal: `pnpm --filter @splits-network/portal dev`
    2. Start api-gateway and search-service (or confirm they're running)
    3. Navigate to any portal page (e.g., /portal/dashboard)
    4. Verify search bar is visible in the header
    5. Type a query (e.g., "john") - verify dropdown appears with grouped results
    6. Verify results show icons, titles with bold matching text, and subtitles
    7. Press ArrowDown/ArrowUp - verify keyboard navigation highlights items
    8. Press Enter on a highlighted result - verify navigation to detail page
    9. Press Escape - verify dropdown closes
    10. Press Cmd+K (Mac) or Ctrl+K (Windows) - verify search bar focuses
    11. Click the X button - verify search clears
    12. Clear search and focus input - verify recent searches appear
    13. Click a recent search - verify it populates the query
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. GlobalSearchBar renders in portal header on all authenticated pages
2. Typing a query shows grouped dropdown results from API
3. Arrow keys navigate between results, Enter selects, Esc closes
4. Cmd+K / Ctrl+K focuses the search bar globally
5. Clicking a result navigates to the entity's detail page
6. Recent searches persist across page reloads
7. Loading spinner shown during API call, empty state when no results
8. Clear button resets search and closes dropdown
9. All 10 requirements (TYPE-01 through TYPE-08, INT-01, INT-02) satisfied
</verification>

<success_criteria>
- User can search from any portal page and navigate to results
- Keyboard navigation works end-to-end (Cmd+K, arrows, Enter, Esc)
- Recent searches stored and displayed
- Highlighted matching terms visible in results
- No console errors, TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-typeahead-search/03-02-SUMMARY.md`
</output>
