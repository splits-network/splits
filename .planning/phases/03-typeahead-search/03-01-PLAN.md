---
phase: 03-typeahead-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/portal/src/types/search.ts
  - apps/portal/src/hooks/use-global-search.ts
autonomous: true

must_haves:
  truths:
    - "useGlobalSearch hook calls GET /api/v2/search?mode=typeahead with debounced query"
    - "Hook returns grouped results (TypeaheadGroup[]) with loading, error, and empty states"
    - "Recent searches persist in localStorage and are returned when query is empty"
    - "Hook provides entity URL resolver mapping entity_type+entity_id to portal routes"
  artifacts:
    - path: "apps/portal/src/types/search.ts"
      provides: "Frontend search types mirroring search-service API contract"
      contains: "SearchResult"
    - path: "apps/portal/src/hooks/use-global-search.ts"
      provides: "Global search hook with debounced API, recent searches, entity routing"
      exports: ["useGlobalSearch"]
  key_links:
    - from: "apps/portal/src/hooks/use-global-search.ts"
      to: "/api/v2/search"
      via: "createAuthenticatedClient().get('/search', { params: { q, mode: 'typeahead' } })"
      pattern: "client\\.get.*search.*typeahead"
    - from: "apps/portal/src/hooks/use-global-search.ts"
      to: "localStorage"
      via: "getItem/setItem for recent searches"
      pattern: "localStorage\\.getItem.*recent.search"
---

<objective>
Create the useGlobalSearch hook and search types for the portal typeahead feature.

Purpose: This is the data layer for global search. The hook encapsulates all search API interaction, debouncing, state management, recent searches persistence, and entity-to-URL routing. The UI component (Plan 02) consumes this hook.

Output: `use-global-search.ts` hook and `search.ts` types file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-search-api/02-02-SUMMARY.md

Key codebase references:
@services/search-service/src/v2/search/types.ts  (API types: SearchResult, TypeaheadGroup, SearchableEntityType)
@apps/portal/src/hooks/use-debounce.ts            (existing useDebouncedCallback hook)
@apps/portal/src/lib/api-client.ts                (createAuthenticatedClient pattern)
@apps/portal/src/hooks/use-standard-list.ts        (auth/fetch pattern with getToken)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search types and useGlobalSearch hook</name>
  <files>
    apps/portal/src/types/search.ts
    apps/portal/src/hooks/use-global-search.ts
  </files>
  <action>
**1. Create `apps/portal/src/types/search.ts`**

Define frontend types mirroring the search-service API contract:

```typescript
export type SearchableEntityType =
  | 'candidate' | 'job' | 'company' | 'recruiter'
  | 'application' | 'placement' | 'recruiter_candidate';

export interface SearchResult {
  entity_type: SearchableEntityType;
  entity_id: string;
  title: string;
  subtitle: string;
  context: string;
  metadata: Record<string, any>;
  rank: number;
}

export interface TypeaheadGroup {
  entity_type: SearchableEntityType;
  label: string;
  results: SearchResult[];
}

export interface TypeaheadResponse {
  groups: TypeaheadGroup[];
}
```

Also add an `ENTITY_TYPE_CONFIG` map that provides for each entity type:
- `label` (plural display name: "Candidates", "Jobs", etc.)
- `icon` (FontAwesome class: "fa-user", "fa-briefcase", "fa-building", "fa-id-badge", "fa-file-lines", "fa-handshake", "fa-people-arrows")
- `routePrefix` (portal route: "/portal/candidates", "/portal/roles", "/portal/companies", "/portal/marketplace/recruiters", "/portal/applications", "/portal/placements", "/portal/candidates" for recruiter_candidate)
- A helper function `getEntityUrl(entity_type, entity_id): string` that returns the full URL.

**Note on routing:** Jobs are displayed at `/portal/roles/:id` (not `/portal/jobs/:id`). Recruiters are at `/portal/marketplace/recruiters` (list only, no detail view - omit entity_id). Recruiter candidates map to `/portal/candidates/:id`.

**2. Create `apps/portal/src/hooks/use-global-search.ts`**

Build a `useGlobalSearch()` hook that returns:

```typescript
interface UseGlobalSearchReturn {
  // Input state
  query: string;
  setQuery: (q: string) => void;
  clearQuery: () => void;

  // Results
  groups: TypeaheadGroup[];
  hasResults: boolean;
  isEmpty: boolean;  // true when query exists but no results

  // States
  isLoading: boolean;
  isOpen: boolean;
  setIsOpen: (open: boolean) => void;

  // Recent searches
  recentSearches: string[];
  addRecentSearch: (query: string) => void;
  clearRecentSearches: () => void;

  // Navigation
  getEntityUrl: (entityType: SearchableEntityType, entityId: string) => string;
}
```

Implementation details:
- **Debounce:** Use 250ms debounce on query changes before calling API (slightly faster than standard list's 300ms for snappier typeahead feel). Use `useRef` with `setTimeout`/`clearTimeout` pattern (same as use-standard-list.ts debounce approach).
- **API call:** When debounced query is >= 2 chars, call `createAuthenticatedClient(token).get('/search', { params: { q: debouncedQuery, mode: 'typeahead' } })`. Response shape is `{ data: { groups: TypeaheadGroup[] } }`.
- **Auth:** Use `useAuth()` from `@clerk/nextjs` to get `getToken`. Call `getToken()` inside the fetch function. Do NOT put `getToken` in dependency arrays (per MEMORY.md infinite loop fix).
- **Empty query:** When query is empty or < 2 chars, clear results and show recent searches.
- **Recent searches (INT-02):** Store in localStorage key `'splits:recent-searches'`. Max 5 entries, deduplicated, newest first. Add a search when user selects a result (via `addRecentSearch`). Provide `recentSearches` array and `clearRecentSearches()`.
- **isOpen state:** Managed by hook, UI component calls `setIsOpen(true)` on focus/type and `setIsOpen(false)` on blur/escape.
- **Error handling:** On API error, log to console and set groups to empty (don't show error to user for typeahead - graceful degradation).
- **Cleanup:** Clear timeout on unmount.
- **AbortController:** Use AbortController to cancel in-flight requests when query changes. This prevents stale results from appearing.
  </action>
  <verify>
    - File `apps/portal/src/types/search.ts` exists and exports `SearchResult`, `TypeaheadGroup`, `TypeaheadResponse`, `SearchableEntityType`, `ENTITY_TYPE_CONFIG`, `getEntityUrl`
    - File `apps/portal/src/hooks/use-global-search.ts` exists and exports `useGlobalSearch`
    - `getEntityUrl('job', '123')` returns `/portal/roles/123`
    - `getEntityUrl('candidate', '456')` returns `/portal/candidates/456`
    - `getEntityUrl('recruiter_candidate', '789')` returns `/portal/candidates/789`
    - Hook uses `createAuthenticatedClient` pattern from `@/lib/api-client`
    - Hook does NOT include `getToken` in any dependency array
    - TypeScript compiles: `npx tsc --noEmit --project apps/portal/tsconfig.json` (or verify no type errors in the new files)
  </verify>
  <done>
    useGlobalSearch hook exists with debounced API call to /search?mode=typeahead, recent searches in localStorage, entity URL resolver, and proper AbortController cleanup. Types mirror search-service API contract exactly.
  </done>
</task>

</tasks>

<verification>
1. Both files exist and export expected types/hook
2. getEntityUrl correctly maps all 7 entity types to portal routes
3. Hook uses 250ms debounce, AbortController, and localStorage for recent searches
4. No `getToken` in dependency arrays
5. TypeScript compiles without errors
</verification>

<success_criteria>
- useGlobalSearch hook ready for consumption by GlobalSearchBar component
- All 7 entity types have correct URL mappings
- Recent searches stored/retrieved from localStorage
- Debounced API calls with AbortController for request cancellation
</success_criteria>

<output>
After completion, create `.planning/phases/03-typeahead-search/03-01-SUMMARY.md`
</output>
