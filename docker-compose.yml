services:
  # Infrastructure Services
  redis:
    image: redis:7-alpine
    container_name: splits-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - splits-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: splits-rabbitmq
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: splits
      RABBITMQ_DEFAULT_PASS: splits_local_dev
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - splits-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend Services
  identity-service:
    build:
      context: .
      dockerfile: services/identity-service/Dockerfile
      target: development
    container_name: splits-identity-service
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
    volumes:
      - ./services/identity-service/src:/app/services/identity-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  ats-service:
    build:
      context: .
      dockerfile: services/ats-service/Dockerfile
      target: development
    container_name: splits-ats-service
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      ENCRYPTION_SECRET: ${ENCRYPTION_SECRET:-default-encryption-secret-change-me}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-3.5-turbo}
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY:-dev_internal_service_key_change_in_production}
    volumes:
      - ./services/ats-service/src:/app/services/ats-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  ats-sync-worker:
    build:
      context: .
      dockerfile: services/ats-service/Dockerfile
      target: development
    container_name: splits-ats-sync-worker
    command: ["pnpm", "--filter", "@splits-network/ats-service", "dev:worker"]
    environment:
      NODE_ENV: development
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      ENCRYPTION_SECRET: ${ENCRYPTION_SECRET:-default-encryption-secret-change-me}
      SYNC_POLL_INTERVAL: "5000"
      SYNC_BATCH_SIZE: "10"
      SYNC_MAX_CONCURRENT: "5"
    volumes:
      - ./services/ats-service/src:/app/services/ats-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  network-service:
    build:
      context: .
      dockerfile: services/network-service/Dockerfile
      target: development
    container_name: splits-network-service
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: development
      PORT: 3003
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
    volumes:
      - ./services/network-service/src:/app/services/network-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
  billing-service:
    build:
      context: .
      dockerfile: services/billing-service/Dockerfile
      target: development
    container_name: splits-billing-service
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: development
      PORT: 3004
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
    volumes:
      - ./services/billing-service/src:/app/services/billing-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
      target: development
    container_name: splits-notification-service
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: development
      PORT: 3005
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      RESEND_API_KEY: ${RESEND_API_KEY}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-noreply@updates.splits.network}
      IDENTITY_SERVICE_URL: http://identity-service:3001
      ATS_SERVICE_URL: http://ats-service:3002
      NETWORK_SERVICE_URL: http://network-service:3003
      CANDIDATE_WEBSITE_URL: http://candidate:3101
      PORTAL_URL: http://portal:3100
      STATUS_CONTACT_RECIPIENTS: ${STATUS_CONTACT_RECIPIENTS:-help@applicant.network,help@splits.network,help@employment-networks.com}
    volumes:
      - ./services/notification-service/src:/app/services/notification-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  chat-service:
    build:
      context: .
      dockerfile: services/chat-service/Dockerfile
      target: development
    container_name: splits-chat-service
    ports:
      - "3011:3011"
    environment:
      NODE_ENV: development
      PORT: 3011
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CHAT_ATTACHMENTS_BUCKET: chat-attachments
      CHAT_ATTACHMENTS_ENABLED: "false"
    volumes:
      - ./services/chat-service/src:/app/services/chat-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  chat-attachment-worker:
    build:
      context: .
      dockerfile: services/chat-service/Dockerfile
      target: development
    container_name: splits-chat-attachment-worker
    command:
      [
        "pnpm",
        "--filter",
        "@splits-network/chat-service",
        "job:chat-attachments",
      ]
    environment:
      NODE_ENV: development
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CHAT_ATTACHMENTS_BUCKET: chat-attachments
    volumes:
      - ./services/chat-service/src:/app/services/chat-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  chat-retention-job:
    build:
      context: .
      dockerfile: services/chat-service/Dockerfile
      target: development
    container_name: splits-chat-retention-job
    command:
      ["pnpm", "--filter", "@splits-network/chat-service", "job:chat-retention"]
    environment:
      NODE_ENV: development
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CHAT_ATTACHMENTS_BUCKET: chat-attachments
    volumes:
      - ./services/chat-service/src:/app/services/chat-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy

  chat-moderation-worker:
    build:
      context: .
      dockerfile: services/chat-service/Dockerfile
      target: development
    container_name: splits-chat-moderation-worker
    command:
      [
        "pnpm",
        "--filter",
        "@splits-network/chat-service",
        "job:chat-moderation",
      ]
    environment:
      NODE_ENV: development
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CHAT_MODERATION_WINDOW_SECONDS: "60"
      CHAT_MODERATION_THRESHOLD: "5"
    volumes:
      - ./services/chat-service/src:/app/services/chat-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  chat-gateway:
    build:
      context: .
      dockerfile: services/chat-gateway/Dockerfile
      target: development
    container_name: splits-chat-gateway
    ports:
      - "3020:3020"
    environment:
      NODE_ENV: development
      PORT: 3020
      REDIS_HOST: redis
      REDIS_PORT: 6379
      IDENTITY_SERVICE_URL: http://identity-service:3001
      CHAT_SERVICE_URL: http://chat-service:3011
      SPLITS_CLERK_PUBLISHABLE_KEY: ${SPLITS_CLERK_PUBLISHABLE_KEY}
      SPLITS_CLERK_SECRET_KEY: ${SPLITS_CLERK_SECRET_KEY}
      SPLITS_CLERK_JWKS_URL: ${SPLITS_CLERK_JWKS_URL}
      APP_CLERK_PUBLISHABLE_KEY: ${APP_CLERK_PUBLISHABLE_KEY}
      APP_CLERK_SECRET_KEY: ${APP_CLERK_SECRET_KEY}
      APP_CLERK_JWKS_URL: ${APP_CLERK_JWKS_URL}
    volumes:
      - ./services/chat-gateway/src:/app/services/chat-gateway/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy
      identity-service:
        condition: service_started
      chat-service:
        condition: service_started

  automation-service:
    build:
      context: .
      dockerfile: services/automation-service/Dockerfile
      target: development
    container_name: splits-automation-service
    ports:
      - "3007:3007"
    environment:
      NODE_ENV: development
      PORT: 3007
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      AI_SERVICE_URL: http://ai-service:3009
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY:-dev_internal_service_key_change_in_production}
    volumes:
      - ./services/automation-service/src:/app/services/automation-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  analytics-service:
    build:
      context: .
      dockerfile: services/analytics-service/Dockerfile
      target: development
    container_name: splits-analytics-service
    ports:
      - "3010:3010"
    environment:
      NODE_ENV: development
      PORT: 3010
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./services/analytics-service/src:/app/services/analytics-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  ai-service:
    build:
      context: .
      dockerfile: services/ai-service/Dockerfile
      target: development
    container_name: splits-ai-service
    ports:
      - "3009:3009"
    environment:
      NODE_ENV: development
      PORT: 3009
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: gpt-4-turbo-2024-04-09
      ATS_SERVICE_URL: http://ats-service:3002
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY:-dev_internal_service_key_change_in_production}
    volumes:
      - ./services/ai-service/src:/app/services/ai-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  document-service:
    build:
      context: .
      dockerfile: services/document-service/Dockerfile
      target: development
    container_name: splits-document-service
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: development
      PORT: 3006
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      MAX_FILE_SIZE_MB: 10
    volumes:
      - ./services/document-service/src:/app/services/document-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: ["pnpm", "--filter", "@splits-network/document-service", "dev"]

  document-processing-service:
    build:
      context: .
      dockerfile: services/document-processing-service/Dockerfile
      target: development
    container_name: splits-document-processing-service
    ports:
      - "3008:3008"
    environment:
      NODE_ENV: development
      PORT: 3008
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
    volumes:
      - ./services/document-processing-service/src:/app/services/document-processing-service/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    command:
      ["pnpm", "--filter", "@splits-network/document-processing-service", "dev"]

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
      target: development
    container_name: splits-api-gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://splits:splits_local_dev@rabbitmq:5672
      IDENTITY_SERVICE_URL: http://identity-service:3001
      ATS_SERVICE_URL: http://ats-service:3002
      NETWORK_SERVICE_URL: http://network-service:3003
      BILLING_SERVICE_URL: http://billing-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      AUTOMATION_SERVICE_URL: http://automation-service:3007
      DOCUMENT_SERVICE_URL: http://document-service:3006
      AI_SERVICE_URL: http://ai-service:3009
      ANALYTICS_SERVICE_URL: http://analytics-service:3010
      CHAT_SERVICE_URL: http://chat-service:3011
      CORS_ORIGIN: http://localhost:3100,http://localhost:3101
      # Portal app (splits.network) Clerk credentials
      SPLITS_CLERK_PUBLISHABLE_KEY: ${SPLITS_CLERK_PUBLISHABLE_KEY}
      SPLITS_CLERK_SECRET_KEY: ${SPLITS_CLERK_SECRET_KEY}
      SPLITS_CLERK_JWKS_URL: ${SPLITS_CLERK_JWKS_URL}
      # Candidate app (applicant.network) Clerk credentials
      APP_CLERK_PUBLISHABLE_KEY: ${APP_CLERK_PUBLISHABLE_KEY}
      APP_CLERK_SECRET_KEY: ${APP_CLERK_SECRET_KEY}
      APP_CLERK_JWKS_URL: ${APP_CLERK_JWKS_URL}
    volumes:
      - ./services/api-gateway/src:/app/services/api-gateway/src
      - ./packages:/app/packages
      - /app/node_modules
    networks:
      - splits-network
    depends_on:
      redis:
        condition: service_healthy
      identity-service:
        condition: service_started
      ats-service:
        condition: service_started
      network-service:
        condition: service_started
      billing-service:
        condition: service_started

  # Frontend
  portal:
    build:
      context: .
      dockerfile: apps/portal/Dockerfile
      target: development
      args:
        NEXT_PUBLIC_API_URL: http://localhost:3000/api
        SUPABASE_URL: ${SUPABASE_URL}
        SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    container_name: splits-portal
    ports:
      - "3100:3100"
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3000/api
      NEXT_PUBLIC_API_GATEWAY_URL: http://api-gateway:3000
      NEXT_PUBLIC_CHAT_GATEWAY_URL: ws://chat-gateway:3020
      CLERK_SECRET_KEY: ${SPLITS_CLERK_SECRET_KEY}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${SPLITS_CLERK_PUBLISHABLE_KEY}
      IDENTITY_SERVICE_URL: http://identity-service:3001
      ATS_SERVICE_URL: http://ats-service:3002
      NETWORK_SERVICE_URL: http://network-service:3003
      BILLING_SERVICE_URL: http://billing-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3005
      AUTOMATION_SERVICE_URL: http://automation-service:3007
      DOCUMENT_SERVICE_URL: http://document-service:3006
      ANALYTICS_SERVICE_URL: http://analytics-service:3010
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    volumes:
      - ./apps/portal/src:/app/apps/portal/src
      - ./apps/portal/public:/app/apps/portal/public
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/portal/.next
    networks:
      - splits-network
    depends_on:
      - api-gateway
    command: pnpm --filter @splits-network/portal dev

  candidate:
    build:
      context: .
      dockerfile: apps/candidate/Dockerfile
      target: development
    container_name: splits-candidate
    ports:
      - "3101:3101"
    environment:
      NODE_ENV: development
      PORT: 3101
      NEXT_PUBLIC_API_URL: http://localhost:3000/api
      NEXT_PUBLIC_API_GATEWAY_URL: http://api-gateway:3000
      NEXT_PUBLIC_CHAT_GATEWAY_URL: ws://chat-gateway:3020
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${APP_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${APP_CLERK_SECRET_KEY}
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: /portal/dashboard
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: /portal/dashboard
      NEXT_PUBLIC_APP_URL: http://localhost:3101
    volumes:
      - ./apps/candidate/src:/app/apps/candidate/src
      - ./apps/candidate/public:/app/apps/candidate/public
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/candidate/.next
    networks:
      - splits-network
    depends_on:
      - api-gateway
    command: pnpm --filter @splits-network/candidate dev

networks:
  splits-network:
    driver: bridge

volumes:
  redis-data:
  rabbitmq-data:
