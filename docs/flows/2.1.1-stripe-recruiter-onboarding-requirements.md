# 2.1.1 Stripe Connect Recruiter Onboarding â€” Requirements

Implementation requirements for recruiter Stripe Connect onboarding. Covers the complete flow from a recruiter who has never connected their account through to full payout readiness.

**Constraints:**
- Onboarding happens entirely within our app â€” no redirecting to Stripe hosted pages
- Zero PII/PCI data on our servers â€” all sensitive data collected directly by Stripe
- Use Stripe Connect Embedded Components (`@stripe/connect-js`) for the onboarding form â€” these are iframe-based Stripe-rendered forms that embed inside our pages (same security model as Stripe Elements for payment cards, but purpose-built for Connect onboarding)
- Themeable to match our DaisyUI design (colors, fonts, border radius)
- Express account type (already implemented in backend)

**Why Connect Embedded Components (not full custom API onboarding):**
- Full custom API onboarding requires switching from Express to Custom accounts, taking on compliance burden, and maintaining regulatory changes every 6 months
- Stripe is actively deprecating the custom API onboarding path
- Connect Embedded Components give us full in-app experience with zero PII liability
- They auto-update when Stripe's regulatory requirements change
- They handle all business types, document uploads, identity verification, and international bank accounts automatically

---

## Table of Contents

1. [What Exists Today](#1-what-exists-today)
2. [What Needs to Be Built](#2-what-needs-to-be-built)
3. [User Experience Flow](#3-user-experience-flow)
4. [Backend Requirements](#4-backend-requirements)
5. [Frontend Requirements](#5-frontend-requirements)
6. [Webhook & Real-Time Updates](#6-webhook--real-time-updates)
7. [Error Handling & Edge Cases](#7-error-handling--edge-cases)
8. [Security & Compliance](#8-security--compliance)
9. [Files to Create or Modify](#9-files-to-create-or-modify)

---

## 1. What Exists Today

### Backend (Mostly Complete)

| Component | File | Status |
|-----------|------|--------|
| `StripeConnectService` | `services/billing-service/src/v2/connect/service.ts` | Complete |
| `StripeConnectRepository` | `services/billing-service/src/v2/connect/repository.ts` | Complete |
| Types | `services/billing-service/src/v2/connect/types.ts` | Complete |
| Routes | `services/billing-service/src/v2/connect/routes.ts` | Complete |
| API Gateway proxy | `services/api-gateway/src/routes/v2/billing.ts` (lines 252-332) | Complete |
| Webhook handler | `services/billing-service/src/services/webhooks/service.ts` (line 81) | Complete |
| DB fields | `recruiters.stripe_connect_account_id`, `stripe_connect_onboarded`, `stripe_connect_onboarded_at` | Complete |
| Account Session endpoint | â€” | **Missing** (required for embedded components) |

**Existing API endpoints (all authenticated):**
- `GET /api/v2/stripe/connect/account` â€” Get current Connect account status
- `POST /api/v2/stripe/connect/account` â€” Create or retrieve Connect account (idempotent)
- `POST /api/v2/stripe/connect/onboarding-link` â€” Generate Stripe Account Link (kept for fallback, but primary flow will use embedded components)

**Webhook handling:**
- `account.updated` â€” Syncs `charges_enabled`, `payouts_enabled`, `details_submitted` to recruiters table

### What the Backend Already Returns

`GET /api/v2/stripe/connect/account` response:

```json
{
  "data": {
    "account_id": "acct_xxx",
    "charges_enabled": true,
    "payouts_enabled": true,
    "details_submitted": true,
    "requirements": {
      "currently_due": [],
      "eventually_due": [],
      "past_due": [],
      "pending_verification": [],
      "disabled_reason": null
    },
    "onboarded": true,
    "recruiter_id": "uuid"
  }
}
```

### Frontend (Partial)

| Component | Status |
|-----------|--------|
| `@stripe/stripe-js` (v8.6.4) | Installed in portal |
| `@stripe/react-stripe-js` (v5.5.0) | Installed in portal (for payment forms) |
| `@stripe/connect-js` | **Not installed** (needed for embedded Connect components) |
| `StripeProvider` component | Exists (`apps/portal/src/components/stripe/stripe-provider.tsx`) â€” for payment Elements only |
| `PaymentForm` component | Exists (SetupIntent for subscriptions) |
| Connect onboarding UI | **Missing** |
| Connect status display | **Missing** |
| Payout readiness indicator | **Missing** |

---

## 2. What Needs to Be Built

### New Dependency

```bash
pnpm --filter @splits-network/portal add @stripe/connect-js
```

### Backend (New Endpoint)

| # | Component | Description |
|---|-----------|-------------|
| 1 | Account Session endpoint | `POST /api/v2/stripe/connect/account-session` â€” Creates a Stripe AccountSession and returns `client_secret` for initializing Connect.js on the frontend |
| 2 | Dashboard link endpoint | `POST /api/v2/stripe/connect/dashboard-link` â€” Generates Stripe Express Dashboard login link for onboarded recruiters |
| 3 | Onboarding event | Publish `recruiter.stripe_connect_onboarded` event when webhook confirms onboarding complete |
| 4 | Notification consumer | Handle onboarding completion event, send confirmation email |

### Frontend

| # | Component | Description |
|---|-----------|-------------|
| 1 | Connect provider | Wrapper that initializes `@stripe/connect-js` with `fetchClientSecret` |
| 2 | Connect status hook | `useStripeConnectStatus()` â€” Fetches and caches account status |
| 3 | Onboarding page | `/portal/billing/connect` â€” Embeds the `account-onboarding` component inline |
| 4 | Post-onboarding management | Uses `account-management` component for updating bank details later |
| 5 | Connect status card | Reusable card showing account status on billing page and profile |
| 6 | Onboarding prompt banner | Contextual prompt on dashboard/placements if not onboarded |
| 7 | Billing page integration | Add Connect status section to existing billing page |
| 8 | Profile status badge | "Payout Ready" badge on recruiter profile/settings |

---

## 3. User Experience Flow

### 3.1 First-Time Onboarding (Never Connected)

```
Recruiter sees "Set Up Payouts" prompt (dashboard or billing page)
         â”‚
         â–¼
Clicks "Set Up Payouts" â†’ navigates to /portal/billing/connect
         â”‚
         â–¼
Page loads:
  1. Frontend calls POST /api/v2/stripe/connect/account
     â†’ Creates Express account if none exists
     â†’ Returns account_id
  2. Frontend calls POST /api/v2/stripe/connect/account-session
     â†’ Backend creates Stripe AccountSession with account_onboarding enabled
     â†’ Returns { client_secret: "..." }
  3. Frontend initializes Connect.js with client_secret
  4. Renders <account-onboarding> embedded component inline
         â”‚
         â–¼
Recruiter fills out onboarding form WITHIN OUR APP:
  â†’ Business type (individual or company)
  â†’ Legal name, DOB, address
  â†’ Tax ID (SSN or EIN)
  â†’ Bank account details
  â†’ Identity verification (document upload if needed)
  â†’ Terms of Service acceptance
  â†’ ALL collected by Stripe via iframes â€” never touches our servers
         â”‚
         â–¼
Recruiter completes form â†’ component fires onExit callback
         â”‚
         â–¼
Our page:
  1. Calls GET /api/v2/stripe/connect/account to check status
  2. If onboarded: Shows success state inline
  3. If pending verification: Shows "Stripe is verifying" message
         â”‚
         â–¼
Stripe sends account.updated webhook (may be immediate or delayed)
  â†’ Backend updates recruiters table
  â†’ Publishes recruiter.stripe_connect_onboarded event
  â†’ Notification service sends confirmation email
```

### 3.2 Returning (Already Onboarded)

```
Recruiter visits /portal/billing
         â”‚
         â–¼
Connect status card shows "Payout Ready"
  â†’ Identity verified âœ“
  â†’ Bank account connected âœ“
  â†’ Payouts enabled âœ“
         â”‚
         â–¼
Two actions available:
  1. "Manage Account" â†’ loads <account-management> embedded component
     (recruiter can update bank details, address, etc. â€” all within our app)
  2. "View Stripe Dashboard" â†’ opens Express Dashboard in new tab
```

### 3.3 Incomplete / Abandoned Onboarding

```
Recruiter started but didn't finish
         â”‚
         â–¼
Visits /portal/billing/connect
         â”‚
         â–¼
Page creates fresh AccountSession, renders <account-onboarding>
  â†’ Component automatically picks up where they left off
  â†’ Shows remaining requirements
  â†’ No redirect, no expired links to worry about
```

### 3.4 Stripe Needs More Info (requirements.currently_due)

```
Stripe webhook fires account.updated with new requirements
         â”‚
         â–¼
Backend syncs onboarded = false
         â”‚
         â–¼
Recruiter visits billing page:
  â†’ Status card shows "Action Required"
  â†’ "Update Information" button â†’ /portal/billing/connect
  â†’ <account-onboarding> component shows only the missing requirements
  â†’ Recruiter fills them out inline â†’ done
```

---

## 4. Backend Requirements

### 4.1 Account Session Endpoint (New)

**File:** `services/billing-service/src/v2/connect/service.ts`

Add method:

```typescript
async createAccountSession(clerkUserId: string): Promise<{ client_secret: string }> {
    const status = await this.getOrCreateAccount(clerkUserId);

    const accountSession = await this.stripe.accountSessions.create({
        account: status.account_id,
        components: {
            account_onboarding: { enabled: true },
            account_management: {
                enabled: true,
                features: {
                    external_account_collection: true,
                },
            },
        },
    });

    return { client_secret: accountSession.client_secret };
}
```

**File:** `services/billing-service/src/v2/connect/routes.ts`

Add route:

```typescript
app.post(`${basePath}/account-session`, async (request, reply) => {
    const { clerkUserId } = requireUserContext(request);
    const session = await service.createAccountSession(clerkUserId);
    return reply.send({ data: session });
});
```

**File:** `services/billing-service/src/v2/connect/types.ts`

Add type:

```typescript
export interface StripeAccountSessionResponse {
    client_secret: string;
}
```

**File:** `services/api-gateway/src/routes/v2/billing.ts`

Add proxy route for `POST /api/v2/stripe/connect/account-session`.

### 4.2 Express Dashboard Login Link

**File:** `services/billing-service/src/v2/connect/service.ts`

Add method:

```typescript
async createDashboardLink(clerkUserId: string): Promise<{ url: string }> {
    const status = await this.getAccountStatus(clerkUserId);
    if (!status.onboarded) {
        throw new Error('Account must be fully onboarded to access dashboard');
    }

    const loginLink = await this.stripe.accounts.createLoginLink(status.account_id);
    return { url: loginLink.url };
}
```

**Route:** `POST /api/v2/stripe/connect/dashboard-link`
**API Gateway:** Proxy to billing service.

### 4.3 Publish Onboarding Complete Event

**File:** `services/billing-service/src/services/webhooks/service.ts`

In `handleAccountUpdated()`, after updating the recruiter record, detect the transition and publish events:

```
onboarded: false â†’ true:
  Event: recruiter.stripe_connect_onboarded
  Payload: { recruiter_id, account_id, onboarded_at }

onboarded: true â†’ false:
  Event: recruiter.stripe_connect_disabled
  Payload: { recruiter_id, account_id, disabled_reason }
```

This requires passing a RabbitMQ event publisher into the WebhookService (currently it only has Supabase + Logger).

### 4.4 Notification Consumer

**File:** `services/notification-service/src/domain-consumer.ts`

Bind and handle:
- `recruiter.stripe_connect_onboarded` â†’ Send "Your payouts are set up" email
- `recruiter.stripe_connect_disabled` â†’ Send "Action required" email with link to update info

---

## 5. Frontend Requirements

### 5.1 Connect Provider

**Create:** `apps/portal/src/components/stripe/connect-provider.tsx`

Initializes `@stripe/connect-js` with the `fetchClientSecret` pattern. This is separate from the existing `StripeProvider` (which is for payment Elements).

```typescript
import { loadConnectAndInitialize } from '@stripe/connect-js';

// Initialize with:
const connectInstance = loadConnectAndInitialize({
    publishableKey: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
    fetchClientSecret: async () => {
        const token = await getToken();
        const client = createAuthenticatedClient(token);
        const response = await client.post('/stripe/connect/account-session');
        return response.data.client_secret;
    },
    appearance: {
        variables: {
            // Match DaisyUI theme
            colorPrimary: '#570df8',        // or pull from CSS custom properties
            fontFamily: 'inherit',
            borderRadius: '8px',
            fontSizeBase: '14px',
            spacingUnit: '12px',
            colorBackground: '#ffffff',
            colorText: '#1f2937',
            colorDanger: '#ef4444',
        },
    },
});
```

**Pattern:** Wrap only the billing/connect pages with this provider. Don't wrap the entire app â€” Connect.js should only load when needed.

### 5.2 Hook: `useStripeConnectStatus()`

**Create:** `apps/portal/src/hooks/use-stripe-connect-status.ts`

```typescript
interface StripeConnectStatus {
    // State
    loading: boolean;
    error: string | null;

    // Account existence
    hasAccount: boolean;
    accountId: string | null;

    // Onboarding flags (from Stripe)
    chargesEnabled: boolean;
    payoutsEnabled: boolean;
    detailsSubmitted: boolean;
    onboarded: boolean;

    // Requirements (from Stripe)
    currentlyDue: string[];
    eventuallyDue: string[];
    pastDue: string[];
    pendingVerification: string[];
    disabledReason: string | null;

    // Computed state for UI
    status: 'not_started' | 'incomplete' | 'pending_verification' | 'action_required' | 'ready';

    // Actions
    refresh: () => Promise<void>;
    createAccount: () => Promise<void>;
    openDashboard: () => Promise<void>;
}
```

**Status derivation:**
```
not_started          â†’ hasAccount === false
incomplete           â†’ hasAccount && !detailsSubmitted
pending_verification â†’ detailsSubmitted && pendingVerification.length > 0 && !onboarded
action_required      â†’ (currentlyDue.length > 0 || pastDue.length > 0) && !onboarded
ready                â†’ onboarded === true
```

**Behavior:**
- On mount: Call `GET /api/v2/stripe/connect/account`
- If 404 (no account): `hasAccount: false`, `status: 'not_started'`
- If account exists: Map response to status fields
- `createAccount()`: Call `POST /api/v2/stripe/connect/account`, then refresh
- `openDashboard()`: Call `POST /api/v2/stripe/connect/dashboard-link`, open URL in new tab
- `refresh()`: Re-fetch status

### 5.3 Page: Connect Onboarding

**Create:** `apps/portal/src/app/portal/billing/connect/page.tsx`

This is the main onboarding page. The Stripe `account-onboarding` component renders inline â€” the recruiter fills everything out without ever leaving our app.

**Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Back to Billing                                                â”‚
â”‚                                                                   â”‚
â”‚ Set Up Your Payouts                                               â”‚
â”‚ Connect your bank account to receive placement commissions.       â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â”‚  Status Bar (our component):                                 â”‚  â”‚
â”‚ â”‚  â— Create Account  â†’  â— Complete Verification  â†’  â— Ready   â”‚  â”‚
â”‚ â”‚       (done)              (in progress)             (next)   â”‚  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â”‚           Stripe account-onboarding component                â”‚  â”‚
â”‚ â”‚           (rendered via @stripe/connect-js)                   â”‚  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â”‚  This is where Stripe renders:                               â”‚  â”‚
â”‚ â”‚  - Business type selector (individual / company)             â”‚  â”‚
â”‚ â”‚  - Legal name, DOB, address fields                           â”‚  â”‚
â”‚ â”‚  - Tax ID (SSN / EIN) field                                  â”‚  â”‚
â”‚ â”‚  - Bank account details                                      â”‚  â”‚
â”‚ â”‚  - Identity document upload (if needed)                      â”‚  â”‚
â”‚ â”‚  - Terms of service acceptance                               â”‚  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â”‚  All fields are Stripe iframes â€” PII never touches           â”‚  â”‚
â”‚ â”‚  our servers. Themed to match our DaisyUI design.            â”‚  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  Security note (our component):                              â”‚  â”‚
â”‚ â”‚                                                              â”‚  â”‚
â”‚ â”‚  ğŸ”’ Your personal and financial information is collected     â”‚  â”‚
â”‚ â”‚  and stored securely by Stripe. Splits Network never sees    â”‚  â”‚
â”‚ â”‚  or stores your bank details, tax ID, or identity documents. â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Page behavior by state:**

| Status | What renders |
|--------|-------------|
| `not_started` | Auto-calls `createAccount()`, then renders `account-onboarding` component |
| `incomplete` | Renders `account-onboarding` component (picks up where they left off) |
| `pending_verification` | Shows "Stripe is verifying your details" message, no form |
| `action_required` | Renders `account-onboarding` component (shows only missing fields) |
| `ready` | Shows success state with "Manage Account" and "View Dashboard" buttons |

**Embedded component setup:**

```typescript
// Vanilla JS approach (not React components)
const connectInstance = loadConnectAndInitialize({
    publishableKey: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!,
    fetchClientSecret,
    appearance: { variables: { /* DaisyUI theme vars */ } },
});

// Create the onboarding element
const onboardingElement = connectInstance.create('account-onboarding');

// Set callbacks
onboardingElement.setOnExit(() => {
    // Recruiter finished or exited the form
    // Refresh status to check if onboarding completed
    refreshStatus();
});

onboardingElement.setOnStepChange(({ step }) => {
    // Update our step indicator UI
    // step: 'business_type', 'representative_details', etc.
    setCurrentStep(step);
});

// Custom ToS/Privacy links
onboardingElement.setFullTermsOfServiceUrl('https://splits.network/terms-of-service');
onboardingElement.setPrivacyPolicyUrl('https://splits.network/privacy-policy');

// Collection options â€” collect everything upfront
onboardingElement.setCollectionOptions({
    fields: 'eventually_due',          // collect all fields, not just currently_due
    futureRequirements: 'include',     // include upcoming requirements too
});

// Mount to DOM
containerRef.current.appendChild(onboardingElement);
```

**Cleanup:** On component unmount, remove the element from DOM. Connect.js handles its own lifecycle.

### 5.4 Post-Onboarding: Account Management

**Integrate into:** `/portal/billing/connect` page (shown when `status === 'ready'`)

For already-onboarded recruiters who need to update bank details, address, etc.:

```typescript
const managementElement = connectInstance.create('account-management');
containerRef.current.appendChild(managementElement);
```

This renders Stripe's account management UI inline â€” bank account changes, address updates, new document uploads â€” all within our app. The AccountSession created in 4.1 already enables `account_management`.

### 5.5 Component: Connect Status Card

**Create:** `apps/portal/src/components/stripe/connect-status-card.tsx`

Reusable card used on the billing page and recruiter profile sidebar.

**Variants by status:**

```
â”Œâ”€ not_started â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âšª Payouts Not Set Up                       â”‚
â”‚                                               â”‚
â”‚  Connect your bank account to receive         â”‚
â”‚  placement commissions.                       â”‚
â”‚                                               â”‚
â”‚  [Set Up Payouts â†’]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ incomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¡ Setup Incomplete                         â”‚
â”‚                                               â”‚
â”‚  You started connecting your account but      â”‚
â”‚  didn't finish.                               â”‚
â”‚                                               â”‚
â”‚  [Continue Setup â†’]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ pending_verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¡ Verification Pending                     â”‚
â”‚                                               â”‚
â”‚  Stripe is reviewing your information.        â”‚
â”‚  This usually takes 1-2 business days.        â”‚
â”‚                                               â”‚
â”‚  We'll notify you when it's complete.         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ action_required â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”´ Action Required                          â”‚
â”‚                                               â”‚
â”‚  Stripe needs additional information to       â”‚
â”‚  keep your payouts active.                    â”‚
â”‚                                               â”‚
â”‚  [Update Information â†’]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¢ Payouts Ready                            â”‚
â”‚                                               â”‚
â”‚  âœ“ Identity verified                         â”‚
â”‚  âœ“ Bank account connected                    â”‚
â”‚  âœ“ Payouts enabled                           â”‚
â”‚                                               â”‚
â”‚  Connected since: Jan 15, 2026               â”‚
â”‚                                               â”‚
â”‚  [Manage Account]  [View Stripe Dashboard â†—] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Props:**
```typescript
interface ConnectStatusCardProps {
    variant?: 'full' | 'compact';
    showActions?: boolean;
    className?: string;
}
```

All action buttons navigate to `/portal/billing/connect` except "View Stripe Dashboard" which opens external link via `openDashboard()`.

### 5.6 Component: Onboarding Prompt Banner

**Create:** `apps/portal/src/components/stripe/connect-prompt-banner.tsx`

Dismissible banner shown on dashboard and placement-related pages when recruiter hasn't onboarded.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Set up your payouts to receive commissions from placements.       â”‚
â”‚  [Set Up Now â†’]                                              [âœ•]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Behavior:**
- Only shown when `status !== 'ready'` and `status !== 'pending_verification'`
- Dismissible (store dismissal in localStorage with 7-day expiry)
- Links to `/portal/billing/connect`
- Shown on: dashboard, placements list

### 5.7 Integration: Billing Page

**Modify:** `apps/portal/src/app/portal/billing/page.tsx` (or its content component)

Add `ConnectStatusCard` (variant `full`) as the first section, above subscription/plan content.

### 5.8 Integration: Recruiter Profile Badge

**Modify:** Recruiter profile/settings page

Small badge:
- `ready`: Green "Payout Ready" badge
- Anything else: Orange "Payouts Not Set Up" with link to `/portal/billing/connect`

---

## 6. Webhook & Real-Time Updates

### 6.1 Existing Webhook Flow (No Changes Needed to Core)

```
Stripe â†’ POST /api/v1/webhooks/stripe (billing-service)
  â†’ WebhookService.handleStripeWebhook()
    â†’ case 'account.updated': handleAccountUpdated()
      â†’ UPDATE recruiters SET stripe_connect_onboarded = true/false
```

This already works.

### 6.2 Enhancement: Domain Event on Status Change

In `handleAccountUpdated()`, after the DB update:

**Transition: not-onboarded â†’ onboarded:**
1. Publish `recruiter.stripe_connect_onboarded` event via RabbitMQ
2. Notification service sends "Your payouts are set up" confirmation email

**Transition: onboarded â†’ not-onboarded (rare):**
1. Publish `recruiter.stripe_connect_disabled` event
2. Notification service sends "Action required â€” update your payment information" email

### 6.3 Frontend Status Refresh

Since the embedded component fires `onExit` when the recruiter completes the form:

1. `onExit` callback fires â†’ call `refresh()` from `useStripeConnectStatus()`
2. If `onboarded === true` immediately: Show inline success
3. If `detailsSubmitted === true` but not yet onboarded: Show "Verification in progress"
4. If still incomplete: Show the `account-onboarding` component again

No polling needed â€” the `onExit` callback tells us when the user is done.

**Optional enhancement:** Poll status every 5 seconds for 30 seconds after `onExit` when `detailsSubmitted && !onboarded`, to catch fast verifications.

---

## 7. Error Handling & Edge Cases

### 7.1 AccountSession Expiry

AccountSessions are short-lived. If the session expires while the recruiter is filling out the form:
- Connect.js handles this internally by calling `fetchClientSecret` again
- The `fetchClientSecret` function automatically requests a new AccountSession
- No user-facing interruption

### 7.2 Recruiter Not Found

If `POST /api/v2/stripe/connect/account` fails because no recruiter profile exists:
- Show "Complete your recruiter profile first" with link to profile setup
- Don't render the onboarding component

### 7.3 Stripe Outage

If Stripe API calls fail:
- Show generic error: "We're having trouble connecting to our payment provider. Please try again in a few minutes."
- Log error to Sentry
- Don't expose Stripe error details to user

### 7.4 Multiple Browser Tabs

- `getOrCreateAccount()` is idempotent â€” returns same account
- AccountSessions are independent per request â€” no conflicts
- Embedded component maintains its own state

### 7.5 Stripe Disables Account

If Stripe disables a recruiter's account (failed verification, compliance):
- Webhook updates `stripe_connect_onboarded = false`
- Next billing page visit: Status card shows "Action Required"
- "Update Information" â†’ `/portal/billing/connect` renders `account-onboarding` with only missing requirements
- No new account needed â€” same `acct_xxx`

### 7.6 Already Onboarded Recruiter Visits Setup Page

- `useStripeConnectStatus()` returns `status: 'ready'`
- Page shows success state with `account-management` component for updates
- No onboarding form shown

---

## 8. Security & Compliance

### 8.1 PII/PCI Handling

The `account-onboarding` embedded component uses Stripe-controlled iframes (same architecture as Stripe Elements for payment cards). PII is entered into Stripe's iframes and sent directly from the browser to Stripe's servers.

| Data Type | Where Entered | Where Stored | Touches Our Servers? |
|-----------|--------------|--------------|---------------------|
| Legal name | Stripe iframe | Stripe | No |
| Date of birth | Stripe iframe | Stripe | No |
| SSN / EIN | Stripe iframe | Stripe | No |
| Home address | Stripe iframe | Stripe | No |
| Bank account number | Stripe iframe | Stripe | No |
| Bank routing number | Stripe iframe | Stripe | No |
| Government ID photos | Stripe iframe | Stripe | No |
| Terms acceptance | Stripe iframe | Stripe | No |

**What our servers DO handle:**
- `stripe_connect_account_id` (opaque ID: `acct_1234`)
- `stripe_connect_onboarded` (boolean)
- `stripe_connect_onboarded_at` (timestamp)
- AccountSession `client_secret` (passed to frontend, short-lived)
- `recruiter_id` metadata on the Stripe account

### 8.2 AccountSession Security

- AccountSessions are created server-side using our Stripe secret key
- `client_secret` is scoped to a specific connected account and specific components
- Short-lived â€” Connect.js auto-refreshes via `fetchClientSecret`
- Only the authenticated recruiter (verified via Clerk JWT â†’ `resolveAccessContext`) can create a session for their own account

### 8.3 Express Dashboard Login Links

- Generated server-side via `stripe.accounts.createLoginLink()`
- Single-use, expire quickly
- Only authenticated recruiters can request their own

### 8.4 Webhook Verification

Already implemented:
- `stripe.webhooks.constructEvent()` verifies webhook signature
- Rejects events that don't match our webhook secret

---

## 9. Files to Create or Modify

### New Dependency

```
@stripe/connect-js  â†’  apps/portal/package.json
```

### New Files

| File | Type | Description |
|------|------|-------------|
| `apps/portal/src/components/stripe/connect-provider.tsx` | Provider | Initializes `@stripe/connect-js` with `fetchClientSecret` and DaisyUI theming |
| `apps/portal/src/hooks/use-stripe-connect-status.ts` | Hook | Connect account status management |
| `apps/portal/src/app/portal/billing/connect/page.tsx` | Page | Embeds `account-onboarding` and `account-management` components inline |
| `apps/portal/src/components/stripe/connect-status-card.tsx` | Component | Reusable status card (5 variants) |
| `apps/portal/src/components/stripe/connect-prompt-banner.tsx` | Component | Dashboard/placement prompt banner |

### Modified Files

| File | Change |
|------|--------|
| `services/billing-service/src/v2/connect/service.ts` | Add `createAccountSession()` and `createDashboardLink()` methods |
| `services/billing-service/src/v2/connect/types.ts` | Add `StripeAccountSessionResponse` type |
| `services/billing-service/src/v2/connect/routes.ts` | Add `POST /account-session` and `POST /dashboard-link` routes |
| `services/api-gateway/src/routes/v2/billing.ts` | Proxy new routes |
| `services/billing-service/src/services/webhooks/service.ts` | Publish domain events on onboarding status transitions |
| `services/notification-service/src/domain-consumer.ts` | Bind and handle `recruiter.stripe_connect_onboarded` and `recruiter.stripe_connect_disabled` events |
| `apps/portal/src/app/portal/billing/page.tsx` | Add `ConnectStatusCard` section |
| `apps/portal/src/app/portal/dashboard/components/recruiter-dashboard.tsx` | Add `ConnectPromptBanner` |

### Summary

| Category | New | Modified |
|----------|-----|----------|
| Frontend (Portal) | 5 files + 1 dependency | 2 files |
| Backend (Billing Service) | 0 | 4 files |
| Backend (API Gateway) | 0 | 1 file |
| Backend (Notification Service) | 0 | 1 file |
| **Total** | **5 files + 1 dep** | **8 files** |

---

## Sources

- [Stripe Connect Embedded Onboarding](https://docs.stripe.com/connect/embedded-onboarding)
- [Account Onboarding Component](https://docs.stripe.com/connect/supported-embedded-components/account-onboarding)
- [Get Started with Connect Embedded Components](https://docs.stripe.com/connect/get-started-connect-embedded-components)
- [Build a Full Embedded Integration](https://docs.stripe.com/connect/build-full-embedded-integration)
- [Choose Your Onboarding Configuration](https://docs.stripe.com/connect/onboarding)
- [API Onboarding (deprecated path)](https://docs.stripe.com/connect/api-onboarding)
