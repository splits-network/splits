# 2.1.2 Stripe Company Billing Onboarding â€” Requirements

Implementation requirements for company billing onboarding. Covers the complete flow from a company that has never configured billing through to invoice-payment readiness.

**Constraints:**
- Zero PII/PCI data on our servers â€” all payment card data collected directly by Stripe via Stripe Elements iframes
- Use Stripe Elements (`@stripe/stripe-js` + `@stripe/react-stripe-js`) for payment method collection â€” already installed in the portal
- Existing `StripeProvider` and `PaymentForm` components are reusable for the company flow
- Company billing is for **paying** placement invoices (opposite of recruiter Connect, which is for **receiving** payouts)

**Key difference from recruiter onboarding (2.1.1):**
- Recruiters use Connect Embedded Components (`@stripe/connect-js`) to onboard as payees
- Companies use standard Stripe Elements (`@stripe/stripe-js`) to save a payment method as payers
- Both keep card/PII data off our servers via Stripe-controlled iframes

---

## Table of Contents

1. [What Exists Today](#1-what-exists-today)
2. [What Needs to Be Built](#2-what-needs-to-be-built)
3. [User Experience Flow](#3-user-experience-flow)
4. [Backend Requirements](#4-backend-requirements)
5. [Frontend Requirements](#5-frontend-requirements)
6. [Webhook & Real-Time Updates](#6-webhook--real-time-updates)
7. [Error Handling & Edge Cases](#7-error-handling--edge-cases)
8. [Security & Compliance](#8-security--compliance)
9. [Files to Create or Modify](#9-files-to-create-or-modify)

---

## 1. What Exists Today

### Backend (Mostly Complete)

| Component | File | Status |
|-----------|------|--------|
| `CompanyBillingProfileService` | `services/billing-service/src/v2/company-billing/service.ts` | Complete |
| `CompanyBillingProfileRepository` | `services/billing-service/src/v2/company-billing/repository.ts` | Complete |
| Types | `services/billing-service/src/v2/company-billing/types.ts` | Complete |
| Routes | `services/billing-service/src/v2/company-billing/routes.ts` | Complete |
| `ensureStripeCustomer()` | `service.ts` line 71 | Complete (but only called internally during invoice creation) |
| `PlacementInvoiceService` | `services/billing-service/src/v2/placement-invoices/service.ts` | Complete |
| Invoice webhook handlers | `services/billing-service/src/services/webhooks/service.ts` | Complete |
| API Gateway proxy | `services/api-gateway/src/routes/v2/billing.ts` | Complete |
| DB table | `company_billing_profiles` | Complete |
| Company SetupIntent endpoint | â€” | **Missing** |
| Company payment method endpoints | â€” | **Missing** |
| Company billing readiness check | â€” | **Missing** |

**Existing API endpoints (all authenticated, `billing_admin` role):**
- `GET /api/v2/company-billing-profiles` â€” List all billing profiles (admin)
- `GET /api/v2/company-billing-profiles/:companyId` â€” Get company's billing profile
- `POST /api/v2/company-billing-profiles/:companyId` â€” Create or update (upsert) billing profile
- `PATCH /api/v2/company-billing-profiles/:companyId` â€” Partial update billing profile
- `POST /api/v2/placements/:placementId/invoices` â€” Create invoice for placement
- `GET /api/v2/placements/:placementId/invoices` â€” Get placement invoices
- `GET /api/v2/company-billing-profiles/:companyId/invoices` â€” Get company's placement invoices

**Billing profile fields (DB):**

| Field | Type | Currently Set Via UI? |
|-------|------|-----------------------|
| `billing_terms` | `immediate` / `net_30` / `net_60` / `net_90` | Yes (company settings form) |
| `billing_email` | string | Yes (company settings form) |
| `invoice_delivery_method` | `email` / `none` | Hardcoded to `email` on save |
| `billing_contact_name` | string | **No** |
| `billing_address` | JSON | **No** |
| `stripe_customer_id` | string | Auto-set (lazy, only at invoice time) |
| `stripe_default_payment_method_id` | string | **Never set** |
| `stripe_tax_id` | string | **No** |

**Webhook handling (invoice lifecycle â€” already complete):**
- `invoice.payment_succeeded` â†’ marks invoice paid
- `invoice.payment_failed` â†’ records failure reason
- `invoice.finalized` â†’ stores hosted URL, PDF URL, due date
- `invoice.marked_uncollectible` â†’ marks uncollectible
- `invoice.voided` â†’ marks voided

### Frontend (Partial)

| Component | Status |
|-----------|--------|
| `@stripe/stripe-js` (v8.6.4) | Installed in portal |
| `@stripe/react-stripe-js` (v5.5.0) | Installed in portal |
| `StripeProvider` component | Exists (`apps/portal/src/components/stripe/stripe-provider.tsx`) |
| `PaymentForm` component | Exists (`apps/portal/src/components/stripe/payment-form.tsx`) |
| Company settings form | Exists â€” but only captures `billing_terms` + `billing_email` |
| Company billing page | **Missing** â€” company users see placeholder "managed at org level" |
| Company payment method management | **Missing** |
| Company invoice list | **Missing** (admin view exists, company user view does not) |
| Company billing readiness indicator | **Missing** |
| Company billing setup wizard | **Missing** |

### What the Company Settings Form Currently Sends

`POST /api/v2/company-billing-profiles/:companyId`:

```json
{
  "billing_terms": "net_30",
  "billing_email": "billing@company.com",
  "invoice_delivery_method": "email"
}
```

Only 3 of 7+ available fields are captured. No Stripe customer is created, no payment method collected.

### Current Company Billing Page State

`apps/portal/src/app/portal/billing/components/billing-content.tsx` (line 26-57):

When a company user (non-recruiter) visits `/portal/billing`, they see a placeholder card:
> "Company Billing â€” Company billing is managed at the organization level. Contact your organization administrator for billing inquiries."

No actual billing functionality is rendered for company users.

---

## 2. What Needs to Be Built

### Backend (New Endpoints)

| # | Component | Description |
|---|-----------|-------------|
| 1 | Company SetupIntent | `POST /api/v2/company-billing-profiles/:companyId/setup-intent` â€” Creates Stripe Customer (if needed) + SetupIntent for collecting payment method |
| 2 | Get company payment method | `GET /api/v2/company-billing-profiles/:companyId/payment-method` â€” Retrieves default payment method details from Stripe |
| 3 | Update company payment method | `POST /api/v2/company-billing-profiles/:companyId/payment-method` â€” Attaches payment method to customer and sets as default |
| 4 | Billing readiness check | `GET /api/v2/company-billing-profiles/:companyId/billing-readiness` â€” Returns computed readiness state |
| 5 | Billing setup event | Publish `company.billing_profile_completed` event when profile reaches "ready" state |
| 6 | Notification consumer | Handle billing setup completion event, send confirmation email |

### Frontend

| # | Component | Description |
|---|-----------|-------------|
| 1 | Company billing dashboard | Replace placeholder on `/portal/billing` for company users â€” show billing profile, payment method, invoices |
| 2 | Company billing setup wizard | Guided flow for first-time setup: billing details â†’ payment method â†’ confirmation |
| 3 | Company payment method section | Show current card, add/update via Stripe Elements (reuse existing `StripeProvider` + `PaymentForm`) |
| 4 | Company invoice list | Placement invoices with status, amounts, due dates, hosted payment links |
| 5 | Billing readiness hook | `useCompanyBillingStatus()` â€” fetches and caches billing profile + readiness state |
| 6 | Billing setup prompt | Banner on company dashboard / jobs page if billing is not configured |
| 7 | Expanded settings form | Add missing fields: billing contact name, billing address, tax ID |

---

## 3. User Experience Flow

### 3.1 First-Time Billing Setup

```
Company admin visits /portal/billing (or prompted from dashboard)
         â”‚
         â–¼
Billing page detects: no billing profile or profile incomplete
         â”‚
         â–¼
Shows "Set Up Billing" card with setup wizard
         â”‚
         â–¼
Step 1: Billing Details
  â†’ Billing email (required)
  â†’ Billing contact name
  â†’ Billing address (street, city, state, zip, country)
  â†’ Payment terms (Immediate / Net 30 / Net 60 / Net 90)
  â†’ Tax ID (EIN â€” optional)
  â†’ All saved to company_billing_profiles via POST/PATCH
         â”‚
         â–¼
Step 2: Payment Method
  â†’ Backend creates Stripe Customer (if needed) via ensureStripeCustomer()
  â†’ Backend creates SetupIntent attached to company's Stripe Customer
  â†’ Returns { client_secret } to frontend
  â†’ Frontend renders PaymentElement via existing StripeProvider
  â†’ Company admin enters card details in Stripe iframe
  â†’ Card data goes directly from browser to Stripe â€” never touches our servers
  â†’ On success: frontend sends payment_method_id to backend
  â†’ Backend attaches to customer, sets as default, saves ID to billing profile
         â”‚
         â–¼
Step 3: Confirmation
  â†’ Shows summary: billing email, terms, card on file
  â†’ "Your billing is set up" success state
  â†’ Link to "View Billing Dashboard"
         â”‚
         â–¼
Backend publishes company.billing_profile_completed event
  â†’ Notification service sends confirmation email
```

### 3.2 Returning (Billing Already Configured)

```
Company admin visits /portal/billing
         â”‚
         â–¼
Billing dashboard shows 3 sections:
         â”‚
         â”œâ”€â”€ Billing Profile Card
         â”‚   â†’ Billing email, contact name, address
         â”‚   â†’ Payment terms (Net 30, etc.)
         â”‚   â†’ Tax ID (if set)
         â”‚   â†’ "Edit" button â†’ opens settings or inline edit
         â”‚
         â”œâ”€â”€ Payment Method Card
         â”‚   â†’ Card brand icon, last 4 digits, expiration
         â”‚   â†’ "Update" button â†’ modal with PaymentElement
         â”‚
         â””â”€â”€ Placement Invoices Table
             â†’ List of invoices with: date, description, amount, status, due date
             â†’ Status badges: Draft, Open, Paid, Void, Failed
             â†’ "View Invoice" link â†’ opens Stripe hosted invoice page
             â†’ "Download PDF" link â†’ opens invoice PDF
             â†’ Pagination for invoice history
```

### 3.3 Billing Not Fully Set Up (Missing Payment Method)

```
Company admin has billing profile but no payment method
         â”‚
         â–¼
Billing dashboard shows:
  â†’ Billing profile card (with existing details)
  â†’ Payment method card with warning: "No payment method on file"
  â†’ Warning explains impact based on billing terms:
      - Immediate: "Placement fees cannot be charged until a payment method is added"
      - Net 30/60/90: "A payment method ensures invoices are paid on time"
  â†’ "Add Payment Method" button â†’ Stripe Elements modal
```

### 3.4 Invoice Payment Flows

```
Billing Terms: immediate (charge_automatically)
  â†’ Invoice created â†’ Stripe charges default payment method immediately
  â†’ If payment fails â†’ invoice.payment_failed webhook
  â†’ Company sees "Failed" status on invoice, prompted to update card

Billing Terms: net_30/60/90 (send_invoice)
  â†’ Invoice created â†’ Stripe sends email to billing_email
  â†’ Email contains link to Stripe hosted invoice page
  â†’ Company can pay via hosted page (card, bank transfer, etc.)
  â†’ Invoice appears in company's billing dashboard as "Open"
  â†’ When paid â†’ invoice.payment_succeeded webhook â†’ status = "Paid"
  â†’ If overdue â†’ "Past Due" indicator on billing dashboard

Having a card on file is OPTIONAL for net_X terms but RECOMMENDED:
  â†’ If card on file: Stripe can auto-retry failed payments
  â†’ Without card: Company pays via hosted invoice link only
```

---

## 4. Backend Requirements

### 4.1 Company SetupIntent Endpoint (New)

**File:** `services/billing-service/src/v2/company-billing/service.ts`

Add method:

```typescript
async createSetupIntent(
    companyId: string,
    clerkUserId: string
): Promise<{ client_secret: string; customer_id: string }> {
    const access = await this.resolveAccessContext(clerkUserId);
    requireBillingAdmin(access);

    // Get or create billing profile
    let profile = await this.repository.getByCompanyId(companyId);
    if (!profile) {
        throw new Error('Billing profile not found. Set up billing details first.');
    }

    // Ensure Stripe customer exists
    profile = await this.ensureStripeCustomer(profile);

    // Create SetupIntent for payment method collection
    const setupIntent = await this.stripe.setupIntents.create({
        customer: profile.stripe_customer_id!,
        payment_method_types: ['card'],
        metadata: {
            company_id: companyId,
        },
    });

    return {
        client_secret: setupIntent.client_secret!,
        customer_id: profile.stripe_customer_id!,
    };
}
```

**Route:** `POST /api/v2/company-billing-profiles/:companyId/setup-intent`

### 4.2 Get Company Payment Method (New)

**File:** `services/billing-service/src/v2/company-billing/service.ts`

Add method:

```typescript
async getPaymentMethod(
    companyId: string,
    clerkUserId: string
): Promise<{ has_payment_method: boolean; default_payment_method: PaymentMethodDetails | null }> {
    const access = await this.resolveAccessContext(clerkUserId);
    requireBillingAdmin(access);

    const profile = await this.repository.getByCompanyId(companyId);
    if (!profile?.stripe_customer_id) {
        return { has_payment_method: false, default_payment_method: null };
    }

    const customer = await this.stripe.customers.retrieve(
        profile.stripe_customer_id,
        { expand: ['invoice_settings.default_payment_method'] }
    );

    if ((customer as any).deleted) {
        return { has_payment_method: false, default_payment_method: null };
    }

    const pm = (customer as Stripe.Customer).invoice_settings?.default_payment_method;
    if (!pm || typeof pm === 'string') {
        return { has_payment_method: false, default_payment_method: null };
    }

    const card = (pm as Stripe.PaymentMethod).card;
    if (!card) {
        return { has_payment_method: false, default_payment_method: null };
    }

    return {
        has_payment_method: true,
        default_payment_method: {
            id: (pm as Stripe.PaymentMethod).id,
            brand: card.brand,
            last4: card.last4,
            exp_month: card.exp_month,
            exp_year: card.exp_year,
        },
    };
}
```

**Route:** `GET /api/v2/company-billing-profiles/:companyId/payment-method`

### 4.3 Update Company Payment Method (New)

**File:** `services/billing-service/src/v2/company-billing/service.ts`

Add method:

```typescript
async updatePaymentMethod(
    companyId: string,
    paymentMethodId: string,
    clerkUserId: string
): Promise<{ success: boolean; payment_method: PaymentMethodDetails }> {
    const access = await this.resolveAccessContext(clerkUserId);
    requireBillingAdmin(access);

    const profile = await this.repository.getByCompanyId(companyId);
    if (!profile?.stripe_customer_id) {
        throw new Error('No Stripe customer found. Complete billing setup first.');
    }

    // Attach payment method to company's Stripe customer
    await this.stripe.paymentMethods.attach(paymentMethodId, {
        customer: profile.stripe_customer_id,
    });

    // Set as default for invoices
    await this.stripe.customers.update(profile.stripe_customer_id, {
        invoice_settings: {
            default_payment_method: paymentMethodId,
        },
    });

    // Save reference in our billing profile
    await this.repository.update(companyId, {
        stripe_default_payment_method_id: paymentMethodId,
    });

    // Fetch details to return
    const pm = await this.stripe.paymentMethods.retrieve(paymentMethodId);
    const card = pm.card!;

    return {
        success: true,
        payment_method: {
            id: pm.id,
            brand: card.brand,
            last4: card.last4,
            exp_month: card.exp_month,
            exp_year: card.exp_year,
        },
    };
}
```

**Route:** `POST /api/v2/company-billing-profiles/:companyId/payment-method`

### 4.4 Billing Readiness Check (New)

**File:** `services/billing-service/src/v2/company-billing/service.ts`

Add method:

```typescript
async getBillingReadiness(
    companyId: string,
    clerkUserId: string
): Promise<CompanyBillingReadiness> {
    const access = await this.resolveAccessContext(clerkUserId);
    requireBillingAdmin(access);

    const profile = await this.repository.getByCompanyId(companyId);

    const hasBillingProfile = !!profile;
    const hasBillingEmail = !!profile?.billing_email;
    const hasBillingTerms = !!profile?.billing_terms;
    const hasStripeCustomer = !!profile?.stripe_customer_id;
    const hasPaymentMethod = !!profile?.stripe_default_payment_method_id;
    const hasBillingContact = !!profile?.billing_contact_name;
    const hasBillingAddress = !!profile?.billing_address
        && Object.keys(profile.billing_address).length > 0;

    // Payment method is required for immediate billing,
    // recommended for net_X billing
    const requiresPaymentMethod = profile?.billing_terms === 'immediate';

    let status: 'not_started' | 'incomplete' | 'ready';
    if (!hasBillingProfile || !hasBillingEmail) {
        status = 'not_started';
    } else if (requiresPaymentMethod && !hasPaymentMethod) {
        status = 'incomplete';
    } else if (!hasStripeCustomer) {
        status = 'incomplete';
    } else {
        status = 'ready';
    }

    return {
        status,
        has_billing_profile: hasBillingProfile,
        has_billing_email: hasBillingEmail,
        has_billing_terms: hasBillingTerms,
        has_stripe_customer: hasStripeCustomer,
        has_payment_method: hasPaymentMethod,
        has_billing_contact: hasBillingContact,
        has_billing_address: hasBillingAddress,
        requires_payment_method: requiresPaymentMethod,
        billing_terms: profile?.billing_terms || null,
    };
}
```

**Route:** `GET /api/v2/company-billing-profiles/:companyId/billing-readiness`

### 4.5 New Types

**File:** `services/billing-service/src/v2/company-billing/types.ts`

Add:

```typescript
export interface PaymentMethodDetails {
    id: string;
    brand: string;
    last4: string;
    exp_month: number;
    exp_year: number;
}

export interface CompanyBillingReadiness {
    status: 'not_started' | 'incomplete' | 'ready';
    has_billing_profile: boolean;
    has_billing_email: boolean;
    has_billing_terms: boolean;
    has_stripe_customer: boolean;
    has_payment_method: boolean;
    has_billing_contact: boolean;
    has_billing_address: boolean;
    requires_payment_method: boolean;
    billing_terms: BillingTerms | null;
}
```

### 4.6 New Routes

**File:** `services/billing-service/src/v2/company-billing/routes.ts`

Add 4 routes:

```typescript
// Create SetupIntent for payment method collection
app.post(`${basePath}/:companyId/setup-intent`, async (request, reply) => {
    const { clerkUserId } = requireUserContext(request);
    const { companyId } = request.params as { companyId: string };
    const result = await service.createSetupIntent(companyId, clerkUserId);
    return reply.send({ data: result });
});

// Get current payment method
app.get(`${basePath}/:companyId/payment-method`, async (request, reply) => {
    const { clerkUserId } = requireUserContext(request);
    const { companyId } = request.params as { companyId: string };
    const result = await service.getPaymentMethod(companyId, clerkUserId);
    return reply.send({ data: result });
});

// Update payment method
app.post(`${basePath}/:companyId/payment-method`, async (request, reply) => {
    const { clerkUserId } = requireUserContext(request);
    const { companyId } = request.params as { companyId: string };
    const { payment_method_id } = request.body as { payment_method_id: string };
    const result = await service.updatePaymentMethod(companyId, payment_method_id, clerkUserId);
    return reply.send({ data: result });
});

// Get billing readiness
app.get(`${basePath}/:companyId/billing-readiness`, async (request, reply) => {
    const { clerkUserId } = requireUserContext(request);
    const { companyId } = request.params as { companyId: string };
    const result = await service.getBillingReadiness(companyId, clerkUserId);
    return reply.send({ data: result });
});
```

### 4.7 API Gateway Proxy Routes

**File:** `services/api-gateway/src/routes/v2/billing.ts`

Add proxy routes for the 4 new endpoints:
- `POST /api/v2/company-billing-profiles/:companyId/setup-intent`
- `GET /api/v2/company-billing-profiles/:companyId/payment-method`
- `POST /api/v2/company-billing-profiles/:companyId/payment-method`
- `GET /api/v2/company-billing-profiles/:companyId/billing-readiness`

### 4.8 Publish Billing Setup Event

**File:** `services/billing-service/src/v2/company-billing/service.ts`

In `updatePaymentMethod()`, after successfully saving the payment method, check if the billing profile is now complete and publish event:

```
Event: company.billing_profile_completed
Payload: { company_id, billing_terms, stripe_customer_id, has_payment_method: true }
```

This requires adding an `EventPublisher` dependency to `CompanyBillingProfileService` (currently it doesn't have one).

### 4.9 Notification Consumer

**File:** `services/notification-service/src/domain-consumer.ts`

Bind and handle:
- `company.billing_profile_completed` â†’ Send "Your company billing is set up" confirmation email to billing_email

---

## 5. Frontend Requirements

### 5.1 Hook: `useCompanyBillingStatus()`

**Create:** `apps/portal/src/hooks/use-company-billing-status.ts`

```typescript
interface CompanyBillingStatus {
    // Loading/Error
    loading: boolean;
    error: string | null;

    // Billing profile
    profile: CompanyBillingProfile | null;
    hasProfile: boolean;

    // Payment method (from Stripe)
    hasPaymentMethod: boolean;
    paymentMethod: PaymentMethodDetails | null;

    // Readiness
    readiness: CompanyBillingReadiness | null;
    status: 'not_started' | 'incomplete' | 'ready';

    // Actions
    refresh: () => Promise<void>;
}
```

**Behavior:**
- On mount: Fetch billing profile, payment method, and readiness in parallel
- Requires `companyId` parameter (from user's company context)
- `refresh()`: Re-fetch all data

### 5.2 Company Billing Dashboard

**Modify:** `apps/portal/src/app/portal/billing/components/billing-content.tsx`

Replace the company-user placeholder (lines 26-57) with a full billing dashboard. The dashboard should be a separate component for clean separation.

**Create:** `apps/portal/src/app/portal/billing/components/company-billing-content.tsx`

**Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Billing & Payments                                               â”‚
â”‚ Manage your company's billing profile, payment methods,          â”‚
â”‚ and placement invoices.                                          â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€ Billing Profile Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  Billing Email:     billing@acme.com                       â”‚  â”‚
â”‚ â”‚  Contact:           Jane Smith                              â”‚  â”‚
â”‚ â”‚  Payment Terms:     Net 30                                  â”‚  â”‚
â”‚ â”‚  Address:           123 Main St, NYC, NY 10001              â”‚  â”‚
â”‚ â”‚  Tax ID:            **-***1234                              â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  [Edit Billing Details]                                     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€ Payment Method Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  ğŸ’³ Visa â€¢â€¢â€¢â€¢ 4242          Expires 12/2027                â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  [Update Payment Method]                                    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€ Placement Invoices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  Date       Description                 Amount    Status    â”‚  â”‚
â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚ â”‚  Jan 15     Placement: J. Doe / Eng     $15,000   Paid     â”‚  â”‚
â”‚ â”‚  Feb 01     Placement: A. Smith / PM    $12,500   Open     â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚  [View Invoice â†—]  [Download PDF]                          â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**If billing not configured:** Show setup wizard instead (see 5.3).

### 5.3 Company Billing Setup Wizard

**Create:** `apps/portal/src/app/portal/billing/components/company-billing-setup-wizard.tsx`

Shown when company billing status is `not_started` or `incomplete`. Three-step wizard.

**Step 1: Billing Details**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set Up Company Billing                                           â”‚
â”‚                                                                   â”‚
â”‚ Step 1 of 3: Billing Details                                     â”‚
â”‚ â— Billing Details  â†’  â—‹ Payment Method  â†’  â—‹ Confirmation       â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Billing Email *         [billing@acme.com              ]   â”‚ â”‚
â”‚ â”‚  Billing Contact Name    [Jane Smith                    ]   â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  Street Address          [123 Main Street               ]   â”‚ â”‚
â”‚ â”‚  City                    [New York     ]                     â”‚ â”‚
â”‚ â”‚  State                   [NY ]  ZIP [10001]                  â”‚ â”‚
â”‚ â”‚  Country                 [United States          â–¼]          â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  Payment Terms *         [Net 30                 â–¼]          â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  Tax ID (EIN)            [12-3456789            ]            â”‚ â”‚
â”‚ â”‚  (optional)                                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚                                           [Cancel]  [Continue â†’] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2: Payment Method**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set Up Company Billing                                           â”‚
â”‚                                                                   â”‚
â”‚ Step 2 of 3: Payment Method                                      â”‚
â”‚ âœ“ Billing Details  â†’  â— Payment Method  â†’  â—‹ Confirmation       â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Your billing terms: Net 30                                  â”‚ â”‚
â”‚ â”‚  Invoices will be sent to: billing@acme.com                  â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  Add a payment method to ensure invoices are paid on time.   â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚  â”‚                                                      â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  Stripe PaymentElement (card input)                  â”‚   â”‚ â”‚
â”‚ â”‚  â”‚  (Stripe iframe â€” card data never touches            â”‚   â”‚ â”‚
â”‚ â”‚  â”‚   our servers)                                       â”‚   â”‚ â”‚
â”‚ â”‚  â”‚                                                      â”‚   â”‚ â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  ğŸ”’ Your card details are collected and stored securely      â”‚ â”‚
â”‚ â”‚  by Stripe. Splits Network never sees or stores your card    â”‚ â”‚
â”‚ â”‚  number.                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ [Skip for now]                             [â† Back]  [Save â†’]   â”‚
â”‚                                                                   â”‚
â”‚ Note: For "Immediate" billing terms, a payment method is         â”‚
â”‚ required. For Net 30/60/90, it's optional â€” invoices will        â”‚
â”‚ include a payment link.                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2 behavior:**
- If `billing_terms === 'immediate'`: Payment method is required, no "Skip" button
- If `billing_terms === 'net_30/60/90'`: Payment method is optional, "Skip for now" available
- Backend creates Stripe Customer (via `ensureStripeCustomer`) + SetupIntent
- Frontend uses existing `StripeProvider` + `PaymentForm` with the SetupIntent `client_secret`
- On success: calls `POST /company-billing-profiles/:companyId/payment-method` with the `payment_method_id`

**Step 3: Confirmation**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set Up Company Billing                                           â”‚
â”‚                                                                   â”‚
â”‚ Step 3 of 3: Confirmation                                        â”‚
â”‚ âœ“ Billing Details  â†’  âœ“ Payment Method  â†’  â— Confirmation       â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  âœ“ Billing is set up!                                        â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  Billing Email:     billing@acme.com                         â”‚ â”‚
â”‚ â”‚  Contact:           Jane Smith                               â”‚ â”‚
â”‚ â”‚  Payment Terms:     Net 30                                   â”‚ â”‚
â”‚ â”‚  Payment Method:    Visa â€¢â€¢â€¢â€¢ 4242                           â”‚ â”‚
â”‚ â”‚                                    (or "Skipped â€” pay via    â”‚ â”‚
â”‚ â”‚                                     invoice link")           â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚  How invoicing works:                                        â”‚ â”‚
â”‚ â”‚  â€¢ When a placement is confirmed, an invoice is generated    â”‚ â”‚
â”‚ â”‚  â€¢ Invoices are sent to your billing email                   â”‚ â”‚
â”‚ â”‚  â€¢ Payment is due within your billing terms (Net 30)         â”‚ â”‚
â”‚ â”‚  â€¢ You can view all invoices on this billing page            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚                                           [Go to Billing â†’]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 Company Payment Method Section

**Create:** `apps/portal/src/app/portal/billing/components/company-payment-method-section.tsx`

Reusable component for the billing dashboard and setup wizard. Follows the same pattern as the existing recruiter `PaymentMethodSection`.

**Props:**
```typescript
interface CompanyPaymentMethodSectionProps {
    companyId: string;
}
```

**Behavior:**
- On mount: `GET /company-billing-profiles/:companyId/payment-method`
- Shows card brand, last 4, expiration
- "Update" button â†’ creates SetupIntent, opens modal with `StripeProvider` + `PaymentForm`
- On payment success â†’ calls `POST /company-billing-profiles/:companyId/payment-method`
- Refreshes display

**Reuse:** The existing `StripeProvider` and `PaymentForm` components work identically for company payment method collection. The only difference is the backend endpoint used for SetupIntent creation and payment method save.

### 5.5 Company Invoice List

**Create:** `apps/portal/src/app/portal/billing/components/company-invoice-section.tsx`

**Props:**
```typescript
interface CompanyInvoiceSectionProps {
    companyId: string;
}
```

**Data source:** `GET /api/v2/company-billing-profiles/:companyId/invoices`

**Display:**

| Column | Content |
|--------|---------|
| Date | `created_at` formatted |
| Description | "Placement fee: [candidate name] / [job title]" (from placement reference) |
| Amount | `amount_due` formatted as currency |
| Status | Badge: Draft (gray), Open (blue), Paid (green), Void (gray), Failed (red) |
| Due Date | `due_date` formatted (only for `send_invoice` collection method) |
| Actions | "View Invoice" â†’ `hosted_invoice_url`, "PDF" â†’ `invoice_pdf_url` |

### 5.6 Billing Setup Prompt Banner

**Create:** `apps/portal/src/app/portal/billing/components/company-billing-prompt.tsx`

Dismissible banner shown on company dashboard and jobs list when billing is not configured.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Set up billing to enable placement invoicing for your hires.      â”‚
â”‚  [Set Up Billing â†’]                                          [âœ•]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Behavior:**
- Only shown when readiness status is `not_started` or `incomplete`
- Dismissible (localStorage with 7-day expiry)
- Links to `/portal/billing`

### 5.7 Expanded Company Settings Form

**Modify:** `apps/portal/src/app/portal/company/settings/components/settings-form.tsx`

Add missing billing profile fields to the existing Billing Terms card:

| Field | Type | Current Status |
|-------|------|----------------|
| `billing_email` | Email input (required) | Exists |
| `billing_terms` | Select dropdown | Exists |
| `billing_contact_name` | Text input | **Add** |
| `billing_address` | Address fields (street, city, state, zip, country) | **Add** |
| `stripe_tax_id` | Text input (EIN format) | **Add** |
| `invoice_delivery_method` | Select (email/none) | **Add** (currently hardcoded to `email`) |

These fields should save via the existing `POST /company-billing-profiles/:companyId` upsert endpoint. The body payload already supports all these fields â€” the form just doesn't send them.

---

## 6. Webhook & Real-Time Updates

### 6.1 Existing Invoice Webhooks (No Changes Needed)

All invoice lifecycle webhooks are already handled:

```
Stripe â†’ POST /api/v1/webhooks/stripe (billing-service)
  â†’ case 'invoice.payment_succeeded': handleInvoicePaid()
  â†’ case 'invoice.payment_failed': handleInvoiceFailed()
  â†’ case 'invoice.finalized': handleInvoiceFinalized()
  â†’ case 'invoice.marked_uncollectible': handleInvoiceMarkedUncollectible()
  â†’ case 'invoice.voided': handleInvoiceVoided()
```

These update the `placement_invoices` table with status, URLs, timestamps, and failure reasons.

### 6.2 Enhancement: Domain Events for Invoice Status Changes

Currently, the webhook handlers update the database but don't publish domain events. For the company billing dashboard to show real-time updates and for notification emails:

**In webhook handler, after DB update:**

```
invoice.payment_succeeded:
  Event: placement.invoice_paid
  Payload: { placement_id, company_id, amount_paid, invoice_id }

invoice.payment_failed:
  Event: placement.invoice_payment_failed
  Payload: { placement_id, company_id, failure_reason, invoice_id }
```

### 6.3 Frontend Status Refresh

After the company admin saves a payment method in the Stripe Elements modal:
1. `PaymentForm.onPaymentSuccess()` fires with `payment_method_id`
2. Frontend calls `POST /company-billing-profiles/:companyId/payment-method`
3. On success: refresh billing status via `useCompanyBillingStatus().refresh()`
4. Dashboard updates inline â€” no page reload needed

---

## 7. Error Handling & Edge Cases

### 7.1 No Billing Profile Yet

If `GET /company-billing-profiles/:companyId` returns null:
- Show billing setup wizard (Step 1 first)
- Don't allow payment method collection until billing details are saved

### 7.2 Stripe Customer Creation Failure

If `ensureStripeCustomer()` fails (Stripe API error):
- Show error: "Unable to set up payment processing. Please try again."
- Log to monitoring
- Don't proceed to SetupIntent creation

### 7.3 Payment Method Declined

If card is declined during SetupIntent confirmation:
- Stripe Elements shows the error message inline (handled by `PaymentForm`)
- User can try a different card
- No backend cleanup needed â€” SetupIntent remains valid for retry

### 7.4 Company Without Billing Profile Receives Placement

If a placement is created for a company without a billing profile:
- `PlacementInvoiceService.createForPlacement()` requires a billing profile
- Invoice creation fails gracefully â€” placement exists but invoice is not created
- Admin can set up billing profile manually and retry invoice creation

### 7.5 Multiple Users, Same Company

- All company billing operations are scoped to `companyId`, not individual user
- `billing_admin` role ensures only authorized users can manage billing
- Payment method changes affect the entire company â€” a single default payment method per company
- Last writer wins for billing profile updates

### 7.6 Card Expiration

When a card on file expires:
- Stripe automatically attempts to update card details if the issuer supports it
- If not updated: next `charge_automatically` invoice will fail
- `invoice.payment_failed` webhook fires â†’ our DB updates â†’ company sees "Failed" status
- Company can update payment method via the billing dashboard

### 7.7 Switching Billing Terms

If a company changes from `net_30` to `immediate`:
- Existing open invoices remain as `send_invoice`
- Future invoices use `charge_automatically`
- If no payment method on file: show "Payment method required" before allowing switch
- Company settings form should validate: if switching to `immediate`, check for payment method first

---

## 8. Security & Compliance

### 8.1 PII/PCI Handling

Payment card data is collected via Stripe Elements (`PaymentElement`). The `PaymentElement` renders as a Stripe-controlled iframe. Card numbers, CVVs, and expiration dates are entered into Stripe's iframe and sent directly from the browser to Stripe's servers.

| Data Type | Where Entered | Where Stored | Touches Our Servers? |
|-----------|--------------|--------------|---------------------|
| Card number | Stripe iframe | Stripe | No |
| CVV | Stripe iframe | Stripe | No |
| Expiration date | Stripe iframe | Stripe | No |
| Cardholder name | Stripe iframe | Stripe | No |
| Billing postal code | Stripe iframe | Stripe | No |

**What our servers DO handle:**
- `stripe_customer_id` (opaque ID: `cus_1234`)
- `stripe_default_payment_method_id` (opaque ID: `pm_1234`)
- SetupIntent `client_secret` (passed to frontend, short-lived)
- Billing email, contact name, address (entered in our form, not Stripe)
- `company_id` metadata on the Stripe customer

**Tax ID (EIN):** Stored in our `company_billing_profiles` table as `stripe_tax_id`. This is a business tax identifier, not PCI data. It can be stored directly.

### 8.2 SetupIntent Security

- SetupIntents are created server-side using our Stripe secret key
- `client_secret` is scoped to a specific customer
- Short-lived â€” must be confirmed promptly
- Only authenticated users with `billing_admin` role can create them for their company

### 8.3 Access Control

All company billing endpoints require:
1. Valid Clerk JWT (authentication)
2. `billing_admin` role (authorization via `requireBillingAdmin(access)`)

This ensures only authorized company administrators can:
- View billing profile
- Create/update billing profile
- Collect payment methods
- View invoices

### 8.4 Webhook Verification

Already implemented:
- `stripe.webhooks.constructEvent()` verifies webhook signature
- Rejects events that don't match our webhook secret

---

## 9. Files to Create or Modify

### New Files

| File | Type | Description |
|------|------|-------------|
| `apps/portal/src/app/portal/billing/components/company-billing-content.tsx` | Component | Full billing dashboard for company users |
| `apps/portal/src/app/portal/billing/components/company-billing-setup-wizard.tsx` | Component | 3-step guided billing setup flow |
| `apps/portal/src/app/portal/billing/components/company-payment-method-section.tsx` | Component | Payment method display + update via Stripe Elements |
| `apps/portal/src/app/portal/billing/components/company-invoice-section.tsx` | Component | Placement invoices list with status and links |
| `apps/portal/src/app/portal/billing/components/company-billing-prompt.tsx` | Component | Dashboard/jobs prompt banner for incomplete billing |
| `apps/portal/src/hooks/use-company-billing-status.ts` | Hook | Company billing profile + readiness state management |

### Modified Files

| File | Change |
|------|--------|
| `services/billing-service/src/v2/company-billing/service.ts` | Add `createSetupIntent()`, `getPaymentMethod()`, `updatePaymentMethod()`, `getBillingReadiness()` methods; add `EventPublisher` dependency |
| `services/billing-service/src/v2/company-billing/types.ts` | Add `PaymentMethodDetails`, `CompanyBillingReadiness` types |
| `services/billing-service/src/v2/company-billing/routes.ts` | Add 4 new routes (setup-intent, payment-method GET/POST, billing-readiness) |
| `services/api-gateway/src/routes/v2/billing.ts` | Proxy 4 new routes |
| `services/billing-service/src/v2/routes.ts` | Pass `EventPublisher` to `CompanyBillingProfileService` constructor |
| `services/billing-service/src/services/webhooks/service.ts` | Publish domain events on invoice status changes (optional enhancement) |
| `services/notification-service/src/domain-consumer.ts` | Bind and handle `company.billing_profile_completed` event |
| `apps/portal/src/app/portal/billing/components/billing-content.tsx` | Replace company-user placeholder with `CompanyBillingContent` |
| `apps/portal/src/app/portal/company/settings/components/settings-form.tsx` | Add billing_contact_name, billing_address, stripe_tax_id, invoice_delivery_method fields |

### Summary

| Category | New | Modified |
|----------|-----|----------|
| Frontend (Portal) | 6 files | 2 files |
| Backend (Billing Service) | 0 | 4 files |
| Backend (API Gateway) | 0 | 1 file |
| Backend (Notification Service) | 0 | 1 file |
| **Total** | **6 files** | **8 files** |

---

## Sources

- [Stripe SetupIntents](https://docs.stripe.com/payments/setup-intents)
- [Stripe Elements â€” PaymentElement](https://docs.stripe.com/payments/payment-element)
- [Stripe Invoicing](https://docs.stripe.com/invoicing)
- [Stripe Customer Management](https://docs.stripe.com/api/customers)
- [Stripe Billing â€” Collect Payment Details](https://docs.stripe.com/billing/subscriptions/build-subscriptions?platform=web&ui=elements#collect-payment)
