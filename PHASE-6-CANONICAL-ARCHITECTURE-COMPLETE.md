# Phase 6: Canonical Payout Architecture - COMPLETE âœ…

**Date Completed:** January 17, 2026  
**Implementation Status:** âœ… CODE COMPLETE | âœ… DATABASE COMPLETE | â³ TESTING PENDING

---

## Executive Summary

Phase 6 implementation aligned the billing service with the **canonical 4-layer payout architecture** as defined in `docs/originals/splits-network-payout-refactor-decision-guidance.md`. The implementation adds explicit role tracking to `placement_splits` and creates the transaction execution layer.

### Canonical Architecture (Fully Implemented)

```
1. placements             â†’ Hire event (facts)
2. placement_snapshot     â†’ Immutable attribution (5 role recruiter IDs + rates) - ALREADY EXISTS
3. placement_splits       â†’ Computed allocations with EXPLICIT ROLE COLUMN âœ… NEW
4. placement_payout_transactions â†’ Execution tracking (Stripe transfers) âœ… NEW
```

### Key Achievement

**Before:** placement_splits had no role tracking, making it impossible to distinguish which split belonged to which commission role.

**After:** placement_splits has explicit `role` column with CHECK constraint enforcing 5 valid values, enabling proper commission tracking and Stripe transfer management.

---

## Implementation Details

### Database Migrations âœ…

#### Migration 002/028: Add Role to Placement Splits

**File:** `services/billing-service/migrations/002_add_role_to_placement_splits.sql`

**Changes:**
- Added `role` column (TEXT NOT NULL DEFAULT 'candidate_recruiter')
- Added CHECK constraint: 5 valid roles (candidate_recruiter, company_recruiter, job_owner, candidate_sourcer, company_sourcer)
- Updated UNIQUE constraint: (placement_id, recruiter_id, role) - allows same recruiter in multiple roles
- Added indexes: idx_placement_splits_role, idx_placement_splits_placement_role

**Status:** âœ… Applied manually via Supabase MCP (initial MCP application had partial failure, completed via individual SQL commands)

**Verification:**
```sql
-- Confirmed via mcp_supabase_describe_table
SELECT * FROM placement_splits LIMIT 1;
-- role column present with CHECK constraint

-- Confirmed indexes
SELECT indexname FROM pg_indexes WHERE tablename = 'placement_splits';
-- idx_placement_splits_role âœ…
-- idx_placement_splits_placement_role âœ…
```

#### Migration 003/029: Create Placement Payout Transactions

**File:** `services/billing-service/migrations/003_create_placement_payout_transactions.sql`

**Changes:**
- Created `placement_payout_transactions` table
- 1-to-1 relationship with placement_splits (UNIQUE constraint on placement_split_id)
- Stripe integration fields: stripe_transfer_id, stripe_payout_id, stripe_connect_account_id
- Status workflow: pending â†’ processing â†’ completed/failed
- Amount tracking: amount (matches split_amount), stripe_fee, net_amount

**Status:** âœ… Applied successfully via Supabase MCP

**Verification:**
```sql
-- Confirmed via mcp_supabase_list_tables
\d placement_payout_transactions
-- Table exists with all columns âœ…
```

---

### Code Implementation âœ…

#### Repository Layer

**Created Files:**

1. **PlacementSplitRepository** (72 lines)
   - **File:** `services/billing-service/src/v2/payouts/placement-split-repository.ts`
   - **Methods:** listByPlacement, getById, create, update
   - **Features:** Direct Supabase queries, role-based filtering, enriched splits with payout data

2. **PlacementPayoutTransactionRepository** (115 lines)
   - **File:** `services/billing-service/src/v2/payouts/placement-payout-transaction-repository.ts`
   - **Methods:** listBySplit, listByStatus, getById, create, update, getStatistics
   - **Features:** Status workflow management, Stripe integration tracking, admin-only access

**Updated Files:**

3. **PayoutServiceV2** (refactored)
   - **File:** `services/billing-service/src/v2/payouts/service.ts`
   - **Added Method:** `createSplitsAndTransactionsForPlacement(placementId, snapshot)`
   - **Features:**
     - Processes placement_snapshot to create splits with explicit roles
     - Creates one placement_split per role with recruiter assigned
     - Creates one placement_payout_transaction per split (1-to-1)
     - Idempotent: returns existing splits if already created
     - Event publishing: 'placement.splits_created'

4. **Placement Consumer** (updated)
   - **File:** `services/billing-service/src/events/placement-consumer.ts`
   - **Updated Handler:** placement.created event now triggers snapshot + splits + transactions creation
   - **Flow:** placement.created â†’ create snapshot â†’ create splits + transactions â†’ publish event

5. **Route Wiring** (updated)
   - **File:** `services/billing-service/src/v2/routes.ts`
   - **Added:** PlacementSplitRepository and PlacementPayoutTransactionRepository instantiation
   - **Wired:** Repositories passed to PayoutServiceV2 constructor

---

### TypeScript Types âœ…

**Updated:** `packages/shared-types/src/supabase/database.types.ts` (manually regenerated by user)

**Confirmed Types:**
```typescript
placement_splits: {
  Row: {
    id: string;
    placement_id: string;
    recruiter_id: string;
    role: string;  // âœ… NEW FIELD
    split_percentage: number;
    split_amount: number;
    // ... other fields
  }
  Insert: {
    role?: string;  // Optional in insert, defaults to 'candidate_recruiter'
    // ... other fields
  }
}

placement_payout_transactions: {
  Row: {
    id: string;
    placement_split_id: string;  // UNIQUE, 1-to-1 with splits
    status: Database['public']['Enums']['payout_status'];
    amount: number;
    stripe_transfer_id: string | null;
    stripe_payout_id: string | null;
    stripe_connect_account_id: string | null;
    stripe_fee: number | null;
    net_amount: number | null;
    processing_started_at: string | null;
    completed_at: string | null;
    failed_at: string | null;
    failure_reason: string | null;
    // ... timestamps
  }
}
```

---

### Build Verification âœ…

**Command:** `pnpm build` (in services/billing-service)

**Result:** âœ… 0 TypeScript errors

**Files Compiled:**
- placement-split-repository.ts âœ…
- placement-payout-transaction-repository.ts âœ…
- service.ts (refactored) âœ…
- placement-consumer.ts (updated) âœ…
- routes.ts (updated wiring) âœ…

---

## Business Logic Flow

### Five-Role Commission Model

Every placement has up to **5 commission-earning roles** (all nullable):

1. **Candidate Recruiter** ("Closer") - Represents the candidate
2. **Job Owner** ("Specs Owner") - Created the job posting (recruiter only)
3. **Company Recruiter** ("Client/Hiring Facilitator") - Represents the company
4. **Company Sourcer** ("BD") - First brought company to platform
5. **Candidate Sourcer** ("Discovery") - First brought candidate to platform

### Placement Event Flow

```
1. placement.created event published (by ATS service)
   â†“
2. placement-consumer.ts receives event
   â†“
3. PayoutServiceV2.createSplitsAndTransactionsForPlacement()
   â†“
4. For each role with assigned recruiter:
   - Create placement_split with explicit role value
   - Create placement_payout_transaction (1-to-1)
   â†“
5. Publish 'placement.splits_created' event
   {
     placement_id,
     split_count: 3,
     transaction_count: 3,
     total_amount: 15000,
     roles_paid: ["candidate_recruiter", "company_recruiter", "job_owner"]
   }
```

### Example: 3-Role Placement (Paid Tier, $20k Fee)

**Input:** placement_snapshot
```json
{
  "placement_id": "abc123",
  "candidate_recruiter_id": "rec1",
  "company_recruiter_id": "rec2",
  "job_owner_recruiter_id": "rec3",
  "candidate_sourcer_recruiter_id": null,  // Not sourced
  "company_sourcer_recruiter_id": null,    // Not sourced
  "total_placement_fee": 20000,
  "subscription_tier": "paid"
}
```

**Output:** 3 placement_splits + 3 placement_payout_transactions

| role | recruiter_id | split_percentage | split_amount | transaction_status |
|------|--------------|------------------|--------------|-------------------|
| candidate_recruiter | rec1 | 30.00 | $6,000 | pending |
| company_recruiter | rec2 | 15.00 | $3,000 | pending |
| job_owner | rec3 | 15.00 | $3,000 | pending |

**Platform Remainder:** 24% + 8% + 8% (NULL roles) = $8,000

---

## Testing Plan â³ PENDING

### Integration Test: Placement Creation

**Goal:** Verify end-to-end flow from placement.created â†’ splits + transactions

**Test Case 1: All 5 Roles Assigned**
```typescript
// Setup
const placementId = await createTestPlacement({
  candidate_recruiter_id: 'rec1',
  company_recruiter_id: 'rec2',
  job_owner_recruiter_id: 'rec3',
  candidate_sourcer_recruiter_id: 'rec4',
  company_sourcer_recruiter_id: 'rec5',
  total_placement_fee: 20000,
  subscription_tier: 'premium'
});

// Trigger
await publishEvent('placement.created', { placementId });

// Verify
const splits = await querySplits(placementId);
expect(splits.length).toBe(5);
expect(splits.map(s => s.role)).toEqual([
  'candidate_recruiter',
  'company_recruiter', 
  'job_owner',
  'candidate_sourcer',
  'company_sourcer'
]);

const transactions = await queryTransactions(placementId);
expect(transactions.length).toBe(5);
expect(transactions.every(t => t.status === 'pending')).toBe(true);
```

**Test Case 2: Partial Roles (Direct Candidate)**
```typescript
// Setup: No candidate recruiter (direct application)
const placementId = await createTestPlacement({
  candidate_recruiter_id: null,  // â† Direct candidate
  company_recruiter_id: 'rec2',
  job_owner_recruiter_id: 'rec3',
  candidate_sourcer_recruiter_id: null,
  company_sourcer_recruiter_id: null,
  total_placement_fee: 20000,
  subscription_tier: 'paid'
});

// Verify: Only 2 splits created (company_recruiter + job_owner)
const splits = await querySplits(placementId);
expect(splits.length).toBe(2);
expect(splits.map(s => s.role)).toEqual([
  'company_recruiter',
  'job_owner'
]);
```

**Test Case 3: Idempotency**
```typescript
// Call twice
await service.createSplitsAndTransactionsForPlacement(placementId, snapshot);
const splits1 = await querySplits(placementId);

await service.createSplitsAndTransactionsForPlacement(placementId, snapshot);
const splits2 = await querySplits(placementId);

// Verify: Same splits returned, no duplicates created
expect(splits1).toEqual(splits2);
expect(splits1.length).toBe(3); // Not 6
```

---

### Unit Tests: Repository Methods

**PlacementSplitRepository:**
- âœ… `listByPlacement()` returns all splits for placement
- âœ… `create()` validates role value against CHECK constraint
- âœ… UNIQUE constraint prevents duplicate (placement_id, recruiter_id, role)

**PlacementPayoutTransactionRepository:**
- âœ… `create()` enforces 1-to-1 relationship with placement_split_id
- âœ… `update()` validates status transitions (pending â†’ processing â†’ completed)
- âœ… `listByStatus()` filters correctly (pending, processing, completed, failed)

---

## Documentation Updates

### Updated Files

1. **AGENTS.md** âœ… THIS FILE
   - Added Phase 6 canonical architecture completion notes
   - Documented placement_splits.role column
   - Documented placement_payout_transactions table

2. **PHASE-6-CANONICAL-ARCHITECTURE-COMPLETE.md** âœ… THIS FILE
   - Complete implementation summary
   - Testing plan
   - Next steps

### Files to Update â³ PENDING

3. **docs/plan-implementSourcerTablesCommissionStructure.prompt.md**
   - Mark placement_splits.role as implemented
   - Mark placement_payout_transactions as implemented
   - Update Phase 6 status to COMPLETE

4. **docs/originals/splits-network-payout-refactor-decision-guidance.md**
   - Add checkmarks to completed items:
     - [x] Ensure `placement_splits` contains split_amount for every allocation
     - [x] Create `payout_transactions` keyed to `placement_splits`
     - [x] Add explicit role tracking to placement_splits

---

## Known Issues & Limitations

### âš ï¸ Migration 028 Partial Application

**Issue:** Migration 028 reported success but role column was not created

**Root Cause:** Migration tracking entry (version 20260117194500) already existed in schema_migrations table, causing Supabase MCP to skip DDL execution

**Resolution:** Applied schema changes manually via individual SQL commands:
1. Added role column
2. Added CHECK constraint
3. Updated UNIQUE constraint
4. Added indexes

**Impact:** Schema is now correct and verified. Future migrations should check for existing version entries before applying.

**Prevention:** Consider using migration tool that checks actual schema state, not just tracking table.

---

## Next Steps

### Immediate Priority: Testing â³

1. **Integration Testing** (2-3 hours)
   - Write test to trigger placement.created event
   - Verify placement_snapshot created
   - Verify placement_splits created with role column populated
   - Verify placement_payout_transactions created (1-to-1)
   - Verify 'placement.splits_created' event published

2. **Edge Case Testing** (1-2 hours)
   - Test all-NULL roles (direct placement, no recruiters)
   - Test partial roles (missing candidate_recruiter, etc.)
   - Test idempotency (duplicate placement.created events)
   - Test constraint violations (invalid role value)

3. **Data Verification** (1 hour)
   - Run queries on production data (if any)
   - Verify split amounts match snapshot rates
   - Verify transaction amounts match split amounts
   - Verify 1-to-1 relationship maintained

### Optional: Cleanup ðŸŸ¢

4. **Update Documentation** (1 hour)
   - Mark tasks complete in plan-implementSourcerTablesCommissionStructure.prompt.md
   - Update guidance documents with Phase 6 completion
   - Add architecture diagrams showing 4-layer flow

5. **Remove placements.recruiter_id** (30 minutes)
   - Create migration to DROP COLUMN recruiter_id from placements
   - Update PlacementDTO in packages/shared-types/src/dtos.ts
   - **Reason:** Column no longer needed with placement_snapshot + placement_splits architecture

6. **Update Sourcer Tables** (30 minutes)
   - Rename `sourcer_recruiter_id` â†’ `recruiter_id` in sourcer tables (matches CRA pattern)
   - Update repository queries
   - Update TypeScript types

---

## Success Criteria

âœ… **Database Schema:**
- [x] placement_splits.role column exists with CHECK constraint
- [x] placement_payout_transactions table exists
- [x] UNIQUE constraint on (placement_id, recruiter_id, role)
- [x] 1-to-1 relationship constraint on placement_split_id

âœ… **Code Implementation:**
- [x] PlacementSplitRepository created
- [x] PlacementPayoutTransactionRepository created
- [x] PayoutServiceV2.createSplitsAndTransactionsForPlacement() implemented
- [x] placement-consumer.ts updated to trigger split creation
- [x] Event publishing for 'placement.splits_created'

âœ… **Build & Types:**
- [x] TypeScript builds without errors (0 errors)
- [x] Types regenerated with new schema
- [x] All imports resolve correctly

â³ **Testing:** (Next Priority)
- [ ] Integration test: placement.created â†’ splits + transactions
- [ ] Idempotency test: duplicate events handled
- [ ] Edge cases: NULL roles, partial roles
- [ ] 1-to-1 relationship verified

â³ **Documentation:**
- [x] PHASE-6-CANONICAL-ARCHITECTURE-COMPLETE.md created
- [x] AGENTS.md updated with completion notes
- [ ] plan-implementSourcerTablesCommissionStructure.prompt.md status updated
- [ ] Architecture documentation updated

---

## Appendix: Migration Scripts

### Migration 002: Add Role to Placement Splits

```sql
-- Migration 002: Add role column to placement_splits
-- Date: 2026-01-17
-- Purpose: Enable explicit role tracking for commission attribution

BEGIN;

-- Step 1: Add role column
ALTER TABLE placement_splits 
ADD COLUMN IF NOT EXISTS role TEXT NOT NULL DEFAULT 'candidate_recruiter';

-- Step 2: Add CHECK constraint (5 valid roles)
ALTER TABLE placement_splits 
ADD CONSTRAINT role_check CHECK (role IN (
    'candidate_recruiter', 
    'company_recruiter', 
    'job_owner', 
    'candidate_sourcer', 
    'company_sourcer'
));

-- Step 3: Drop old unique constraint (without role)
ALTER TABLE placement_splits 
DROP CONSTRAINT IF EXISTS placement_splits_placement_id_recruiter_id_key;

-- Step 4: Add new unique constraint (with role)
-- Allows same recruiter in multiple roles
ALTER TABLE placement_splits 
ADD CONSTRAINT unique_placement_recruiter_role 
UNIQUE (placement_id, recruiter_id, role);

-- Step 5: Add performance indexes
CREATE INDEX IF NOT EXISTS idx_placement_splits_role 
ON placement_splits(role);

CREATE INDEX IF NOT EXISTS idx_placement_splits_placement_role 
ON placement_splits(placement_id, role);

COMMIT;
```

### Migration 003: Create Placement Payout Transactions

```sql
-- Migration 003: Create placement_payout_transactions table
-- Date: 2026-01-17
-- Purpose: Track Stripe transfer execution for each placement split

BEGIN;

CREATE TABLE placement_payout_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Foreign key (1-to-1 with placement_splits)
    placement_split_id UUID NOT NULL UNIQUE REFERENCES placement_splits(id) ON DELETE CASCADE,
    
    -- Transaction status
    status payout_status NOT NULL DEFAULT 'pending',
    
    -- Amount tracking
    amount DECIMAL(10,2) NOT NULL CHECK (amount > 0),
    stripe_fee DECIMAL(10,2),
    net_amount DECIMAL(10,2),
    
    -- Stripe integration
    stripe_transfer_id TEXT,
    stripe_payout_id TEXT,
    stripe_connect_account_id TEXT,
    
    -- Workflow timestamps
    processing_started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    failed_at TIMESTAMPTZ,
    failure_reason TEXT,
    
    -- Audit
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_placement_payout_transactions_split 
ON placement_payout_transactions(placement_split_id);

CREATE INDEX idx_placement_payout_transactions_status 
ON placement_payout_transactions(status);

CREATE INDEX idx_placement_payout_transactions_stripe_transfer 
ON placement_payout_transactions(stripe_transfer_id);

COMMIT;
```

---

**Document Status:** âœ… AUTHORITATIVE RECORD  
**Last Updated:** January 17, 2026  
**Implementation Complete:** January 17, 2026
