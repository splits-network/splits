apiVersion: batch/v1
kind: CronJob
metadata:
  name: billing-service-payout-schedules
  namespace: splits-network
  labels:
    app: billing-service
    component: cron
    job-type: payout-schedules
spec:
  # Run daily at 2am UTC (cron format: minute hour day month weekday)
  schedule: "0 2 * * *"
  
  # Keep last 3 successful and 3 failed jobs for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  
  # Job template
  jobTemplate:
    metadata:
      labels:
        app: billing-service
        component: cron
        job-type: payout-schedules
    spec:
      # Give the job 10 minutes to complete
      activeDeadlineSeconds: 600
      
      # Don't retry failed jobs automatically
      backoffLimit: 0
      
      template:
        metadata:
          labels:
            app: billing-service
            component: cron
            job-type: payout-schedules
        spec:
          restartPolicy: Never
          
          containers:
          - name: payout-schedules-processor
            image: ghcr.io/splits-network/billing-service:latest
            imagePullPolicy: Always
            
            # Run the job script
            command: ["node"]
            args: ["dist/jobs/process-payout-schedules.js"]
            
            env:
            # Supabase configuration
            - name: SUPABASE_URL
              valueFrom:
                secretKeyRef:
                  name: supabase-config
                  key: url
            - name: SUPABASE_SERVICE_ROLE_KEY
              valueFrom:
                secretKeyRef:
                  name: supabase-config
                  key: service-role-key
            
            # RabbitMQ configuration
            - name: RABBITMQ_URL
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-config
                  key: url
            
            # Stripe configuration
            - name: STRIPE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: stripe-config
                  key: secret-key
            
            # Job configuration
            - name: NODE_ENV
              value: "production"
            - name: LOG_LEVEL
              value: "info"
            
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "500m"
